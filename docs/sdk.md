# TypeScript SDK

The CLI includes a TypeScript SDK (`src/sdk/`) that provides a typed client for the JSON-RPC protocol. It can be used independently of the Ink UI.

## Architecture

```
protocol.ts  ← Auto-generated types from Protocol.spec()
    ↓
client.ts    ← JSON-RPC transport (stdio read/write, request/response correlation)
    ↓
session.ts   ← High-level Session class (prompt, steer, abort, events)
```

## Protocol Types

`src/sdk/protocol.ts` is **auto-generated** from `Opal.RPC.Protocol.spec()` via:

```bash
mix run scripts/codegen_ts.exs
```

It contains TypeScript interfaces for all method params/results, event types, and the `AgentEvent` discriminated union. **Do not edit this file manually** — changes are overwritten by codegen.

## Client

`OpalClient` manages the JSON-RPC connection:

- Spawns the Elixir server as a child process (stdio)
- Correlates request IDs to pending promises
- Routes notifications to event handlers
- Transforms between camelCase (TypeScript) and snake_case (Elixir) at the wire boundary

```typescript
const client = new OpalClient({ cwd: "/path/to/project" });
const result = await client.request("session/start", { workingDir: "." });
client.onEvent((event: AgentEvent) => { ... });
```

## Session

`Session` wraps the client with a higher-level API:

```typescript
const session = await Session.start({ workingDir: "." });

// Prompt returns an async iterable of events
for await (const event of session.prompt("Fix the bug")) {
  if (event.type === "messageDelta") console.log(event.delta);
}

// Other operations
await session.prompt("Skip that file"); // queued if busy
await session.abort();
await session.compact();
const state = await session.getState();
const models = await session.listModels();
await session.setModel("claude-sonnet-4");
await session.setThinkingLevel("high");

// Settings
await session.getSettings();
await session.saveSettings({ default_model: "anthropic:claude-sonnet-4-5" });

// Auth
await session.authStatus();
await session.authLogin();
await session.authPoll(deviceCode, interval);
await session.authSetKey("anthropic", "sk-...");
```

The session exposes an `auth` field from the `session/start` response, containing the probe result (status, provider, providers list).

The Session also provides a typed event emitter:

```typescript
session.on("messageDelta", (delta) => { ... });
session.on("toolExecutionStart", (tool, callId, args, meta) => { ... });
session.on("agentEnd", (usage) => { ... });
```

## Codegen

The codegen script (`scripts/codegen_ts.exs`) reads `Protocol.spec()` and generates:

- Method param/result interfaces (e.g. `SessionStartParams`, `SessionStartResult`)
- Event interfaces (e.g. `MessageDeltaEvent`, `UsageUpdateEvent`)
- `AgentEvent` discriminated union
- `Methods` constant map

To verify types are in sync: `mix run scripts/codegen_ts.exs --check`

## Source

- `src/sdk/protocol.ts` — Auto-generated types (do not edit)
- `src/sdk/client.ts` — JSON-RPC transport
- `src/sdk/session.ts` — Session class and event emitter
- `src/sdk/index.ts` — Public API exports
- `scripts/codegen_ts.exs` — Type generator
- `lib/opal/rpc/protocol.ex` — Source of truth for all types
