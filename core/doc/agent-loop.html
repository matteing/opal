<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.40.1">
    <meta name="project" content="Opal v0.1.0">


    <title>Agent Loop — Opal v0.1.0</title>

    <link rel="stylesheet" href="dist/html-elixir-YJO4MOOW.css" />

    <script defer src="dist/sidebar_items-93C55D77.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-YU4BZFVS.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="https://github.com/scohen/opal" class="sidebar-projectName" translate="no">
Opal
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.1.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras="Pages"></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Opal</span>
            <div class="search-input-wrapper">
              <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
              <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
                <i class="ri-close-line ri-lg" title="Cancel search"></i>
              </button>
            </div>
          </label>
        </form>
        <div class="autocomplete">
        </div>
        <div class="engine-selector" data-multiple="false">
          <button type="button" class="engine-button" aria-label="Select search engine" aria-haspopup="true" aria-expanded="false">
            <i class="ri-search-2-line" aria-hidden="true"></i>
            <span class="engine-name">Default</span>
            <i class="ri-arrow-down-s-line" aria-hidden="true"></i>
          </button>
          <div class="engine-dropdown" hidden role="menu">

              <button type="button"
                      class="engine-option"
                      data-engine-url="search.html?q="
                      role="menuitemradio"
                      aria-checked="true">
                <span class="name">Default</span>
                <span class="help">In-browser search</span>
              </button>

          </div>
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>The Agent Loop</h1>

<a href="agent-loop.md" title="Copy Markdown (hold Ctrl/Cmd and click it to open as Markdown)" class="copy-markdown icon-action" rel="help">
  <i class="ri-markdown-line" aria-hidden="true"></i>
  <span class="sr-only">Copy Markdown</span>
</a>


      <a href="https://github.com/scohen/opal/blob/v0.1.0/../docs/agent-loop.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>This document explains how <a href="Opal.Agent.html"><code class="inline">Opal.Agent</code></a> implements the agentic loop pattern
on top of OTP's <a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a>, and how every phase of the loop maps to native
OTP concepts: casts, handle_info, selective receive, and supervised tasks.</p><hr class="thin"/><h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>An agent loop is a cycle: <strong>prompt → stream LLM → execute tools → repeat</strong>.
The loop runs until the LLM produces a text-only response with no tool calls.</p><p>In Opal, this cycle is expressed entirely through GenServer state transitions
and OTP message passing — no spawned loops, no recursive spawns, no custom
schedulers. The BEAM scheduler <em>is</em> the scheduler.</p><pre><code class="mermaid">stateDiagram-v2
    [*] --&gt; idle
    idle --&gt; running : prompt cast
    running --&gt; streaming : provider stream
    streaming --&gt; streaming : handle_info SSE chunks
    streaming --&gt; running : finalize response
    running --&gt; idle : no tool calls, agent_end
    running --&gt; running : tools, execute, run_turn

    note right of streaming : SSE chunks arrive\nvia handle_info
    note right of running : Tool execution blocks\nthen loops back</code></pre><hr class="thin"/><h2 id="state-machine" class="section-heading"><a href="#state-machine" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">State Machine</span></h2><p>The Agent has three states, tracked by the <code class="inline">status</code> field:</p><table><thead><tr><th style="text-align: left;">State</th><th style="text-align: left;">Meaning</th><th style="text-align: left;">Accepts prompts?</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">:idle</code></td><td style="text-align: left;">Waiting for user input</td><td style="text-align: left;">Yes</td></tr><tr><td style="text-align: left;"><code class="inline">:running</code></td><td style="text-align: left;">Processing (building messages, dispatching)</td><td style="text-align: left;">Via steering</td></tr><tr><td style="text-align: left;"><code class="inline">:streaming</code></td><td style="text-align: left;">Receiving SSE chunks from the LLM</td><td style="text-align: left;">Via steering</td></tr></tbody></table><p>State transitions are driven by OTP callbacks:</p><pre><code class="mermaid">stateDiagram-v2
    [*] --&gt; idle

    idle --&gt; running : prompt cast
    running --&gt; streaming : provider stream

    streaming --&gt; streaming : handle_info SSE chunks
    streaming --&gt; idle : finalize, no tool calls
    streaming --&gt; tool_execution : finalize, has tool calls

    tool_execution --&gt; running : steering check, run_turn

    state tool_execution {
        [*] --&gt; dispatched
        dispatched --&gt; results : async_stream_nolink
    }</code></pre><hr class="thin"/><h2 id="phase-1-receiving-the-prompt" class="section-heading"><a href="#phase-1-receiving-the-prompt" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 1: Receiving the Prompt</span></h2><pre><code class="makeup elixir" translate="no"><span class="kd">def</span><span class="w"> </span><span class="nf">handle_cast</span><span class="p" data-group-id="9873081082-1">(</span><span class="p" data-group-id="9873081082-2">{</span><span class="ss">:prompt</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p" data-group-id="9873081082-2">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9873081082-3">%</span><span class="nc" data-group-id="9873081082-3">State</span><span class="p" data-group-id="9873081082-3">{</span><span class="p" data-group-id="9873081082-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="9873081082-1">)</span><span class="w"> </span><span class="k" data-group-id="9873081082-4">do</span><span class="w">
  </span><span class="n">user_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Message</span><span class="o">.</span><span class="n">user</span><span class="p" data-group-id="9873081082-5">(</span><span class="n">text</span><span class="p" data-group-id="9873081082-5">)</span><span class="w">
  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">append_message</span><span class="p" data-group-id="9873081082-6">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">user_msg</span><span class="p" data-group-id="9873081082-6">)</span><span class="w">
  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9873081082-7">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="ss">:running</span><span class="p" data-group-id="9873081082-7">}</span><span class="w">
  </span><span class="n">broadcast</span><span class="p" data-group-id="9873081082-8">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9873081082-9">{</span><span class="ss">:agent_start</span><span class="p" data-group-id="9873081082-9">}</span><span class="p" data-group-id="9873081082-8">)</span><span class="w">
  </span><span class="n">run_turn</span><span class="p" data-group-id="9873081082-10">(</span><span class="n">state</span><span class="p" data-group-id="9873081082-10">)</span><span class="w">
</span><span class="k" data-group-id="9873081082-4">end</span></code></pre><p><strong>Why <code class="inline">cast</code> instead of <code class="inline">call</code>?</strong></p><p>A <code class="inline">call</code> would block the caller until the agent finishes — which could be
minutes if the LLM runs multiple tool-use turns. Using <code class="inline">cast</code>:</p><ul><li>The caller gets <code class="inline">:ok</code> immediately</li><li>The caller observes progress via <a href="Opal.Events.html"><code class="inline">Opal.Events</code></a> (pubsub)</li><li>The GenServer is free to process <code class="inline">handle_info</code> messages (SSE chunks)
without a caller hanging</li></ul><p><strong>OTP mapping:</strong> This is a standard GenServer <code class="inline">handle_cast</code>. The prompt is
appended to the conversation history, status transitions to <code class="inline">:running</code>, and
<code class="inline">run_turn/1</code> is called synchronously within the same callback — it returns
<code class="inline">{:noreply, state}</code> once the streaming response is set up.</p><hr class="thin"/><h2 id="phase-2-starting-the-llm-stream" class="section-heading"><a href="#phase-2-starting-the-llm-stream" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 2: Starting the LLM Stream</span></h2><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">run_turn</span><span class="p" data-group-id="2651564323-1">(</span><span class="p" data-group-id="2651564323-2">%</span><span class="nc" data-group-id="2651564323-2">State</span><span class="p" data-group-id="2651564323-2">{</span><span class="p" data-group-id="2651564323-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="2651564323-1">)</span><span class="w"> </span><span class="k" data-group-id="2651564323-3">do</span><span class="w">
  </span><span class="n">all_messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">build_messages</span><span class="p" data-group-id="2651564323-4">(</span><span class="n">state</span><span class="p" data-group-id="2651564323-4">)</span><span class="w">
  </span><span class="n">tools</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">active_tools</span><span class="p" data-group-id="2651564323-5">(</span><span class="n">state</span><span class="p" data-group-id="2651564323-5">)</span><span class="w">

  </span><span class="k">case</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">stream</span><span class="p" data-group-id="2651564323-6">(</span><span class="n">state</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">all_messages</span><span class="p">,</span><span class="w"> </span><span class="n">tools</span><span class="p" data-group-id="2651564323-6">)</span><span class="w"> </span><span class="k" data-group-id="2651564323-7">do</span><span class="w">
    </span><span class="p" data-group-id="2651564323-8">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">resp</span><span class="p" data-group-id="2651564323-8">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2651564323-9">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">streaming_resp</span><span class="p">:</span><span class="w"> </span><span class="n">resp</span><span class="p">,</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="ss">:streaming</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="2651564323-9">}</span><span class="w">
      </span><span class="p" data-group-id="2651564323-10">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="2651564323-10">}</span><span class="w">

    </span><span class="p" data-group-id="2651564323-11">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="2651564323-11">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">broadcast</span><span class="p" data-group-id="2651564323-12">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2651564323-13">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="2651564323-13">}</span><span class="p" data-group-id="2651564323-12">)</span><span class="w">
      </span><span class="p" data-group-id="2651564323-14">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2651564323-15">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="ss">:idle</span><span class="p" data-group-id="2651564323-15">}</span><span class="p" data-group-id="2651564323-14">}</span><span class="w">
  </span><span class="k" data-group-id="2651564323-7">end</span><span class="w">
</span><span class="k" data-group-id="2651564323-3">end</span></code></pre><p><code class="inline">run_turn/1</code> is always the last call in a <code class="inline">handle_cast</code> or at the end of tool
execution. It calls the configured <code class="inline">Provider.stream/4</code> which initiates an
async HTTP request via <a href="https://hexdocs.pm/req/0.5.17/Req.html"><code class="inline">Req</code></a>.</p><p><strong>How Req async streaming works with GenServer:</strong></p><ol><li><a href="https://hexdocs.pm/req/0.5.17/Req.html"><code class="inline">Req</code></a> opens an HTTP connection and returns a <code class="inline">%Req.Response{}</code> immediately</li><li>As SSE chunks arrive over the wire, <a href="https://hexdocs.pm/req/0.5.17/Req.html"><code class="inline">Req</code></a> sends them as regular Erlang
messages to the calling process (the Agent GenServer)</li><li>The Agent's <code class="inline">handle_info/2</code> receives these messages</li></ol><p>This is the key integration point: <strong>Req's async streaming maps directly to
GenServer's <code class="inline">handle_info</code></strong>. No polling, no separate receiver process, no
callbacks — just messages in the GenServer mailbox.</p><pre><code class="mermaid">flowchart LR
    LLM[&quot;LLM API&lt;br/&gt;&lt;i&gt;HTTP/SSE&lt;/i&gt;&quot;] --&gt; Req[&quot;Req&lt;br/&gt;&lt;i&gt;async&lt;/i&gt;&quot;]
    Req -- &quot;Erlang messages&lt;br/&gt;{ref, chunk}&quot; --&gt; Agent[&quot;Agent mailbox&lt;br/&gt;&lt;i&gt;handle_info&lt;/i&gt;&quot;]</code></pre><hr class="thin"/><h2 id="phase-3-processing-the-stream" class="section-heading"><a href="#phase-3-processing-the-stream" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 3: Processing the Stream</span></h2><pre><code class="makeup elixir" translate="no"><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="6891497425-1">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6891497425-2">%</span><span class="nc" data-group-id="6891497425-2">State</span><span class="p" data-group-id="6891497425-2">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="ss">:streaming</span><span class="p">,</span><span class="w"> </span><span class="ss">streaming_resp</span><span class="p">:</span><span class="w"> </span><span class="n">resp</span><span class="p" data-group-id="6891497425-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="6891497425-1">)</span><span class="w">
    </span><span class="ow">when</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="k" data-group-id="6891497425-3">do</span><span class="w">
  </span><span class="k">case</span><span class="w"> </span><span class="nc">Req</span><span class="o">.</span><span class="n">parse_message</span><span class="p" data-group-id="6891497425-4">(</span><span class="n">resp</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="6891497425-4">)</span><span class="w"> </span><span class="k" data-group-id="6891497425-5">do</span><span class="w">
    </span><span class="p" data-group-id="6891497425-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">chunks</span><span class="p" data-group-id="6891497425-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p" data-group-id="6891497425-7">(</span><span class="n">chunks</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="6891497425-8">fn</span><span class="w">
        </span><span class="p" data-group-id="6891497425-9">{</span><span class="ss">:data</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="6891497425-9">}</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">parse_sse_data</span><span class="p" data-group-id="6891497425-10">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="6891497425-10">)</span><span class="w">
        </span><span class="ss">:done</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">acc</span><span class="w">
        </span><span class="c">_other</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">acc</span><span class="w">
      </span><span class="k" data-group-id="6891497425-8">end</span><span class="p" data-group-id="6891497425-7">)</span><span class="w">

      </span><span class="k">if</span><span class="w"> </span><span class="ss">:done</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">chunks</span><span class="w"> </span><span class="k" data-group-id="6891497425-11">do</span><span class="w">
        </span><span class="n">finalize_response</span><span class="p" data-group-id="6891497425-12">(</span><span class="n">state</span><span class="p" data-group-id="6891497425-12">)</span><span class="w">
      </span><span class="k" data-group-id="6891497425-11">else</span><span class="w">
        </span><span class="p" data-group-id="6891497425-13">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="6891497425-13">}</span><span class="w">
      </span><span class="k" data-group-id="6891497425-11">end</span><span class="w">

    </span><span class="ss">:unknown</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="6891497425-14">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="6891497425-14">}</span><span class="w">
  </span><span class="k" data-group-id="6891497425-5">end</span><span class="w">
</span><span class="k" data-group-id="6891497425-3">end</span></code></pre><p>Each <code class="inline">handle_info</code> invocation processes one batch of SSE chunks. The Agent
pattern-matches on <code class="inline">status: :streaming</code> to ensure it only processes stream
data when actually streaming.</p><p><strong>SSE event types and how they update state:</strong></p><table><thead><tr><th style="text-align: left;">LLM Stream Event</th><th style="text-align: left;">State Mutation</th><th style="text-align: left;">Event Broadcast</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">text_start</code></td><td style="text-align: left;">(no state change)</td><td style="text-align: left;"><code class="inline">{:message_start}</code></td></tr><tr><td style="text-align: left;"><code class="inline">text_delta &quot;Hel&quot;</code></td><td style="text-align: left;"><code class="inline">current_text &lt;&gt; &quot;Hel&quot;</code></td><td style="text-align: left;"><code class="inline">{:message_delta, %{delta: &quot;Hel&quot;}}</code></td></tr><tr><td style="text-align: left;"><code class="inline">text_delta &quot;lo&quot;</code></td><td style="text-align: left;"><code class="inline">current_text &lt;&gt; &quot;lo&quot;</code></td><td style="text-align: left;"><code class="inline">{:message_delta, %{delta: &quot;lo&quot;}}</code></td></tr><tr><td style="text-align: left;"><code class="inline">text_done &quot;Hello&quot;</code></td><td style="text-align: left;"><code class="inline">current_text = &quot;Hello&quot;</code></td><td style="text-align: left;">(none)</td></tr><tr><td style="text-align: left;"><code class="inline">tool_call_start</code></td><td style="text-align: left;">append to <code class="inline">current_tool_calls</code></td><td style="text-align: left;">(none)</td></tr><tr><td style="text-align: left;"><code class="inline">tool_call_delta</code></td><td style="text-align: left;">append to <code class="inline">arguments_json</code></td><td style="text-align: left;">(none)</td></tr><tr><td style="text-align: left;"><code class="inline">tool_call_done</code></td><td style="text-align: left;">finalize tool call entry</td><td style="text-align: left;">(none)</td></tr><tr><td style="text-align: left;"><code class="inline">thinking_start</code></td><td style="text-align: left;">(no state change)</td><td style="text-align: left;"><code class="inline">{:thinking_start}</code></td></tr><tr><td style="text-align: left;"><code class="inline">thinking_delta</code></td><td style="text-align: left;">(no state change)</td><td style="text-align: left;"><code class="inline">{:thinking_delta, ...}</code></td></tr><tr><td style="text-align: left;"><code class="inline">response_done</code></td><td style="text-align: left;">(no state change)</td><td style="text-align: left;">(none)</td></tr><tr><td style="text-align: left;"><code class="inline">:done</code> (Req)</td><td style="text-align: left;">triggers <code class="inline">finalize_response</code></td><td style="text-align: left;">(see below)</td></tr></tbody></table><p><strong>OTP mapping:</strong> Every SSE chunk is a <code class="inline">handle_info</code> call. Between chunks, the
GenServer is free to process other messages — including <code class="inline">abort</code> casts. The
BEAM scheduler interleaves chunk processing with any other work the VM needs
to do.</p><h3 id="provider-abstraction" class="section-heading"><a href="#provider-abstraction" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Provider Abstraction</span></h3><p>The raw SSE JSON is never interpreted by the Agent directly. Instead:</p><ol><li><a href="https://hexdocs.pm/req/0.5.17/Req.html#parse_message/2"><code class="inline">Req.parse_message/2</code></a> extracts <code class="inline">{:data, iodata}</code> from the HTTP-level framing</li><li>The Agent calls <code class="inline">state.provider.parse_stream_event(json)</code> to get semantic events</li><li>The Agent dispatches on the semantic event type (<code class="inline">:text_delta</code>, <code class="inline">:tool_call_start</code>, etc.)</li></ol><p>This means the Agent loop is <strong>provider-agnostic</strong>. The same GenServer handles
Anthropic's Responses API, OpenAI's Chat Completions API, or any custom provider.
The <code class="inline">Provider</code> behaviour defines the translation layer:</p><pre><code class="mermaid">flowchart LR
    SSE[&quot;Raw SSE JSON&lt;br/&gt;&lt;i&gt;wire format&lt;/i&gt;&lt;br/&gt;&lt;br/&gt;Anthropic:&lt;br/&gt;content_block_delta&lt;br/&gt;&lt;br/&gt;OpenAI:&lt;br/&gt;choices[0].delta&quot;] --&gt; Provider[&quot;Provider behaviour&lt;br/&gt;&lt;br/&gt;parse_stream_event/1&lt;br/&gt;&lt;br/&gt;Returns:&lt;br/&gt;{:text_delta, &amp;quot;&amp;quot;}&quot;]
    Provider --&gt; Agent[&quot;Agent loop&lt;br/&gt;&lt;br/&gt;Handles:&lt;br/&gt;text_delta,&lt;br/&gt;tool_call_done,&lt;br/&gt;etc.&quot;]</code></pre><hr class="thin"/><h2 id="phase-4-finalizing-the-response" class="section-heading"><a href="#phase-4-finalizing-the-response" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 4: Finalizing the Response</span></h2><p>When <code class="inline">:done</code> arrives in the chunk list, <code class="inline">finalize_response/1</code> is called:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">finalize_response</span><span class="p" data-group-id="9976998338-1">(</span><span class="p" data-group-id="9976998338-2">%</span><span class="nc" data-group-id="9976998338-2">State</span><span class="p" data-group-id="9976998338-2">{</span><span class="p" data-group-id="9976998338-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="9976998338-1">)</span><span class="w"> </span><span class="k" data-group-id="9976998338-3">do</span><span class="w">
  </span><span class="n">tool_calls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">finalize_tool_calls</span><span class="p" data-group-id="9976998338-4">(</span><span class="n">state</span><span class="o">.</span><span class="n">current_tool_calls</span><span class="p" data-group-id="9976998338-4">)</span><span class="w">
  </span><span class="n">assistant_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Message</span><span class="o">.</span><span class="n">assistant</span><span class="p" data-group-id="9976998338-5">(</span><span class="n">state</span><span class="o">.</span><span class="n">current_text</span><span class="p">,</span><span class="w"> </span><span class="n">tool_calls</span><span class="p" data-group-id="9976998338-5">)</span><span class="w">
  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">append_message</span><span class="p" data-group-id="9976998338-6">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">assistant_msg</span><span class="p" data-group-id="9976998338-6">)</span><span class="w">

  </span><span class="k">if</span><span class="w"> </span><span class="n">tool_calls</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p" data-group-id="9976998338-7">[</span><span class="p" data-group-id="9976998338-7">]</span><span class="w"> </span><span class="k" data-group-id="9976998338-8">do</span><span class="w">
    </span><span class="n">broadcast</span><span class="p" data-group-id="9976998338-9">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9976998338-10">{</span><span class="ss">:turn_end</span><span class="p">,</span><span class="w"> </span><span class="n">assistant_msg</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9976998338-11">[</span><span class="p" data-group-id="9976998338-11">]</span><span class="p" data-group-id="9976998338-10">}</span><span class="p" data-group-id="9976998338-9">)</span><span class="w">
    </span><span class="n">execute_tool_calls</span><span class="p" data-group-id="9976998338-12">(</span><span class="n">tool_calls</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="9976998338-12">)</span><span class="w">
  </span><span class="k" data-group-id="9976998338-8">else</span><span class="w">
    </span><span class="n">broadcast</span><span class="p" data-group-id="9976998338-13">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9976998338-14">{</span><span class="ss">:agent_end</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">messages</span><span class="p" data-group-id="9976998338-14">}</span><span class="p" data-group-id="9976998338-13">)</span><span class="w">
    </span><span class="p" data-group-id="9976998338-15">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9976998338-16">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="ss">:idle</span><span class="p" data-group-id="9976998338-16">}</span><span class="p" data-group-id="9976998338-15">}</span><span class="w">
  </span><span class="k" data-group-id="9976998338-8">end</span><span class="w">
</span><span class="k" data-group-id="9976998338-3">end</span></code></pre><p>This is the branching point of the loop:</p><ul><li><p><strong>No tool calls</strong> → The agent is done. Broadcast <code class="inline">agent_end</code>, go <code class="inline">:idle</code>.
The GenServer sits in its mailbox waiting for the next <code class="inline">handle_cast</code>.</p></li><li><p><strong>Has tool calls</strong> → Execute them, then loop back to <code class="inline">run_turn</code>. The
GenServer stays in <code class="inline">:running</code> status.</p></li></ul><p><strong>OTP mapping:</strong> <code class="inline">finalize_response</code> is called from within <code class="inline">handle_info</code>.
It returns <code class="inline">{:noreply, state}</code> either directly (no tools) or through
<code class="inline">execute_tool_calls</code> → <code class="inline">run_turn</code> (tools). In both cases, the GenServer
callback contract is satisfied — the return value is always <code class="inline">{:noreply, state}</code>.</p><hr class="thin"/><h2 id="phase-5-concurrent-tool-execution" class="section-heading"><a href="#phase-5-concurrent-tool-execution" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 5: Concurrent Tool Execution</span></h2><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">execute_tool_calls</span><span class="p" data-group-id="3810778974-1">(</span><span class="n">tool_calls</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3810778974-2">%</span><span class="nc" data-group-id="3810778974-2">State</span><span class="p" data-group-id="3810778974-2">{</span><span class="p" data-group-id="3810778974-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="3810778974-1">)</span><span class="w"> </span><span class="k" data-group-id="3810778974-3">do</span><span class="w">
  </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3810778974-4">%{</span><span class="w">
    </span><span class="ss">working_dir</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span><span class="w">
    </span><span class="ss">session_id</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span><span class="w">
    </span><span class="ss">config</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="w">
    </span><span class="ss">agent_pid</span><span class="p">:</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="3810778974-5">(</span><span class="p" data-group-id="3810778974-5">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">agent_state</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="w">          </span><span class="c1"># ← snapshot, not a live reference</span><span class="w">
  </span><span class="p" data-group-id="3810778974-4">}</span><span class="w">

  </span><span class="n">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="3810778974-6">(</span><span class="n">tool_calls</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="3810778974-7">fn</span><span class="w"> </span><span class="n">tc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="3810778974-8">{</span><span class="n">tc</span><span class="p">,</span><span class="w"> </span><span class="n">find_tool_module</span><span class="p" data-group-id="3810778974-9">(</span><span class="n">tc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">active_tools</span><span class="p" data-group-id="3810778974-10">(</span><span class="n">state</span><span class="p" data-group-id="3810778974-10">)</span><span class="p" data-group-id="3810778974-9">)</span><span class="p" data-group-id="3810778974-8">}</span><span class="w">
  </span><span class="k" data-group-id="3810778974-7">end</span><span class="p" data-group-id="3810778974-6">)</span><span class="w">

  </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="nc">Task.Supervisor</span><span class="o">.</span><span class="n">async_stream_nolink</span><span class="p" data-group-id="3810778974-11">(</span><span class="w">
      </span><span class="n">state</span><span class="o">.</span><span class="n">tool_supervisor</span><span class="p">,</span><span class="w">       </span><span class="c1"># ← per-session supervisor</span><span class="w">
      </span><span class="n">tasks</span><span class="p">,</span><span class="w">
      </span><span class="k" data-group-id="3810778974-12">fn</span><span class="w"> </span><span class="p" data-group-id="3810778974-13">{</span><span class="n">tc</span><span class="p">,</span><span class="w"> </span><span class="n">tool_mod</span><span class="p" data-group-id="3810778974-13">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">...</span><span class="w"> </span><span class="k" data-group-id="3810778974-12">end</span><span class="p">,</span><span class="w">
      </span><span class="ss">ordered</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w">
      </span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="ss">:infinity</span><span class="w">
    </span><span class="p" data-group-id="3810778974-11">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">zip</span><span class="p" data-group-id="3810778974-14">(</span><span class="n">tasks</span><span class="p" data-group-id="3810778974-14">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="3810778974-15">(</span><span class="k" data-group-id="3810778974-16">fn</span><span class="w"> </span><span class="n">...</span><span class="w"> </span><span class="k" data-group-id="3810778974-16">end</span><span class="p" data-group-id="3810778974-15">)</span><span class="w">

  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">append_messages</span><span class="p" data-group-id="3810778974-17">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">tool_result_messages</span><span class="p" data-group-id="3810778974-17">)</span><span class="w">
  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_for_steering</span><span class="p" data-group-id="3810778974-18">(</span><span class="n">state</span><span class="p" data-group-id="3810778974-18">)</span><span class="w">
  </span><span class="n">run_turn</span><span class="p" data-group-id="3810778974-19">(</span><span class="n">state</span><span class="p" data-group-id="3810778974-19">)</span><span class="w">
</span><span class="k" data-group-id="3810778974-3">end</span></code></pre><p>This is the most OTP-integrated phase. Let's break down every decision:</p><h3 id="why-task-supervisor-async_stream_nolink" class="section-heading"><a href="#why-task-supervisor-async_stream_nolink" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Why <code class="inline">Task.Supervisor.async_stream_nolink</code>?</span></h3><p>This is an OTP primitive that provides exactly the semantics an agent loop
needs:</p><table><thead><tr><th style="text-align: left;">Property</th><th style="text-align: left;">What it means for agents</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Supervised</strong></td><td style="text-align: left;">Tasks run under a <a href="https://hexdocs.pm/elixir/Task.Supervisor.html"><code class="inline">Task.Supervisor</code></a>, not wild</td></tr><tr><td style="text-align: left;"><strong>Concurrent</strong></td><td style="text-align: left;">All tool calls execute in parallel automatically</td></tr><tr><td style="text-align: left;"><strong>Unlinked</strong></td><td style="text-align: left;">A crashing tool doesn't crash the Agent</td></tr><tr><td style="text-align: left;"><strong>Ordered</strong></td><td style="text-align: left;">Results arrive in input order</td></tr><tr><td style="text-align: left;"><strong>Streaming</strong></td><td style="text-align: left;">Results are consumed as they complete</td></tr><tr><td style="text-align: left;"><strong>Back-pressure</strong></td><td style="text-align: left;">The Agent blocks until all tools finish</td></tr></tbody></table><p>Compare with alternatives:</p><table><thead><tr><th style="text-align: left;">Alternative</th><th style="text-align: left;">Verdict</th><th style="text-align: left;">Why</th></tr></thead><tbody><tr><td style="text-align: left;"><a href="https://hexdocs.pm/elixir/Task.html#async/1"><code class="inline">Task.async/1</code></a></td><td style="text-align: left;">✗</td><td style="text-align: left;">Linked — crash propagates to Agent</td></tr><tr><td style="text-align: left;"><a href="https://hexdocs.pm/elixir/Task.html#async_stream/3"><code class="inline">Task.async_stream/3</code></a></td><td style="text-align: left;">✗</td><td style="text-align: left;">Linked</td></tr><tr><td style="text-align: left;"><a href="https://hexdocs.pm/elixir/Kernel.html#spawn/1"><code class="inline">spawn/1</code></a></td><td style="text-align: left;">✗</td><td style="text-align: left;">Unsupervised, no result collection</td></tr><tr><td style="text-align: left;">GenServer pool</td><td style="text-align: left;">✗</td><td style="text-align: left;">Over-engineered for ephemeral work</td></tr><tr><td style="text-align: left;"><code class="inline">async_stream_nolink</code></td><td style="text-align: left;">✓</td><td style="text-align: left;">Supervised, isolated, ordered</td></tr></tbody></table><h3 id="the-blocking-model" class="section-heading"><a href="#the-blocking-model" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">The Blocking Model</span></h3><p>While tool tasks run, the Agent GenServer is <strong>blocked</strong> inside
<code class="inline">Enum.zip(results, tasks)</code> — it cannot process <code class="inline">handle_info</code> or <code class="inline">handle_cast</code>.</p><p>This is intentional:</p><ol><li>The agent cannot stream a new LLM response while tools are running</li><li>Tool results must be collected before the next <code class="inline">run_turn</code></li><li>The conversation must stay consistent — no interleaved mutations</li></ol><p>But this blocking creates two constraints that require specific solutions:</p><h3 id="constraint-1-no-calling-back-to-the-agent" class="section-heading"><a href="#constraint-1-no-calling-back-to-the-agent" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Constraint 1: No Calling Back to the Agent</span></h3><p>Since the Agent is blocked, any <code class="inline">GenServer.call(agent_pid, ...)</code> from a tool
task would deadlock:</p><pre><code class="mermaid">sequenceDiagram
    participant Agent as Agent (blocked)
    participant Task as Tool Task

    Agent-&gt;&gt;Task: async_stream_nolink(...)
    Note over Agent: waiting for results...

    Task-&gt;&gt;Agent: GenServer.call(agent_pid, :get_state)
    Note over Task: blocks waiting for reply

    Note over Agent,Task: ╳ DEADLOCK (5s timeout)</code></pre><p><strong>Solution: State snapshot.</strong> Before dispatching tasks, the Agent captures
its entire state into the context map:</p><pre><code class="makeup elixir" translate="no"><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3299212130-1">%{</span><span class="ss">agent_state</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="3299212130-1">}</span></code></pre><p>Tools read from <code class="inline">context.agent_state</code> — a frozen snapshot — instead of
calling back to the live GenServer. The <code class="inline">SubAgent</code> tool uses
<code class="inline">spawn_from_state(context.agent_state, overrides)</code> instead of
<code class="inline">spawn(agent_pid, overrides)</code>.</p><h3 id="constraint-2-steering-messages" class="section-heading"><a href="#constraint-2-steering-messages" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Constraint 2: Steering Messages</span></h3><p>Users may want to inject guidance while tools are running (&quot;actually, skip
that file&quot;). Since the Agent is blocked, it can't process <code class="inline">handle_cast</code>
messages. But those messages still accumulate in the GenServer mailbox.</p><p><strong>Solution: Selective receive.</strong> After tool execution completes, the Agent
performs a zero-timeout selective receive on its own mailbox:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">check_for_steering</span><span class="p" data-group-id="9840245929-1">(</span><span class="p" data-group-id="9840245929-2">%</span><span class="nc" data-group-id="9840245929-2">State</span><span class="p" data-group-id="9840245929-2">{</span><span class="p" data-group-id="9840245929-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="9840245929-1">)</span><span class="w"> </span><span class="k" data-group-id="9840245929-3">do</span><span class="w">
  </span><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="9840245929-4">do</span><span class="w">
    </span><span class="p" data-group-id="9840245929-5">{</span><span class="ss">:&quot;$gen_cast&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9840245929-6">{</span><span class="ss">:steer</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p" data-group-id="9840245929-6">}</span><span class="p" data-group-id="9840245929-5">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">user_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Message</span><span class="o">.</span><span class="n">user</span><span class="p" data-group-id="9840245929-7">(</span><span class="n">text</span><span class="p" data-group-id="9840245929-7">)</span><span class="w">
      </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">append_message</span><span class="p" data-group-id="9840245929-8">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">user_msg</span><span class="p" data-group-id="9840245929-8">)</span><span class="w">
      </span><span class="n">check_for_steering</span><span class="p" data-group-id="9840245929-9">(</span><span class="n">state</span><span class="p" data-group-id="9840245929-9">)</span><span class="w">
  </span><span class="k" data-group-id="9840245929-4">after</span><span class="w">
    </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">state</span><span class="w">
  </span><span class="k" data-group-id="9840245929-4">end</span><span class="w">
</span><span class="k" data-group-id="9840245929-3">end</span></code></pre><p>This reaches directly into the GenServer's internal message format
(<code class="inline">:&quot;$gen_cast&quot;</code>) to extract steering messages that arrived during tool
execution. The <code class="inline">after 0</code> clause ensures it never blocks — if no steering
messages are waiting, it returns immediately.</p><pre><code class="mermaid">sequenceDiagram
    participant User
    participant Agent
    participant Tasks as Tool Tasks

    User-&gt;&gt;Agent: cast(:prompt)
    Agent-&gt;&gt;Tasks: async_stream_nolink(...)
    Note over Agent: blocked waiting for results

    User-&gt;&gt;Agent: cast(:steer, &quot;skip that file&quot;)
    Note over Agent: steer message queued in mailbox

    Tasks--&gt;&gt;Agent: results collected
    Note over Agent: check_for_steering drains mailbox
    Note over Agent: steer message appended to msgs
    Agent-&gt;&gt;Agent: run_turn (with steering)</code></pre><p><strong>OTP mapping:</strong> This is a standard Erlang selective receive. OTP GenServers
process messages in order via <code class="inline">handle_*</code> callbacks, but within a callback
implementation, you can use <code class="inline">receive</code> to selectively pull specific messages
from the mailbox. The BEAM's per-process mailbox makes this a zero-cost
operation.</p><hr class="thin"/><h2 id="the-full-cycle" class="section-heading"><a href="#the-full-cycle" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">The Full Cycle</span></h2><p>Putting it all together, here's one complete agentic turn:</p><pre><code class="mermaid">sequenceDiagram
    participant User
    participant Agent
    participant BEAM as BEAM Scheduler
    participant Provider as Provider/LLM
    participant TaskSup as Task.Supervisor

    User-&gt;&gt;Agent: prompt &quot;Fix the bug&quot;
    Note over Agent: Append user message, idle to running

    Agent-&gt;&gt;Provider: provider.stream
    Provider--&gt;&gt;Agent: {:ok, resp}
    Note over Agent: running to streaming
    Note over BEAM: GenServer yields to scheduler

    Provider--&gt;&gt;Agent: handle_info chunk_1
    Note over Agent: text_delta, broadcast message_delta

    Provider--&gt;&gt;Agent: handle_info chunk_2
    Note over Agent: text_delta, broadcast message_delta

    Provider--&gt;&gt;Agent: handle_info chunk_N with done
    Note over Agent: tool_call_done, finalize_response

    Note over Agent: streaming to running, broadcast turn_end

    Agent-&gt;&gt;TaskSup: async_stream_nolink edit_call
    Note over Agent: blocked waiting for results
    TaskSup--&gt;&gt;Agent: results collected

    Note over Agent: Append tool_result, check_for_steering

    Agent-&gt;&gt;Provider: provider.stream next turn
    Provider--&gt;&gt;Agent: stream text only, done

    Note over Agent: No tool calls, broadcast agent_end, idle

    Agent--&gt;&gt;User: GenServer idle, waiting for next cast</code></pre><hr class="thin"/><h2 id="session-integration" class="section-heading"><a href="#session-integration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Session Integration</span></h2><p>When an <a href="Opal.Session.html"><code class="inline">Opal.Session</code></a> process is attached, every message append is mirrored
to it:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">append_message</span><span class="p" data-group-id="3759714065-1">(</span><span class="p" data-group-id="3759714065-2">%</span><span class="nc" data-group-id="3759714065-2">State</span><span class="p" data-group-id="3759714065-2">{</span><span class="ss">session</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="3759714065-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p" data-group-id="3759714065-1">)</span><span class="w"> </span><span class="k" data-group-id="3759714065-3">do</span><span class="w">
  </span><span class="p" data-group-id="3759714065-4">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">messages</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">messages</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="3759714065-5">[</span><span class="n">msg</span><span class="p" data-group-id="3759714065-5">]</span><span class="p" data-group-id="3759714065-4">}</span><span class="w">
</span><span class="k" data-group-id="3759714065-3">end</span><span class="w">

</span><span class="kd">defp</span><span class="w"> </span><span class="nf">append_message</span><span class="p" data-group-id="3759714065-6">(</span><span class="p" data-group-id="3759714065-7">%</span><span class="nc" data-group-id="3759714065-7">State</span><span class="p" data-group-id="3759714065-7">{</span><span class="ss">session</span><span class="p">:</span><span class="w"> </span><span class="n">session</span><span class="p" data-group-id="3759714065-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p" data-group-id="3759714065-6">)</span><span class="w"> </span><span class="k" data-group-id="3759714065-8">do</span><span class="w">
  </span><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">append</span><span class="p" data-group-id="3759714065-9">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p" data-group-id="3759714065-9">)</span><span class="w">        </span><span class="c1"># ← GenServer.call to Session</span><span class="w">
  </span><span class="p" data-group-id="3759714065-10">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">messages</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">messages</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="3759714065-11">[</span><span class="n">msg</span><span class="p" data-group-id="3759714065-11">]</span><span class="p" data-group-id="3759714065-10">}</span><span class="w">
</span><span class="k" data-group-id="3759714065-8">end</span></code></pre><p>The Agent maintains its own flat <code class="inline">messages</code> list for LLM context building
(fast, in-process), while the Session maintains a tree structure in ETS for
branching, persistence, and history. Both are always in sync.</p><pre><code class="mermaid">graph TD
    subgraph agent[&quot;Agent state.messages (flat list for LLM)&quot;]
        AM[&quot;[user, assistant, tool_result, assistant]&quot;]
    end

    subgraph session[&quot;Session ETS table (tree for persistence)&quot;]
        M1[&quot;msg_1 (user)&quot;]
        M2[&quot;msg_2 (assistant)&quot;]
        M3[&quot;msg_3 (tool_result)&quot;]
        M4[&quot;msg_4 (assistant)&quot;]
        M5[&quot;msg_5 (branch!)&quot;]
        M1 --&gt; M2
        M2 --&gt; M3
        M3 --&gt; M4
        M3 --&gt; M5
    end</code></pre><p>The Session is a sibling process under the same <code class="inline">SessionServer</code> supervisor.
If the Session crashes, the <code class="inline">:rest_for_one</code> strategy restarts the Agent too
(since it was started after the Session), ensuring they stay in sync.</p><hr class="thin"/><h2 id="message-types" class="section-heading"><a href="#message-types" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Message Types</span></h2><p>The conversation uses four message roles that form a protocol between the
Agent, the LLM, and the tools:</p><pre><code class="mermaid">sequenceDiagram
    participant User
    participant Agent
    participant LLM
    participant Tools

    User-&gt;&gt;Agent: :user &quot;Fix bug&quot;
    Agent-&gt;&gt;LLM: system + messages
    LLM--&gt;&gt;Agent: :assistant &quot;I'll fix&quot; + tool_calls [edit]
    Agent-&gt;&gt;Tools: execute(args, ctx)
    Tools--&gt;&gt;Agent: {:ok, &quot;Done&quot;}
    Agent-&gt;&gt;LLM: :tool_result &quot;Done&quot;
    LLM--&gt;&gt;Agent: :assistant &quot;Fixed!&quot;
    Agent--&gt;&gt;User: {:agent_end, msgs}</code></pre><p>Each message is an <a href="Opal.Message.html"><code class="inline">Opal.Message</code></a> struct with a unique <code class="inline">id</code> and optional
<code class="inline">parent_id</code> (used by Session for tree construction). The <code class="inline">call_id</code> field
links <code class="inline">:tool_call</code> entries in an assistant message to their corresponding
<code class="inline">:tool_result</code> messages — the LLM API requires this correlation.</p><hr class="thin"/><h2 id="auto-save-title-generation" class="section-heading"><a href="#auto-save-title-generation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Auto-Save &amp; Title Generation</span></h2><p>When the agent goes idle and a Session is attached, two optional background
tasks fire:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">maybe_auto_save</span><span class="p" data-group-id="8640110938-1">(</span><span class="p" data-group-id="8640110938-2">%</span><span class="nc" data-group-id="8640110938-2">State</span><span class="p" data-group-id="8640110938-2">{</span><span class="ss">session</span><span class="p">:</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="ss">config</span><span class="p">:</span><span class="w"> </span><span class="n">config</span><span class="p" data-group-id="8640110938-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8640110938-1">)</span><span class="w"> </span><span class="k" data-group-id="8640110938-3">do</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="n">config</span><span class="o">.</span><span class="n">auto_save</span><span class="w"> </span><span class="k" data-group-id="8640110938-4">do</span><span class="w">
    </span><span class="n">maybe_generate_title</span><span class="p" data-group-id="8640110938-5">(</span><span class="n">state</span><span class="p" data-group-id="8640110938-5">)</span><span class="w">
    </span><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">save</span><span class="p" data-group-id="8640110938-6">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p" data-group-id="8640110938-6">)</span><span class="w">
  </span><span class="k" data-group-id="8640110938-4">end</span><span class="w">
</span><span class="k" data-group-id="8640110938-3">end</span></code></pre><p>Title generation is a fire-and-forget task started under the session's
<a href="https://hexdocs.pm/elixir/Task.Supervisor.html"><code class="inline">Task.Supervisor</code></a>:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Task.Supervisor</span><span class="o">.</span><span class="n">start_child</span><span class="p" data-group-id="0588994850-1">(</span><span class="n">state</span><span class="o">.</span><span class="n">tool_supervisor</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="0588994850-2">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">generate_session_title</span><span class="p" data-group-id="0588994850-3">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">first_user_msg</span><span class="o">.</span><span class="n">content</span><span class="p" data-group-id="0588994850-3">)</span><span class="w">
</span><span class="k" data-group-id="0588994850-2">end</span><span class="p" data-group-id="0588994850-1">)</span></code></pre><p>This makes a separate LLM call to generate a concise title. It runs as a
supervised task — if it fails, nothing else is affected. The title is written
to Session metadata via <code class="inline">Session.set_metadata(session, :title, clean)</code>.</p><p><strong>OTP mapping:</strong> <code class="inline">Task.Supervisor.start_child</code> starts a fire-and-forget task
(unlike <code class="inline">async</code> which expects the caller to await). The task runs under the
same per-session supervisor, so it's cleaned up if the session is terminated.</p><hr class="thin"/><h2 id="tool-behaviour" class="section-heading"><a href="#tool-behaviour" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Tool Behaviour</span></h2><p>Tools are modules implementing the <a href="Opal.Tool.html"><code class="inline">Opal.Tool</code></a> behaviour:</p><pre><code class="makeup elixir" translate="no"><span class="na">@callback</span><span class="w"> </span><span class="n">name</span><span class="p" data-group-id="3334620329-1">(</span><span class="p" data-group-id="3334620329-1">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="3334620329-2">(</span><span class="p" data-group-id="3334620329-2">)</span><span class="w">
</span><span class="na">@callback</span><span class="w"> </span><span class="n">description</span><span class="p" data-group-id="3334620329-3">(</span><span class="p" data-group-id="3334620329-3">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="3334620329-4">(</span><span class="p" data-group-id="3334620329-4">)</span><span class="w">
</span><span class="na">@callback</span><span class="w"> </span><span class="n">parameters</span><span class="p" data-group-id="3334620329-5">(</span><span class="p" data-group-id="3334620329-5">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">map</span><span class="p" data-group-id="3334620329-6">(</span><span class="p" data-group-id="3334620329-6">)</span><span class="w">         </span><span class="c1"># JSON Schema</span><span class="w">
</span><span class="na">@callback</span><span class="w"> </span><span class="n">execute</span><span class="p" data-group-id="3334620329-7">(</span><span class="n">args</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">map</span><span class="p" data-group-id="3334620329-8">(</span><span class="p" data-group-id="3334620329-8">)</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">map</span><span class="p" data-group-id="3334620329-9">(</span><span class="p" data-group-id="3334620329-9">)</span><span class="p" data-group-id="3334620329-7">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="3334620329-10">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="3334620329-11">(</span><span class="p" data-group-id="3334620329-11">)</span><span class="p" data-group-id="3334620329-10">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="3334620329-12">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="3334620329-13">(</span><span class="p" data-group-id="3334620329-13">)</span><span class="p" data-group-id="3334620329-12">}</span></code></pre><p>The Agent converts tool modules to JSON Schema for the LLM via
<code class="inline">Provider.convert_tools/1</code>. When the LLM requests a tool call, the Agent
looks up the module by name and calls <code class="inline">execute/2</code> inside a supervised task.</p><p><strong>Context map passed to every tool:</strong></p><table><thead><tr><th style="text-align: left;">Key</th><th style="text-align: left;">Type</th><th style="text-align: left;">Purpose</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">working_dir</code></td><td style="text-align: left;"><code class="inline">String.t()</code></td><td style="text-align: left;">Base directory for file operations</td></tr><tr><td style="text-align: left;"><code class="inline">session_id</code></td><td style="text-align: left;"><code class="inline">String.t()</code></td><td style="text-align: left;">For event broadcasting</td></tr><tr><td style="text-align: left;"><code class="inline">config</code></td><td style="text-align: left;"><code class="inline">Opal.Config.t()</code></td><td style="text-align: left;">Runtime configuration</td></tr><tr><td style="text-align: left;"><code class="inline">agent_pid</code></td><td style="text-align: left;"><code class="inline">pid()</code></td><td style="text-align: left;">Reference only — do not call!</td></tr><tr><td style="text-align: left;"><code class="inline">agent_state</code></td><td style="text-align: left;"><code class="inline">State.t()</code></td><td style="text-align: left;">Frozen snapshot of agent state</td></tr></tbody></table><p>The <code class="inline">agent_state</code> snapshot is the key to avoiding deadlocks. Tools can read
any agent state they need without calling back to the blocked GenServer.</p><hr class="thin"/><h2 id="error-handling" class="section-heading"><a href="#error-handling" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Error Handling</span></h2><p>The Agent handles errors at every phase without crashing:</p><h3 id="stream-errors" class="section-heading"><a href="#stream-errors" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stream errors</span></h3><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_stream_event</span><span class="p" data-group-id="3431672514-1">(</span><span class="p" data-group-id="3431672514-2">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="3431672514-2">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="3431672514-1">)</span><span class="w"> </span><span class="k" data-group-id="3431672514-3">do</span><span class="w">
  </span><span class="n">broadcast</span><span class="p" data-group-id="3431672514-4">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3431672514-5">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="3431672514-5">}</span><span class="p" data-group-id="3431672514-4">)</span><span class="w">
  </span><span class="p" data-group-id="3431672514-6">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="ss">:idle</span><span class="p">,</span><span class="w"> </span><span class="ss">streaming_resp</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="3431672514-6">}</span><span class="w">
</span><span class="k" data-group-id="3431672514-3">end</span></code></pre><p>A stream error (rate limit, network failure) resets the agent to <code class="inline">:idle</code>.
Subscribers see <code class="inline">{:error, reason}</code> and can retry.</p><h3 id="tool-crashes" class="section-heading"><a href="#tool-crashes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Tool crashes</span></h3><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="5073096173-1">{</span><span class="p" data-group-id="5073096173-2">{</span><span class="ss">:exit</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="5073096173-2">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5073096173-3">{</span><span class="n">tc</span><span class="p">,</span><span class="w"> </span><span class="c">_tool_mod</span><span class="p" data-group-id="5073096173-3">}</span><span class="p" data-group-id="5073096173-1">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="p" data-group-id="5073096173-4">{</span><span class="n">tc</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5073096173-5">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Tool execution crashed: </span><span class="si" data-group-id="5073096173-6">#{</span><span class="n">inspect</span><span class="p" data-group-id="5073096173-7">(</span><span class="n">reason</span><span class="p" data-group-id="5073096173-7">)</span><span class="si" data-group-id="5073096173-6">}</span><span class="s">&quot;</span><span class="p" data-group-id="5073096173-5">}</span><span class="p" data-group-id="5073096173-4">}</span></code></pre><p>A crashing tool produces an error <code class="inline">tool_result</code> message. The LLM sees the
error and can decide how to proceed — retry, use a different tool, or explain
the failure to the user.</p><h3 id="tool-exceptions" class="section-heading"><a href="#tool-exceptions" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Tool exceptions</span></h3><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">execute_single_tool</span><span class="p" data-group-id="7740806011-1">(</span><span class="n">tool_mod</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p" data-group-id="7740806011-1">)</span><span class="w"> </span><span class="k" data-group-id="7740806011-2">do</span><span class="w">
  </span><span class="n">tool_mod</span><span class="o">.</span><span class="n">execute</span><span class="p" data-group-id="7740806011-3">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p" data-group-id="7740806011-3">)</span><span class="w">
</span><span class="k" data-group-id="7740806011-2">rescue</span><span class="w">
  </span><span class="n">e</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="7740806011-4">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Tool raised an exception: </span><span class="si" data-group-id="7740806011-5">#{</span><span class="nc">Exception</span><span class="o">.</span><span class="n">message</span><span class="p" data-group-id="7740806011-6">(</span><span class="n">e</span><span class="p" data-group-id="7740806011-6">)</span><span class="si" data-group-id="7740806011-5">}</span><span class="s">&quot;</span><span class="p" data-group-id="7740806011-4">}</span><span class="w">
</span><span class="k" data-group-id="7740806011-2">end</span></code></pre><p>Even if a tool raises (instead of crashing), the rescue converts it to an
error tuple. The tool task completes normally, and the Agent continues.</p><h3 id="missing-tools" class="section-heading"><a href="#missing-tools" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Missing tools</span></h3><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">execute_single_tool</span><span class="p" data-group-id="5828830416-1">(</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="c">_args</span><span class="p">,</span><span class="w"> </span><span class="c">_context</span><span class="p" data-group-id="5828830416-1">)</span><span class="w"> </span><span class="k" data-group-id="5828830416-2">do</span><span class="w">
  </span><span class="p" data-group-id="5828830416-3">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Tool not found&quot;</span><span class="p" data-group-id="5828830416-3">}</span><span class="w">
</span><span class="k" data-group-id="5828830416-2">end</span></code></pre><p>If the LLM hallucinated a tool name, the Agent returns an error result. The
LLM learns the tool doesn't exist and adjusts.</p><p><strong>Design principle:</strong> The Agent never crashes due to tool-layer failures.
Every error is converted to a message the LLM can reason about. The
supervision tree is the safety net for truly unexpected failures.</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="architecture.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Architecture
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="rpc-research.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
RPC Research
        </span>
      </a>

  </div>
</div>
    <footer class="footer">

        <p>

            <span class="line">
              <a href="https://hex.pm/packages/opal/0.1.0">Hex Package</a>

              <a href="https://preview.hex.pm/preview/opal/0.1.0">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/opal/0.1.0/show/../docs/agent-loop.md">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Go to package docs">
              Go to package docs
            </button>

              <a href="llms.txt" target="_blank">
                View llms.txt
              </a>


              <a href="Opal.epub">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.40.1) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>


    </footer>
  </div>
</main>
</div>

  </body>
</html>
