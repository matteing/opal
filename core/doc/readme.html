<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.40.1">
    <meta name="project" content="Opal v0.1.0">


    <title>Overview — Opal v0.1.0</title>

    <link rel="stylesheet" href="dist/html-elixir-YJO4MOOW.css" />

    <script defer src="dist/sidebar_items-93C55D77.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-YU4BZFVS.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="https://github.com/scohen/opal" class="sidebar-projectName" translate="no">
Opal
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.1.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras="Pages"></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Opal</span>
            <div class="search-input-wrapper">
              <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
              <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
                <i class="ri-close-line ri-lg" title="Cancel search"></i>
              </button>
            </div>
          </label>
        </form>
        <div class="autocomplete">
        </div>
        <div class="engine-selector" data-multiple="false">
          <button type="button" class="engine-button" aria-label="Select search engine" aria-haspopup="true" aria-expanded="false">
            <i class="ri-search-2-line" aria-hidden="true"></i>
            <span class="engine-name">Default</span>
            <i class="ri-arrow-down-s-line" aria-hidden="true"></i>
          </button>
          <div class="engine-dropdown" hidden role="menu">

              <button type="button"
                      class="engine-option"
                      data-engine-url="search.html?q="
                      role="menuitemradio"
                      aria-checked="true">
                <span class="name">Default</span>
                <span class="help">In-browser search</span>
              </button>

          </div>
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>✦ Opal</h1>

<a href="readme.md" title="Copy Markdown (hold Ctrl/Cmd and click it to open as Markdown)" class="copy-markdown icon-action" rel="help">
  <i class="ri-markdown-line" aria-hidden="true"></i>
  <span class="sr-only">Copy Markdown</span>
</a>


      <a href="https://github.com/scohen/opal/blob/v0.1.0/README.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p><strong>Your coding agent is a GenServer. Your sub-agents are child processes. Your debugger is <code class="inline">:observer</code>.</strong></p><pre><code class="makeup bash" translate="no"><span class=""># Install it!
</span><span class="">npm i -g @shimmery/opal
</span><span class=""># Start it!
</span><span class="">opal
</span><span class=""># Inspect it!
</span><span class="">opal --inspect --connect
</span><span class=""># Integrate it!
</span><span class=""># Soon: Consume the library on Hexpm!
</span><span class="">#       Use it from any language through JSON-RPC!
</span></code></pre><p>I looked at every open-source agent harness I could find — <a href="https://github.com/badlogic/pi-mono">Pi</a>, Claude Code, Goose — and they're all written in TypeScript. Every single one.</p><p>A coding agent is a tree of stateful, long-running actors with a conversation loop at the heart. You need process isolation, concurrency, mid-run message injection, live introspection. That's not a TypeScript problem. That's an Erlang problem — and Erlang solved it decades ago.</p><p>Opal is two things: a <strong>clean Elixir library</strong> you can drop into any application's supervision tree, and a <strong>terminal interface</strong> that uses the library to give you a fully interactive coding agent. The CLI is actually built with the library — it bootstraps itself. The same library you'd use in your own app is the same one powering the TUI.</p><p>It ships a base set of tools (<code class="inline">read_file</code>, <code class="inline">write_file</code>, <code class="inline">edit_file</code>, <code class="inline">shell</code>, <code class="inline">sub_agent</code>), an MCP host, a skills system, sub-agent support, and a JSON-RPC daemon mode. Not ultra-minimal, but just enough to be genuinely useful out of the box.</p><hr class="thin"/><h2 id="what-makes-it-interesting" class="section-heading"><a href="#what-makes-it-interesting" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What makes it interesting</span></h2><p><strong>You can connect to a running agent and watch it think.</strong> This is the one that gets people. Opal uses Erlang distribution — from another terminal, connect to a live session and stream every event from every agent and sub-agent in real time:</p><pre><code class="makeup sh" translate="no"><span class="">opal --connect opal@hostname --inspect
</span></code></pre><p>No special debug mode. No logging infrastructure. Crack open <code class="inline">:observer</code> and you can see the full process tree, message queues, memory — everything. It's just how the BEAM works, and it's free.</p><p><strong>Sub-agents are just processes.</strong> Want to delegate a task to a child agent? Spawn one. It gets its own message history, its own tools, its own model if you want. Runs in parallel, fully isolated. If the parent dies, sub-agents are cleaned up automatically. No thread pools, no <code class="inline">Promise.all</code>, no async/await ceremony. Just processes.</p><p><strong>The process mailbox is the steering queue.</strong> Need to redirect an agent mid-run? <code class="inline">Opal.steer(agent, &quot;focus on tests instead&quot;)</code> drops a message into the GenServer's mailbox. Between tool executions, the agent checks for it. No polling, no callback chains. The BEAM's had this primitive for 30+ years.</p><p><strong>SSE streaming lands in <code class="inline">handle_info/2</code>.</strong> The LLM response streams via <a href="https://hexdocs.pm/req/0.5.17/Req.html"><code class="inline">Req</code></a> with <code class="inline">into: :self</code> — SSE chunks arrive directly as messages in the GenServer's mailbox. The agent loop processes them alongside tool results, steering messages, and abort signals using the same <code class="inline">receive</code> block. There's something very satisfying about that.</p><p><strong>It's an embeddable library, not just a CLI.</strong> Add <code class="inline">{:opal, ...}</code> to your deps and the full harness lives inside your Elixir app. No external process, no JSON-RPC overhead, no language interop — just Erlang message passing. Or run it headless as a JSON-RPC 2.0 daemon and consume it from any language.</p><h2 id="what-you-get" class="section-heading"><a href="#what-you-get" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What you get</span></h2><ul><li><strong>Interactive TUI</strong> — fullscreen terminal chat with streaming, thinking indicators, task tracking, themes. Elm Architecture via TermUI.</li><li><strong>Daemon mode</strong> — headless JSON-RPC 2.0 over stdio. Consume from any language.</li><li><strong>Sub-agents</strong> — delegate tasks to child agents. They're supervised processes with their own context.</li><li><strong>MCP host</strong> — connects to MCP servers, surfaces their tools alongside native ones. They become indistinguishable at runtime.</li><li><strong>Built-in tools</strong> — <code class="inline">read_file</code>, <code class="inline">write_file</code>, <code class="inline">edit_file</code>, <code class="inline">shell</code> (cross-platform), <code class="inline">sub_agent</code>.</li><li><strong>Skills</strong> — drop instruction sets into your project, Opal discovers and loads them as context.</li><li><strong>Event system</strong> — <a href="https://hexdocs.pm/elixir/Registry.html"><code class="inline">Registry</code></a>-based pub/sub. Subscribe from any process, build whatever you want on top.</li><li><strong>Cross-platform</strong> — Linux, macOS, Windows.</li></ul><h2 id="features" class="section-heading"><a href="#features" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Features</span></h2><p>Here's what the harness supports today.</p><h3 id="agent-runtime" class="section-heading"><a href="#agent-runtime" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Agent runtime</span></h3><ul><li>[x] Agentic tool loop — prompt → LLM → tool calls → repeat until done</li><li>[x] SSE streaming responses into the GenServer mailbox (<a href="https://hexdocs.pm/req/0.5.17/Req.html"><code class="inline">Req</code></a> + <code class="inline">into: :self</code>)</li><li>[x] Concurrent tool execution via <code class="inline">TaskSupervisor</code></li><li>[x] Streaming tool output — tools emit output chunks in real time (e.g., long shell commands)</li><li>[x] Extended thinking / reasoning — surfaces thinking events from Claude, o-series, etc.</li><li>[x] Configurable thinking level (<code class="inline">:off</code>, <code class="inline">:low</code>, <code class="inline">:medium</code>, <code class="inline">:high</code>)</li><li>[x] Mid-run steering — redirect the agent between tool executions</li><li>[x] Abort / cancel in-flight responses</li><li>[x] Stream stall detection — watchdog warns if no chunks arrive for 10+ seconds</li><li>[x] Auto-compaction — summarizes old messages when context nears 80% capacity</li><li>[x] Token usage tracking across turns</li><li>[x] Per-session supervision tree (<code class="inline">rest_for_one</code>)</li></ul><h3 id="tools" class="section-heading"><a href="#tools" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Tools</span></h3><ul><li>[x] <code class="inline">read_file</code> — read with optional line offset/limit</li><li>[x] <code class="inline">write_file</code> — write with auto-created parent directories</li><li>[x] <code class="inline">edit_file</code> — search-and-replace, enforces single-match uniqueness</li><li>[x] <code class="inline">shell</code> — cross-platform, configurable shell (sh/bash/zsh/cmd/powershell), streaming output, timeout</li><li>[x] <code class="inline">sub_agent</code> — spawn a child agent for delegated work, depth-limited to 1 level</li><li>[x] <code class="inline">tasks</code> — DETS-backed project-scoped task tracker (priorities, statuses, groups, tags, due dates, views)</li><li>[x] <code class="inline">use_skill</code> — load a skill's full instructions into context on demand</li><li>[x] Path sandboxing — all file tools reject directory traversal escapes</li></ul><h3 id="sessions" class="section-heading"><a href="#sessions" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Sessions</span></h3><ul><li>[x] Conversation tree with branching (rewind to any past message)</li><li>[x] JSONL persistence (save/load sessions to disk)</li><li>[x] Auto-save on idle</li><li>[x] Auto-title generation via LLM</li><li>[x] Session listing with title and modification time</li><li>[x] LLM-powered compaction with structured summaries (goal, progress, decisions, file ops, next steps)</li><li>[x] Truncation fallback when no LLM is available</li><li>[x] Turn-boundary-aware cutting — never splits mid-turn</li></ul><h3 id="skills" class="section-heading"><a href="#skills" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Skills</span></h3><ul><li>[x] Skill discovery — scans <code class="inline">.agents/skills/</code>, <code class="inline">.github/skills/</code>, <code class="inline">~/.agents/skills/</code>, <code class="inline">~/.opal/skills/</code></li><li>[x] Progressive disclosure — only name/description loaded at startup, full instructions on demand</li><li>[x] YAML frontmatter parsing (agentskills.io spec)</li></ul><h3 id="context-discovery" class="section-heading"><a href="#context-discovery" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Context discovery</span></h3><ul><li>[x] Walk-up file discovery — collects <code class="inline">AGENTS.md</code> / <code class="inline">OPAL.md</code> from working dir to root</li><li>[x] Priority ordering — closer files override distant ones</li></ul><h3 id="mcp" class="section-heading"><a href="#mcp" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">MCP</span></h3><ul><li>[x] MCP client host (Anubis, protocol v2025-03-26)</li><li>[x] Stdio and HTTP/SSE transports</li><li>[x] Auto-discovery from <code class="inline">.vscode/mcp.json</code>, <code class="inline">.github/mcp.json</code>, <code class="inline">.opal/mcp.json</code>, <code class="inline">.mcp.json</code></li><li>[x] MCP tools bridged as native <a href="Opal.Tool.html"><code class="inline">Opal.Tool</code></a> modules at runtime — identical to built-in tools</li><li>[x] Tool name collision resolution (server-prefixed)</li><li>[x] MCP resource access (list + read)</li><li>[x] Per-session MCP supervision</li></ul><h3 id="provider" class="section-heading"><a href="#provider" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Provider</span></h3><ul><li>[x] GitHub Copilot (Claude, GPT-4o/5, Gemini 2.5/3, Grok, o-series)</li><li>[x] Chat Completions API + Responses API (dual support)</li><li>[x] Device-code OAuth with auto-refresh</li><li>[x] Token persistence (<code class="inline">~/.opal/auth.json</code>)</li><li>[x] GitHub Enterprise support</li><li>[x] Provider behaviour — ready for OpenAI direct, Anthropic, Ollama, etc.</li></ul><h3 id="rpc" class="section-heading"><a href="#rpc" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">RPC</span></h3><ul><li>[x] JSON-RPC 2.0 over stdio (daemon mode)</li><li>[x] Bidirectional — server can request confirmations and input from the client</li><li>[x] Full event streaming (12 event types)</li><li>[x] Declarative protocol spec for codegen</li></ul><h3 id="cli-tui" class="section-heading"><a href="#cli-tui" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">CLI / TUI</span></h3><ul><li>[x] Fullscreen interactive chat (Elm Architecture via TermUI)</li><li>[x] Slash commands — <code class="inline">/clear</code>, <code class="inline">/compact</code>, <code class="inline">/dump</code>, <code class="inline">/model</code>, <code class="inline">/debug</code>, <code class="inline">/help</code></li><li>[x] Interactive model picker</li><li>[x] Context dump to JSON</li><li>[x] Remote inspection via Erlang distribution (<code class="inline">--connect --inspect</code>)</li></ul><h3 id="configuration" class="section-heading"><a href="#configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Configuration</span></h3><ul><li>[x] Layered config — defaults → app config → env vars → session overrides</li><li>[x] Feature toggles for sub-agents, context discovery, skills, MCP</li><li>[x] Cross-platform data dir (<code class="inline">~/.opal</code> / <code class="inline">%APPDATA%/opal</code>)</li><li>[x] Configurable default model, tools, shell type</li></ul><h2 id="architecture" class="section-heading"><a href="#architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture</span></h2><p>The repo is an <a href="https://nx.dev">Nx</a>-managed monorepo with two projects:</p><table><thead><tr><th style="text-align: left;">Project</th><th style="text-align: left;">What it is</th></tr></thead><tbody><tr><td style="text-align: left;"><strong><code class="inline">core/</code></strong></td><td style="text-align: left;"><strong>Opal SDK</strong> — the agent engine as an Elixir library. Tools, providers, sessions, MCP bridge, RPC server. Add <code class="inline">{:opal, ...}</code> to your deps and embed the whole thing in your supervision tree.</td></tr><tr><td style="text-align: left;"><strong><code class="inline">cli/</code></strong></td><td style="text-align: left;"><strong>Opal CLI</strong> — a fullscreen terminal UI that consumes the core library directly. No serialization layer between the TUI and the agent — it's all function calls in the same BEAM process tree.</td></tr></tbody></table><pre><code class="makeup elixir" translate="no"><span class="n">opal</span><span class="o">/</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">core</span><span class="o">/</span><span class="w">               </span><span class="nc">Opal</span><span class="w"> </span><span class="nc">SDK</span><span class="w"> </span><span class="p" data-group-id="4881953640-1">(</span><span class="nc">Elixir</span><span class="w"> </span><span class="n">library</span><span class="p" data-group-id="4881953640-1">)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span><span class="n">opal</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">agent</span><span class="o">.</span><span class="n">ex</span><span class="w">        </span><span class="nc">Agent</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="p" data-group-id="4881953640-2">(</span><span class="nc">GenServer</span><span class="p" data-group-id="4881953640-2">)</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">events</span><span class="o">.</span><span class="n">ex</span><span class="w">       </span><span class="nc">Registry</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">pub</span><span class="o">/</span><span class="n">sub</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">sub_agent</span><span class="o">.</span><span class="n">ex</span><span class="w">    </span><span class="nc">Supervised</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="n">agents</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">rpc</span><span class="o">/</span><span class="w">            </span><span class="nc">JSON</span><span class="o">-</span><span class="nc">RPC</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="p" data-group-id="4881953640-3">(</span><span class="n">daemon</span><span class="w"> </span><span class="n">mode</span><span class="p" data-group-id="4881953640-3">)</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">mcp</span><span class="o">/</span><span class="w">            </span><span class="nc">MCP</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">bridge</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">tool</span><span class="o">/</span><span class="w">           </span><span class="nc">Built</span><span class="o">-</span><span class="ow">in</span><span class="w"> </span><span class="n">tools</span><span class="w"> </span><span class="p" data-group-id="4881953640-4">(</span><span class="n">read</span><span class="p">,</span><span class="w"> </span><span class="n">write</span><span class="p">,</span><span class="w"> </span><span class="n">edit</span><span class="p">,</span><span class="w"> </span><span class="n">shell</span><span class="p">,</span><span class="w"> </span><span class="n">sub_agent</span><span class="p" data-group-id="4881953640-4">)</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">provider</span><span class="o">/</span><span class="w">       </span><span class="nc">LLM</span><span class="w"> </span><span class="n">providers</span><span class="w"> </span><span class="p" data-group-id="4881953640-5">(</span><span class="nc">Copilot</span><span class="p" data-group-id="4881953640-5">)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">cli</span><span class="o">/</span><span class="w">                </span><span class="nc">Terminal</span><span class="w"> </span><span class="nc">UI</span><span class="w"> </span><span class="p" data-group-id="4881953640-6">(</span><span class="nc">TermUI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nc">Elm</span><span class="w"> </span><span class="nc">Architecture</span><span class="p" data-group-id="4881953640-6">)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span><span class="n">opal</span><span class="o">/</span><span class="n">cli</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">app</span><span class="o">.</span><span class="n">ex</span><span class="w">          </span><span class="nc">TUI</span><span class="w"> </span><span class="n">application</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">ex</span><span class="w">         </span><span class="nc">Binary</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">point</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">views</span><span class="o">/</span><span class="w">          </span><span class="nc">UI</span><span class="w"> </span><span class="n">components</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">docs</span><span class="o">/</span><span class="w">               </span><span class="nc">Design</span><span class="w"> </span><span class="n">documents</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">ARCHITECTURE</span><span class="o">.</span><span class="n">md</span><span class="w">     </span><span class="nc">Full</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">design</span><span class="w"> </span><span class="n">reference</span></code></pre><h3 id="the-process-tree" class="section-heading"><a href="#the-process-tree" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">The process tree</span></h3><p>This is where it gets fun. Every session is its own supervision subtree:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Opal.SessionSupervisor</span><span class="w"> </span><span class="p" data-group-id="9476041925-1">(</span><span class="nc">DynamicSupervisor</span><span class="p" data-group-id="9476041925-1">)</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.SessionServer</span><span class="w"> </span><span class="p" data-group-id="9476041925-2">(</span><span class="n">per</span><span class="w"> </span><span class="n">session</span><span class="p" data-group-id="9476041925-2">)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.Agent</span><span class="w"> </span><span class="p" data-group-id="9476041925-3">(</span><span class="nc">GenServer</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">agentic</span><span class="w"> </span><span class="n">loop</span><span class="p" data-group-id="9476041925-3">)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.Session</span><span class="w"> </span><span class="p" data-group-id="9476041925-4">(</span><span class="nc">GenServer</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">history</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">persistence</span><span class="p" data-group-id="9476041925-4">)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.ToolSup</span><span class="w"> </span><span class="p" data-group-id="9476041925-5">(</span><span class="nc">TaskSupervisor</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="n">concurrent</span><span class="w"> </span><span class="n">tool</span><span class="w"> </span><span class="n">execution</span><span class="p" data-group-id="9476041925-5">)</span><span class="w">
    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="9476041925-6">[</span><span class="nc">Sub</span><span class="o">-</span><span class="n">agents</span><span class="p" data-group-id="9476041925-6">]</span><span class="w"> </span><span class="p" data-group-id="9476041925-7">(</span><span class="n">full</span><span class="w"> </span><span class="nc">Agent</span><span class="w"> </span><span class="n">processes</span><span class="p">,</span><span class="w"> </span><span class="n">supervised</span><span class="p" data-group-id="9476041925-7">)</span><span class="w">

</span><span class="nc">Opal.Events</span><span class="w"> </span><span class="p" data-group-id="9476041925-8">(</span><span class="nc">Registry</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="n">pub</span><span class="o">/</span><span class="n">sub</span><span class="p">,</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">subscribe</span><span class="p" data-group-id="9476041925-8">)</span></code></pre><p>The agent loop is a GenServer. It receives prompts, streams LLM responses via <a href="https://hexdocs.pm/req/0.5.17/Req.html"><code class="inline">Req</code></a> (SSE chunks arrive as messages in <code class="inline">handle_info/2</code> — beautiful), executes tool calls concurrently through a <code class="inline">TaskSupervisor</code>, and loops until the model produces a final response with no tool calls.</p><p>See <a href="architecture.html">ARCHITECTURE.md</a> for the full system design.</p><hr class="thin"/><h2 id="quick-start" class="section-heading"><a href="#quick-start" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Quick start</span></h2><p><strong>Requirements:</strong> Elixir ≥ 1.18 / OTP ≥ 27, a <a href="https://github.com/features/copilot">GitHub Copilot</a> subscription, <a href="https://nx.dev">Nx</a> (<code class="inline">npm i -g nx</code>).</p><pre><code class="makeup sh" translate="no"><span class="">git clone https://github.com/scohen/opal.git
</span><span class="">cd opal
</span><span class="">nx run-many -t deps
</span><span class="">cd cli &amp;&amp; mix opal
</span></code></pre><p>On first run, you'll authenticate via GitHub device code flow. No API keys to juggle.</p><h2 id="building-the-binary" class="section-heading"><a href="#building-the-binary" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Building the binary</span></h2><pre><code class="makeup sh" translate="no"><span class="">nx run cli:escript
</span><span class="">
</span><span class="">cli/opal                   # interactive TUI
</span><span class="">cli/opal --daemon          # headless JSON-RPC server
</span><span class="">cli/opal --inspect         # stream all agent events to terminal
</span><span class="">cli/opal --help
</span></code></pre><h2 id="cli-modes" class="section-heading"><a href="#cli-modes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">CLI modes</span></h2><table><thead><tr><th style="text-align: left;">Flag</th><th style="text-align: left;">Mode</th><th style="text-align: left;">What it does</th></tr></thead><tbody><tr><td style="text-align: left;"><em>(none)</em></td><td style="text-align: left;">Interactive</td><td style="text-align: left;">Fullscreen TUI with streaming chat</td></tr><tr><td style="text-align: left;"><code class="inline">--daemon</code></td><td style="text-align: left;">Headless</td><td style="text-align: left;">JSON-RPC 2.0 server on stdin/stdout</td></tr><tr><td style="text-align: left;"><code class="inline">--inspect</code></td><td style="text-align: left;">Inspector</td><td style="text-align: left;">Stream all agent events to terminal</td></tr><tr><td style="text-align: left;"><code class="inline">--connect NODE --inspect</code></td><td style="text-align: left;">Remote inspect</td><td style="text-align: left;">Attach to a running instance via Erlang distribution</td></tr></tbody></table><h2 id="using-opal-as-a-library" class="section-heading"><a href="#using-opal-as-a-library" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Using Opal as a library</span></h2><p>This is the part I'm most excited about. The <code class="inline">core/</code> project is an embeddable Elixir library — add it to your supervision tree and you get everything. No external process, no RPC, no serialization. Just Erlang message passing.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># mix.exs</span><span class="w">
</span><span class="kd">defp</span><span class="w"> </span><span class="nf">deps</span><span class="w"> </span><span class="k" data-group-id="8692477699-1">do</span><span class="w">
  </span><span class="p" data-group-id="8692477699-2">[</span><span class="p" data-group-id="8692477699-3">{</span><span class="ss">:opal</span><span class="p">,</span><span class="w"> </span><span class="ss">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;../opal/core&quot;</span><span class="p" data-group-id="8692477699-3">}</span><span class="p" data-group-id="8692477699-2">]</span><span class="w">
</span><span class="k" data-group-id="8692477699-1">end</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># Start a session — it&#39;s a supervised process tree</span><span class="w">
</span><span class="p" data-group-id="5387174570-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">agent</span><span class="p" data-group-id="5387174570-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">start_session</span><span class="p" data-group-id="5387174570-2">(</span><span class="p" data-group-id="5387174570-3">%{</span><span class="w">
  </span><span class="ss">system_prompt</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;You are a helpful coding assistant.&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">working_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/to/project&quot;</span><span class="w">
</span><span class="p" data-group-id="5387174570-3">}</span><span class="p" data-group-id="5387174570-2">)</span><span class="w">

</span><span class="c1"># Async — subscribe to Opal.Events for streaming output</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">prompt</span><span class="p" data-group-id="5387174570-4">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;List all Elixir files&quot;</span><span class="p" data-group-id="5387174570-4">)</span><span class="w">

</span><span class="c1"># Sync — blocks until the agent finishes</span><span class="w">
</span><span class="p" data-group-id="5387174570-5">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p" data-group-id="5387174570-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">prompt_sync</span><span class="p" data-group-id="5387174570-6">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;What does this module do?&quot;</span><span class="p" data-group-id="5387174570-6">)</span><span class="w">

</span><span class="c1"># Steer mid-run — injected between tool executions</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">steer</span><span class="p" data-group-id="5387174570-7">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Actually, focus on the test files&quot;</span><span class="p" data-group-id="5387174570-7">)</span><span class="w">

</span><span class="c1"># Change models on the fly</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">set_model</span><span class="p" data-group-id="5387174570-8">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="ss">:copilot</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;claude-sonnet-4&quot;</span><span class="p" data-group-id="5387174570-8">)</span><span class="w">

</span><span class="c1"># Clean up</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">stop_session</span><span class="p" data-group-id="5387174570-9">(</span><span class="n">agent</span><span class="p" data-group-id="5387174570-9">)</span></code></pre><h3 id="observability" class="section-heading"><a href="#observability" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Observability</span></h3><p>Any process can subscribe to agent events in real time. The event system is built on <a href="https://hexdocs.pm/elixir/Registry.html"><code class="inline">Registry</code></a>, so it's fast and it's what Elixir developers already know:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Opal.Events</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="7590790775-1">(</span><span class="n">session_id</span><span class="p" data-group-id="7590790775-1">)</span><span class="w">

</span><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="7590790775-2">do</span><span class="w">
  </span><span class="p" data-group-id="7590790775-3">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7590790775-4">{</span><span class="ss">:message_delta</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7590790775-5">%{</span><span class="ss">delta</span><span class="p">:</span><span class="w"> </span><span class="n">text</span><span class="p" data-group-id="7590790775-5">}</span><span class="p" data-group-id="7590790775-4">}</span><span class="p" data-group-id="7590790775-3">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">write</span><span class="p" data-group-id="7590790775-6">(</span><span class="n">text</span><span class="p" data-group-id="7590790775-6">)</span><span class="w">
  </span><span class="p" data-group-id="7590790775-7">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7590790775-8">{</span><span class="ss">:tool_execution_start</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7590790775-9">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="n">name</span><span class="p" data-group-id="7590790775-9">}</span><span class="p" data-group-id="7590790775-8">}</span><span class="p" data-group-id="7590790775-7">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7590790775-10">(</span><span class="s">&quot;Running tool: </span><span class="si" data-group-id="7590790775-11">#{</span><span class="n">name</span><span class="si" data-group-id="7590790775-11">}</span><span class="s">&quot;</span><span class="p" data-group-id="7590790775-10">)</span><span class="w">
  </span><span class="p" data-group-id="7590790775-12">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7590790775-13">{</span><span class="ss">:agent_end</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="7590790775-13">}</span><span class="p" data-group-id="7590790775-12">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7590790775-14">(</span><span class="s">&quot;Done.&quot;</span><span class="p" data-group-id="7590790775-14">)</span><span class="w">
</span><span class="k" data-group-id="7590790775-2">end</span></code></pre><p><code class="inline">Opal.Events.subscribe_all()</code> gives you events from <em>every</em> session — useful for dashboards, logging, or just poking around.</p><h2 id="rpc-interface" class="section-heading"><a href="#rpc-interface" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">RPC interface</span></h2><p>If you're not in the Elixir/Erlang ecosystem, run Opal in daemon mode and talk to it over JSON-RPC 2.0 on stdio:</p><pre><code class="makeup sh" translate="no"><span class="">opal --daemon
</span></code></pre><p>Wire format follows the MCP stdio transport convention. See <a href="architecture.html">ARCHITECTURE.md</a> for the full schema.</p><h2 id="development" class="section-heading"><a href="#development" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Development</span></h2><pre><code class="makeup sh" translate="no"><span class=""># Install deps
</span><span class="">nx run-many -t deps
</span><span class="">
</span><span class=""># Run the TUI in dev mode (auto-recompiles)
</span><span class="">cd cli &amp;&amp; mix opal
</span><span class=""># — or —
</span><span class="">nx run cli:dev
</span><span class="">
</span><span class=""># Tests
</span><span class="">nx run-many -t test
</span><span class="">nx run core:test
</span><span class="">nx run cli:test
</span><span class="">
</span><span class=""># Lint / format
</span><span class="">nx run-many -t lint
</span><span class="">nx run-many -t format
</span></code></pre><h3 id="nx-targets" class="section-heading"><a href="#nx-targets" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Nx targets</span></h3><table><thead><tr><th style="text-align: left;">Target</th><th style="text-align: left;">Core</th><th style="text-align: left;">CLI</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">dev</code></td><td style="text-align: left;">—</td><td style="text-align: left;">✓</td><td style="text-align: left;">Run TUI in dev mode (<code class="inline">mix opal</code>)</td></tr><tr><td style="text-align: left;"><code class="inline">build</code></td><td style="text-align: left;">✓</td><td style="text-align: left;">✓</td><td style="text-align: left;">Compile with <code class="inline">--warnings-as-errors</code></td></tr><tr><td style="text-align: left;"><code class="inline">test</code></td><td style="text-align: left;">✓</td><td style="text-align: left;">✓</td><td style="text-align: left;">Run ExUnit tests</td></tr><tr><td style="text-align: left;"><code class="inline">lint</code></td><td style="text-align: left;">✓</td><td style="text-align: left;">✓</td><td style="text-align: left;">Check formatting</td></tr><tr><td style="text-align: left;"><code class="inline">format</code></td><td style="text-align: left;">✓</td><td style="text-align: left;">✓</td><td style="text-align: left;">Auto-format code</td></tr><tr><td style="text-align: left;"><code class="inline">escript</code></td><td style="text-align: left;">—</td><td style="text-align: left;">✓</td><td style="text-align: left;">Build standalone binary</td></tr><tr><td style="text-align: left;"><code class="inline">deps</code></td><td style="text-align: left;">✓</td><td style="text-align: left;">✓</td><td style="text-align: left;">Fetch dependencies</td></tr><tr><td style="text-align: left;"><code class="inline">docs</code></td><td style="text-align: left;">✓</td><td style="text-align: left;">—</td><td style="text-align: left;">Generate ex_doc</td></tr><tr><td style="text-align: left;"><code class="inline">clean</code></td><td style="text-align: left;">✓</td><td style="text-align: left;">✓</td><td style="text-align: left;">Clean build artifacts</td></tr></tbody></table><h2 id="provider-1" class="section-heading"><a href="#provider-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Provider</span></h2><p>Opal currently ships with one LLM provider: <strong>GitHub Copilot</strong>. One endpoint gives you access to Claude, GPT-4o, o3, and other models. Authentication is device-code OAuth — no API keys to manage.</p><p>The provider system is a behaviour (<a href="Opal.Provider.html"><code class="inline">Opal.Provider</code></a>), so adding OpenAI direct, Anthropic, Ollama, or anything else is straightforward. The Copilot provider uses the OpenAI Responses API wire format, so most of the hard work transfers.</p><h2 id="why-i-built-this" class="section-heading"><a href="#why-i-built-this" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Why I built this</span></h2><p>I wanted to understand how agent harnesses actually work — not just use one, but build one from the ground up. I studied <a href="https://github.com/badlogic/pi-mono">Pi</a> and thought the architecture was smart, but everything was TypeScript. And the more I stared at the problem — long-running loops, concurrent tool execution, process isolation, sub-agent orchestration — the more it looked like someone had described Erlang/OTP to me without saying the name.</p><p>So I built it. It took dramatically fewer lines of code than I expected. Sub-agents? Processes. Steering? Mailbox. Fault isolation? Supervision tree. Live debugging? Erlang distribution. I didn't have to build any of that infrastructure — it was already there.</p><p>This is a hobby project and a research project. It's inspired by Pi but doesn't chase extreme minimalism — Elixir's process model makes features like sub-agents and concurrent tool execution essentially free, so there's no reason to leave them out. Not minimal for the sake of it, just enough to be useful. And it does bootstrap itself, which is pretty fun.</p><p>Made with love by a proud Boricua.</p><h2 id="disclaimer" class="section-heading"><a href="#disclaimer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Disclaimer</span></h2><p>This is a personal hobby project. I work at Microsoft (Azure), and our GitHub Copilot subscription provides the LLM access I use for development.</p><p><strong>This project is not affiliated with, endorsed by, or related to my employer in any way. Neither are my opinions.</strong></p><h2 id="license" class="section-heading"><a href="#license" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">License</span></h2><p><a href="LICENSE">MIT</a> — Sergio Mattei</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

  </div>
  <div class="bottom-actions-item">

      <a href="architecture.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Architecture
        </span>
      </a>

  </div>
</div>
    <footer class="footer">

        <p>

            <span class="line">
              <a href="https://hex.pm/packages/opal/0.1.0">Hex Package</a>

              <a href="https://preview.hex.pm/preview/opal/0.1.0">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/opal/0.1.0/show/README.md">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Go to package docs">
              Go to package docs
            </button>

              <a href="llms.txt" target="_blank">
                View llms.txt
              </a>


              <a href="Opal.epub">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.40.1) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>


    </footer>
  </div>
</main>
</div>

  </body>
</html>
