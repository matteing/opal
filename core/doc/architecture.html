<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.40.1">
    <meta name="project" content="Opal v0.1.0">


    <title>Architecture — Opal v0.1.0</title>

    <link rel="stylesheet" href="dist/html-elixir-YJO4MOOW.css" />

    <script defer src="dist/sidebar_items-93C55D77.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-YU4BZFVS.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="https://github.com/scohen/opal" class="sidebar-projectName" translate="no">
Opal
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.1.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras="Pages"></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Opal</span>
            <div class="search-input-wrapper">
              <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
              <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
                <i class="ri-close-line ri-lg" title="Cancel search"></i>
              </button>
            </div>
          </label>
        </form>
        <div class="autocomplete">
        </div>
        <div class="engine-selector" data-multiple="false">
          <button type="button" class="engine-button" aria-label="Select search engine" aria-haspopup="true" aria-expanded="false">
            <i class="ri-search-2-line" aria-hidden="true"></i>
            <span class="engine-name">Default</span>
            <i class="ri-arrow-down-s-line" aria-hidden="true"></i>
          </button>
          <div class="engine-dropdown" hidden role="menu">

              <button type="button"
                      class="engine-option"
                      data-engine-url="search.html?q="
                      role="menuitemradio"
                      aria-checked="true">
                <span class="name">Default</span>
                <span class="help">In-browser search</span>
              </button>

          </div>
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Opal — An OTP-Native Coding Agent Harness</h1>

<a href="architecture.md" title="Copy Markdown (hold Ctrl/Cmd and click it to open as Markdown)" class="copy-markdown icon-action" rel="help">
  <i class="ri-markdown-line" aria-hidden="true"></i>
  <span class="sr-only">Copy Markdown</span>
</a>


      <a href="https://github.com/scohen/opal/blob/v0.1.0/../ARCHITECTURE.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<blockquote><p><em>Inspired by <a href="https://github.com/badlogic/pi-mono/tree/main/packages/coding-agent">Pi</a>, reimagined for the BEAM.</em></p></blockquote><h2 id="what-this-is" class="section-heading"><a href="#what-this-is" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What This Is</span></h2><p>Opal is an Elixir SDK for building coding agents that takes full advantage of OTP
primitives — supervision trees, GenServers, process isolation, message passing,
and the observer. Rather than port Pi to Elixir, we steal the ideas that matter
and throw away the ones OTP already solves better.</p><p><strong>Core thesis:</strong> A coding agent is a tree of actors with a conversation loop at
the heart. The BEAM gives us fault-tolerance, introspection, and massive
parallelism for free — things Pi has to bolt on through extensions, tmux hacks,
or external process spawning.</p><p><strong>Cross-platform by default.</strong> Elixir and the BEAM run on Linux, macOS, and
Windows. Opal must work on all three from day one — no POSIX assumptions, no
bash-only tooling, no hardcoded <code class="inline">/</code> paths.</p><hr class="thin"/><h2 id="what-we-take-from-pi" class="section-heading"><a href="#what-we-take-from-pi" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What We Take from Pi</span></h2><table><thead><tr><th style="text-align: left;">Pi Concept</th><th style="text-align: left;">What We Keep</th><th style="text-align: left;">What We Change</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Agent loop</strong> (prompt → LLM → tool calls → repeat)</td><td style="text-align: left;">The core loop shape</td><td style="text-align: left;">It's a GenServer, not an async function</td></tr><tr><td style="text-align: left;"><strong>Tools</strong> (read, write, edit, shell)</td><td style="text-align: left;">Tool interface and built-in set</td><td style="text-align: left;">Tools are module callbacks, not JS objects</td></tr><tr><td style="text-align: left;"><strong>Sessions</strong> (JSONL tree with branching)</td><td style="text-align: left;">Tree-structured message history</td><td style="text-align: left;">ETS/DETS-backed, not file-append</td></tr><tr><td style="text-align: left;"><strong>Events</strong> (agent_start, tool_execution_end, etc.)</td><td style="text-align: left;">Event lifecycle model</td><td style="text-align: left;"><a href="https://hexdocs.pm/elixir/Registry.html"><code class="inline">Registry</code></a>-based pubsub, not callback lists</td></tr><tr><td style="text-align: left;"><strong>SDK embedding</strong></td><td style="text-align: left;">Embeddable in apps</td><td style="text-align: left;">Native OTP — just add to your supervision tree</td></tr><tr><td style="text-align: left;"><strong>Extensibility</strong> (extensions, skills, prompts)</td><td style="text-align: left;">Plugin system concept</td><td style="text-align: left;">Behaviours, not runtime JS loading</td></tr><tr><td style="text-align: left;"><strong>Steering/follow-up queues</strong></td><td style="text-align: left;">Mid-run message injection</td><td style="text-align: left;">Process mailbox <em>is</em> the queue</td></tr><tr><td style="text-align: left;"><strong>Provider abstraction</strong></td><td style="text-align: left;">Multi-provider from day one</td><td style="text-align: left;">Single provider (GitHub Copilot) to start — behaviour ready for others</td></tr></tbody></table><h2 id="what-we-don-t-take" class="section-heading"><a href="#what-we-don-t-take" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What We Don't Take</span></h2><ul><li><strong>No npm/git package system.</strong> Hex packages and Mix deps.</li><li><strong>Single binary with built-in TUI.</strong> The <code class="inline">opal</code> binary includes both the
interactive terminal UI (TermUI/Elm Architecture) and the agent engine in a
single BEAM process tree. No separate frontend process or serialization layer.
A <code class="inline">--daemon</code> flag provides headless JSON-RPC mode for external consumers.</li><li><strong>RPC for external consumers only.</strong> Opal ships as both a library
(<code class="inline">{:opal, ...}</code>) and a binary (<code class="inline">opal</code>). In interactive mode, the TUI calls
the agent directly via Elixir function calls — no RPC overhead. In daemon
mode (<code class="inline">opal --daemon</code>), it communicates via JSON-RPC 2.0 over stdio for
external clients.</li><li><strong>MCP client, not MCP-hostile.</strong> Pi says &quot;no MCP&quot; — we disagree. Opal acts
as an MCP <em>host</em>: it connects to external MCP servers and surfaces their
tools/resources to the agent alongside native <a href="Opal.Tool.html"><code class="inline">Opal.Tool</code></a> modules. We use
<a href="https://hexdocs.pm/anubis_mcp">Anubis MCP</a> (<code class="inline">~&gt; 0.17</code>) as the protocol
foundation — it handles transports, lifecycle, and JSON-RPC so we don't
reinvent any of it. Native tools and MCP tools coexist; MCP servers are just
another tool source, managed by supervised Anubis client processes.</li></ul><hr class="thin"/><h2 id="architecture-overview" class="section-heading"><a href="#architecture-overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture Overview</span></h2><pre><code class="makeup elixir" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w">                    </span><span class="n">opal</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="p" data-group-id="9230959499-1">(</span><span class="nc">Elixir</span><span class="p" data-group-id="9230959499-1">)</span><span class="w">                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="nc">Interactive</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="p" data-group-id="9230959499-2">(</span><span class="n">default</span><span class="p" data-group-id="9230959499-2">)</span><span class="p">:</span><span class="w">                             </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">              </span><span class="nc">Opal.CLI.App</span><span class="w"> </span><span class="p" data-group-id="9230959499-3">(</span><span class="nc">TermUI</span><span class="p" data-group-id="9230959499-3">)</span><span class="w">                   </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">init</span><span class="o">/</span><span class="n">update</span><span class="o">/</span><span class="n">view</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="nc">Elm</span><span class="w"> </span><span class="nc">Architecture</span><span class="w">                 </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                                                      </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nc">Header</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nc">MessageList</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nc">Thinking</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nc">TaskList</span><span class="w">           </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nc">Input</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nc">StatusBar</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nc">ConfirmDialog</span><span class="w">                </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                           </span><span class="err">│</span><span class="w"> </span><span class="n">direct</span><span class="w"> </span><span class="nc">Elixir</span><span class="w"> </span><span class="n">calls</span><span class="w">          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                           </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="9230959499-4">(</span><span class="n">no</span><span class="w"> </span><span class="n">serialization</span><span class="p" data-group-id="9230959499-4">)</span><span class="w">           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">              </span><span class="nc">Opal</span><span class="w"> </span><span class="p" data-group-id="9230959499-5">(</span><span class="n">core</span><span class="w"> </span><span class="n">library</span><span class="p" data-group-id="9230959499-5">)</span><span class="w">                     </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nc">Agent</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">Session</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">Tools</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">MCP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">Provider</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">Events</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="nc">Daemon</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="p" data-group-id="9230959499-6">(</span><span class="o">--</span><span class="n">daemon</span><span class="p" data-group-id="9230959499-6">)</span><span class="p">:</span><span class="w">                                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nc">Opal.RPC.Stdio</span><span class="w"> </span><span class="p" data-group-id="9230959499-7">(</span><span class="nc">JSON</span><span class="o">-</span><span class="nc">RPC</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">stdin</span><span class="o">/</span><span class="n">stdout</span><span class="p" data-group-id="9230959499-7">)</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nc">For</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="nc">TUI</span><span class="p">,</span><span class="w"> </span><span class="n">headless</span><span class="w"> </span><span class="n">operation</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="nc">As</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="p" data-group-id="9230959499-8">(</span><span class="p" data-group-id="9230959499-9">{</span><span class="ss">:opal</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.x&quot;</span><span class="p" data-group-id="9230959499-9">}</span><span class="p" data-group-id="9230959499-8">)</span><span class="p">:</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nc">Opal</span><span class="o">.</span><span class="n">start_session</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">prompt</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="o">.</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nc">Embed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">own</span><span class="w"> </span><span class="nc">Elixir</span><span class="w"> </span><span class="n">application</span><span class="w">                </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="internal-process-tree" class="section-heading"><a href="#internal-process-tree" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Internal Process Tree</span></h3><pre><code class="makeup elixir" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w">                  </span><span class="nc">Opal.SessionSupervisor</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">              </span><span class="p" data-group-id="6798342629-1">(</span><span class="nc">DynamicSupervisor</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">session</span><span class="p" data-group-id="6798342629-1">)</span><span class="w">             </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nc">Opal.Agent</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nc">Opal.Session</span><span class="w"> </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nc">Opal.ToolSup</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="6798342629-2">(</span><span class="nc">GenServer</span><span class="p" data-group-id="6798342629-2">)</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="6798342629-3">(</span><span class="nc">GenServer</span><span class="p" data-group-id="6798342629-3">)</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="6798342629-4">(</span><span class="nc">TaskSupervisor</span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">tools</span><span class="p" data-group-id="6798342629-4">)</span><span class="w">    </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="nc">LLM</span><span class="w"> </span><span class="n">loop</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="nc">Message</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="nc">Streaming</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">   </span><span class="n">history</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="nc">Concurrent</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="nc">Turn</span><span class="w"> </span><span class="n">mgmt</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="nc">Branching</span><span class="w"> </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">   </span><span class="n">tool</span><span class="w"> </span><span class="n">exec</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="nc">Steering</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="nc">Persist</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="nc">Timeouts</span><span class="w">    </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">                                               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="nc">Registry</span><span class="w">                           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">         </span><span class="err">▼</span><span class="w">                                               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">                                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nc">Opal.Events</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">←</span><span class="w"> </span><span class="nc">Any</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">subscribe</span><span class="w">          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="6798342629-5">(</span><span class="nc">Registry</span><span class="p" data-group-id="6798342629-5">)</span><span class="w">   </span><span class="err">│</span><span class="w">                                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                                       </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><hr class="thin"/><h2 id="staged-build-plan" class="section-heading"><a href="#staged-build-plan" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Staged Build Plan</span></h2><p>When in doubt, you can check <a href="https://github.com/badlogic/pi-mono/tree/main/packages/coding-agent">Pi</a> for specific algorithms or implementation inspiration. You must stick to the overall architecture in this document, however.</p><h3 id="stage-1-the-loop-mvp" class="section-heading"><a href="#stage-1-the-loop-mvp" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stage 1 — The Loop (MVP)</span></h3><blockquote><p>Goal: Send a prompt, get a streamed response, execute tools, repeat.
Dependencies: <a href="https://hexdocs.pm/req"><code class="inline">req</code></a> (~&gt; 0.5), <a href="https://hexdocs.pm/jason"><code class="inline">jason</code></a> (~&gt; 1.4)</p></blockquote><p>This is the beating heart. Everything else is scaffolding around it.</p><h4>Modules</h4><p><strong><a href="Opal.Agent.html"><code class="inline">Opal.Agent</code></a></strong> — GenServer</p><p>The agent loop as a stateful process. Holds the system prompt, message history,
tools, model config, and streaming state.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Public API</span><span class="w">
</span><span class="nc">Opal.Agent</span><span class="o">.</span><span class="n">prompt</span><span class="p" data-group-id="3866055283-1">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;What files are in src/?&quot;</span><span class="p" data-group-id="3866055283-1">)</span><span class="w">
</span><span class="nc">Opal.Agent</span><span class="o">.</span><span class="n">steer</span><span class="p" data-group-id="3866055283-2">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Actually, focus on lib/ instead&quot;</span><span class="p" data-group-id="3866055283-2">)</span><span class="w">
</span><span class="nc">Opal.Agent</span><span class="o">.</span><span class="n">follow_up</span><span class="p" data-group-id="3866055283-3">(</span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Now write tests for those&quot;</span><span class="p" data-group-id="3866055283-3">)</span><span class="w">
</span><span class="nc">Opal.Agent</span><span class="o">.</span><span class="n">abort</span><span class="p" data-group-id="3866055283-4">(</span><span class="n">agent</span><span class="p" data-group-id="3866055283-4">)</span><span class="w">
</span><span class="nc">Opal.Agent</span><span class="o">.</span><span class="n">get_state</span><span class="p" data-group-id="3866055283-5">(</span><span class="n">agent</span><span class="p" data-group-id="3866055283-5">)</span><span class="w">
</span><span class="nc">Opal.Agent</span><span class="o">.</span><span class="n">platform</span><span class="p" data-group-id="3866055283-6">(</span><span class="n">agent</span><span class="p" data-group-id="3866055283-6">)</span><span class="w">  </span><span class="c1"># :linux | :macos | :windows</span></code></pre><p>Internal state:</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="6161107081-1">%</span><span class="nc" data-group-id="6161107081-1">Opal.Agent.State</span><span class="p" data-group-id="6161107081-1">{</span><span class="w">
  </span><span class="ss">system_prompt</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6161107081-2">(</span><span class="p" data-group-id="6161107081-2">)</span><span class="p">,</span><span class="w">
  </span><span class="ss">messages</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6161107081-3">[</span><span class="nc">Opal.Message</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6161107081-4">(</span><span class="p" data-group-id="6161107081-4">)</span><span class="p" data-group-id="6161107081-3">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">model</span><span class="p">:</span><span class="w"> </span><span class="nc">Opal.Model</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6161107081-5">(</span><span class="p" data-group-id="6161107081-5">)</span><span class="p">,</span><span class="w">   </span><span class="c1"># e.g. %{provider: :copilot, id: &quot;claude-sonnet-4-5&quot;}</span><span class="w">
  </span><span class="ss">tools</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6161107081-6">[</span><span class="nc">Opal.Tool</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6161107081-7">(</span><span class="p" data-group-id="6161107081-7">)</span><span class="p" data-group-id="6161107081-6">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">thinking_level</span><span class="p">:</span><span class="w"> </span><span class="ss">:off</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:low</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:medium</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:high</span><span class="p">,</span><span class="w">
  </span><span class="ss">streaming?</span><span class="p">:</span><span class="w"> </span><span class="n">boolean</span><span class="p" data-group-id="6161107081-8">(</span><span class="p" data-group-id="6161107081-8">)</span><span class="p">,</span><span class="w">
  </span><span class="ss">pending_tool_calls</span><span class="p">:</span><span class="w"> </span><span class="nc">MapSet</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6161107081-9">(</span><span class="p" data-group-id="6161107081-9">)</span><span class="w">
</span><span class="p" data-group-id="6161107081-1">}</span></code></pre><p>The loop:</p><ol><li>Receive <code class="inline">prompt</code> cast → append user message → call LLM</li><li>Stream response tokens → broadcast <code class="inline">:message_update</code> events</li><li>If response contains tool calls → execute each tool (via TaskSupervisor)</li><li>Append tool results → call LLM again (next turn)</li><li>If no tool calls → broadcast <code class="inline">:agent_end</code> → return to idle</li><li>Between tool executions, check mailbox for steering messages</li></ol><p>Steering is natural: <code class="inline">steer/2</code> sends a message to the GenServer's mailbox.
Between tool executions, the loop does a selective <code class="inline">receive</code> to check for
steering — no polling, no callbacks, just the mailbox.</p><p><strong><a href="Opal.Provider.html"><code class="inline">Opal.Provider</code></a></strong> — Behaviour</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.Provider</span><span class="w"> </span><span class="k" data-group-id="9402990372-1">do</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">stream</span><span class="p" data-group-id="9402990372-2">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="9402990372-2">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="9402990372-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">stream_ref</span><span class="p" data-group-id="9402990372-3">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="9402990372-4">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">term</span><span class="p" data-group-id="9402990372-4">}</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">parse_event</span><span class="p" data-group-id="9402990372-5">(</span><span class="n">raw_event</span><span class="p" data-group-id="9402990372-5">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">Opal.Provider.Event</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="9402990372-6">(</span><span class="p" data-group-id="9402990372-6">)</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">models</span><span class="p" data-group-id="9402990372-7">(</span><span class="p" data-group-id="9402990372-7">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="9402990372-8">[</span><span class="nc">Opal.Model</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="9402990372-9">(</span><span class="p" data-group-id="9402990372-9">)</span><span class="p" data-group-id="9402990372-8">]</span><span class="w">
</span><span class="k" data-group-id="9402990372-1">end</span></code></pre><p>Stage 1 ships with <a href="Opal.Provider.Copilot.html"><code class="inline">Opal.Provider.Copilot</code></a> — GitHub Copilot via the OpenAI
Responses API. This is the only provider we build initially; the behaviour is
ready for others later.</p><p><strong>Why Copilot first?</strong></p><ul><li>Free for anyone with a GitHub account (Copilot Free tier)</li><li>Uses the OpenAI Responses API wire format, so the same code path covers
direct OpenAI usage later with minimal changes</li><li>Device-code OAuth flow — no manual API key management needed</li><li>Access to Claude, GPT-4o, o3, and other models through one endpoint</li></ul><p><strong><a href="Opal.Provider.Copilot.html"><code class="inline">Opal.Provider.Copilot</code></a></strong> — the GitHub Copilot provider</p><p>The provider implements the OpenAI Responses API streaming protocol, with
Copilot-specific headers and OAuth token management. All HTTP is done via
<a href="https://hexdocs.pm/req">Req</a> (<code class="inline">~&gt; 0.5</code>). Reference implementation:
<a href="https://github.com/badlogic/pi-mono/blob/main/packages/ai/src/providers/openai-responses.ts">Pi's openai-responses.ts</a>
and <a href="https://github.com/badlogic/pi-mono/blob/main/packages/ai/src/utils/oauth/github-copilot.ts">github-copilot.ts</a>.</p><p>Key implementation details from the reference:</p><p><strong>Authentication — Device Code OAuth Flow:</strong></p><ol><li>POST <code class="inline">https://github.com/login/device/code</code> with client ID → get
<code class="inline">device_code</code>, <code class="inline">user_code</code>, <code class="inline">verification_uri</code></li><li>User visits URL, enters code</li><li>Poll <code class="inline">https://github.com/login/oauth/access_token</code> until granted</li><li>Exchange GitHub access token → Copilot API token via
<code class="inline">https://api.github.com/copilot_internal/v2/token</code></li><li>Parse <code class="inline">proxy-ep</code> from Copilot token to derive the API base URL
(e.g. <code class="inline">https://api.individual.githubcopilot.com</code>)</li><li>Token expires → refresh using the stored GitHub access token</li></ol><p>The token is stored on disk in <code class="inline">Opal.Config.data_dir()/auth.json</code>.
Re-login only when refresh fails. All HTTP calls in the auth flow use <a href="https://hexdocs.pm/req/0.5.17/Req.html"><code class="inline">Req</code></a>.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.Auth</span><span class="w"> </span><span class="k" data-group-id="7614964101-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;Manages Copilot OAuth credentials.&quot;</span><span class="w">

  </span><span class="na">@copilot_headers</span><span class="w"> </span><span class="p" data-group-id="7614964101-2">%{</span><span class="w">
    </span><span class="s">&quot;user-agent&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;GitHubCopilotChat/0.35.0&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;editor-version&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;vscode/1.107.0&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;editor-plugin-version&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;copilot-chat/0.35.0&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;copilot-integration-id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;vscode-chat&quot;</span><span class="w">
  </span><span class="p" data-group-id="7614964101-2">}</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">client_id</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Opal.Config</span><span class="o">.</span><span class="n">copilot</span><span class="p" data-group-id="7614964101-3">(</span><span class="ss">:client_id</span><span class="p" data-group-id="7614964101-3">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">&quot;Iv1.b507a08c87ecfe98&quot;</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">domain</span><span class="p">,</span><span class="w">    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Opal.Config</span><span class="o">.</span><span class="n">copilot</span><span class="p" data-group-id="7614964101-4">(</span><span class="ss">:domain</span><span class="p" data-group-id="7614964101-4">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">&quot;github.com&quot;</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start_device_flow</span><span class="p" data-group-id="7614964101-5">(</span><span class="n">dom</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="n">domain</span><span class="p" data-group-id="7614964101-6">(</span><span class="p" data-group-id="7614964101-6">)</span><span class="p" data-group-id="7614964101-5">)</span><span class="w"> </span><span class="k" data-group-id="7614964101-7">do</span><span class="w">
    </span><span class="nc">Req</span><span class="o">.</span><span class="n">post!</span><span class="p" data-group-id="7614964101-8">(</span><span class="s">&quot;https://</span><span class="si" data-group-id="7614964101-9">#{</span><span class="n">dom</span><span class="si" data-group-id="7614964101-9">}</span><span class="s">/login/device/code&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">json</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7614964101-10">%{</span><span class="ss">client_id</span><span class="p">:</span><span class="w"> </span><span class="n">client_id</span><span class="p" data-group-id="7614964101-11">(</span><span class="p" data-group-id="7614964101-11">)</span><span class="p">,</span><span class="w"> </span><span class="ss">scope</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;read:user&quot;</span><span class="p" data-group-id="7614964101-10">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">headers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7614964101-12">%{</span><span class="s">&quot;accept&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;application/json&quot;</span><span class="p" data-group-id="7614964101-12">}</span><span class="p" data-group-id="7614964101-8">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="7614964101-13">(</span><span class="ss">:body</span><span class="p" data-group-id="7614964101-13">)</span><span class="w">
    </span><span class="c1"># =&gt; %{&quot;device_code&quot; =&gt; ..., &quot;user_code&quot; =&gt; ..., &quot;verification_uri&quot; =&gt; ...}</span><span class="w">
  </span><span class="k" data-group-id="7614964101-7">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">poll_for_token</span><span class="p" data-group-id="7614964101-14">(</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="n">device_code</span><span class="p">,</span><span class="w"> </span><span class="n">interval_ms</span><span class="p" data-group-id="7614964101-14">)</span><span class="w"> </span><span class="k" data-group-id="7614964101-15">do</span><span class="w">
    </span><span class="c1"># Poll with Req, handle &quot;authorization_pending&quot; / &quot;slow_down&quot;</span><span class="w">
    </span><span class="nc">Req</span><span class="o">.</span><span class="n">post!</span><span class="p" data-group-id="7614964101-16">(</span><span class="s">&quot;https://</span><span class="si" data-group-id="7614964101-17">#{</span><span class="n">domain</span><span class="si" data-group-id="7614964101-17">}</span><span class="s">/login/oauth/access_token&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">json</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7614964101-18">%{</span><span class="ss">client_id</span><span class="p">:</span><span class="w"> </span><span class="n">client_id</span><span class="p" data-group-id="7614964101-19">(</span><span class="p" data-group-id="7614964101-19">)</span><span class="p">,</span><span class="w"> </span><span class="ss">device_code</span><span class="p">:</span><span class="w"> </span><span class="n">device_code</span><span class="p">,</span><span class="w">
              </span><span class="ss">grant_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;urn:ietf:params:oauth:grant-type:device_code&quot;</span><span class="p" data-group-id="7614964101-18">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">headers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7614964101-20">%{</span><span class="s">&quot;accept&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;application/json&quot;</span><span class="p" data-group-id="7614964101-20">}</span><span class="p" data-group-id="7614964101-16">)</span><span class="w">
  </span><span class="k" data-group-id="7614964101-15">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">exchange_copilot_token</span><span class="p" data-group-id="7614964101-21">(</span><span class="n">github_token</span><span class="p">,</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="s">&quot;github.com&quot;</span><span class="p" data-group-id="7614964101-21">)</span><span class="w"> </span><span class="k" data-group-id="7614964101-22">do</span><span class="w">
    </span><span class="nc">Req</span><span class="o">.</span><span class="n">get!</span><span class="p" data-group-id="7614964101-23">(</span><span class="s">&quot;https://api.</span><span class="si" data-group-id="7614964101-24">#{</span><span class="n">domain</span><span class="si" data-group-id="7614964101-24">}</span><span class="s">/copilot_internal/v2/token&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">auth</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7614964101-25">{</span><span class="ss">:bearer</span><span class="p">,</span><span class="w"> </span><span class="n">github_token</span><span class="p" data-group-id="7614964101-25">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">headers</span><span class="p">:</span><span class="w"> </span><span class="na">@copilot_headers</span><span class="p" data-group-id="7614964101-23">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="7614964101-26">(</span><span class="ss">:body</span><span class="p" data-group-id="7614964101-26">)</span><span class="w">
    </span><span class="c1"># =&gt; %{&quot;token&quot; =&gt; ..., &quot;expires_at&quot; =&gt; ...}</span><span class="w">
  </span><span class="k" data-group-id="7614964101-22">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_token</span><span class="w"> </span><span class="k" data-group-id="7614964101-27">do</span><span class="w">
    </span><span class="c1"># Load from disk, refresh if expired via exchange_copilot_token/2</span><span class="w">
  </span><span class="k" data-group-id="7614964101-27">end</span><span class="w">
</span><span class="k" data-group-id="7614964101-1">end</span></code></pre><p><strong>Request Format — OpenAI Responses API (streaming via Req):</strong></p><p>The key insight: <a href="https://hexdocs.pm/req/0.5.17/Req.html#post!/2"><code class="inline">Req.post!/2</code></a> with <code class="inline">into: :self</code> streams SSE chunks directly
into the calling process's mailbox — perfect for a GenServer. The provider
process receives raw SSE data as messages, parses them with
<a href="https://hexdocs.pm/req/0.5.17/Req.html#parse_message/2"><code class="inline">Req.parse_message/2</code></a>, and dispatches events.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.Provider.Copilot</span><span class="w"> </span><span class="k" data-group-id="1400122141-1">do</span><span class="w">
  </span><span class="na">@behaviour</span><span class="w"> </span><span class="nc">Opal.Provider</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">stream</span><span class="p" data-group-id="1400122141-2">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="1400122141-2">)</span><span class="w"> </span><span class="k" data-group-id="1400122141-3">do</span><span class="w">
    </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Auth</span><span class="o">.</span><span class="n">get_token</span><span class="p" data-group-id="1400122141-4">(</span><span class="p" data-group-id="1400122141-4">)</span><span class="w">
    </span><span class="n">base_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Auth</span><span class="o">.</span><span class="n">base_url</span><span class="p" data-group-id="1400122141-5">(</span><span class="n">token</span><span class="p" data-group-id="1400122141-5">)</span><span class="w">
    </span><span class="n">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">convert_messages</span><span class="p" data-group-id="1400122141-6">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p" data-group-id="1400122141-6">)</span><span class="w">

    </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Req</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="1400122141-7">(</span><span class="w">
      </span><span class="ss">base_url</span><span class="p">:</span><span class="w"> </span><span class="n">base_url</span><span class="p">,</span><span class="w">
      </span><span class="ss">auth</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1400122141-8">{</span><span class="ss">:bearer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p" data-group-id="1400122141-8">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">headers</span><span class="p">:</span><span class="w"> </span><span class="n">copilot_headers</span><span class="p" data-group-id="1400122141-9">(</span><span class="n">context</span><span class="p" data-group-id="1400122141-9">)</span><span class="w">
    </span><span class="p" data-group-id="1400122141-7">)</span><span class="w">

    </span><span class="c1"># into: :self streams SSE into the GenServer mailbox</span><span class="w">
    </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Req</span><span class="o">.</span><span class="n">post!</span><span class="p" data-group-id="1400122141-10">(</span><span class="n">req</span><span class="p">,</span><span class="w">
      </span><span class="ss">url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/v1/responses&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">json</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1400122141-11">%{</span><span class="w">
        </span><span class="ss">model</span><span class="p">:</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w">
        </span><span class="ss">input</span><span class="p">:</span><span class="w"> </span><span class="n">messages</span><span class="p">,</span><span class="w">
        </span><span class="ss">stream</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w">
        </span><span class="ss">store</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w">
        </span><span class="ss">tools</span><span class="p">:</span><span class="w"> </span><span class="n">convert_tools</span><span class="p" data-group-id="1400122141-12">(</span><span class="n">context</span><span class="o">.</span><span class="n">tools</span><span class="p" data-group-id="1400122141-12">)</span><span class="w">
      </span><span class="p" data-group-id="1400122141-11">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">into</span><span class="p">:</span><span class="w"> </span><span class="ss">:self</span><span class="w">
    </span><span class="p" data-group-id="1400122141-10">)</span><span class="w">

    </span><span class="p" data-group-id="1400122141-13">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">resp</span><span class="p" data-group-id="1400122141-13">}</span><span class="w">  </span><span class="c1"># caller iterates via Req.parse_message/2 or Enum</span><span class="w">
  </span><span class="k" data-group-id="1400122141-3">end</span><span class="w">
</span><span class="k" data-group-id="1400122141-1">end</span></code></pre><p>In the <a href="Opal.Agent.html"><code class="inline">Opal.Agent</code></a> GenServer, incoming stream chunks arrive as regular
messages handled in <code class="inline">handle_info/2</code>:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># In Opal.Agent</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0405122554-1">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0405122554-2">%{</span><span class="ss">streaming_resp</span><span class="p">:</span><span class="w"> </span><span class="n">resp</span><span class="p" data-group-id="0405122554-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0405122554-1">)</span><span class="w"> </span><span class="k" data-group-id="0405122554-3">do</span><span class="w">
  </span><span class="k">case</span><span class="w"> </span><span class="nc">Req</span><span class="o">.</span><span class="n">parse_message</span><span class="p" data-group-id="0405122554-4">(</span><span class="n">resp</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="0405122554-4">)</span><span class="w"> </span><span class="k" data-group-id="0405122554-5">do</span><span class="w">
    </span><span class="p" data-group-id="0405122554-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0405122554-7">[</span><span class="p" data-group-id="0405122554-8">{</span><span class="ss">:data</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="0405122554-8">}</span><span class="p" data-group-id="0405122554-7">]</span><span class="p" data-group-id="0405122554-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">data</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">parse_sse_line</span><span class="p" data-group-id="0405122554-9">(</span><span class="p" data-group-id="0405122554-9">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">dispatch_event</span><span class="p" data-group-id="0405122554-10">(</span><span class="n">state</span><span class="p" data-group-id="0405122554-10">)</span><span class="w">

    </span><span class="p" data-group-id="0405122554-11">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0405122554-12">[</span><span class="ss">:done</span><span class="p" data-group-id="0405122554-12">]</span><span class="p" data-group-id="0405122554-11">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">finalize_response</span><span class="p" data-group-id="0405122554-13">(</span><span class="n">state</span><span class="p" data-group-id="0405122554-13">)</span><span class="w">

    </span><span class="p" data-group-id="0405122554-14">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="0405122554-14">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">handle_stream_error</span><span class="p" data-group-id="0405122554-15">(</span><span class="n">reason</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0405122554-15">)</span><span class="w">

    </span><span class="ss">:unknown</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="0405122554-16">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0405122554-16">}</span><span class="w">
  </span><span class="k" data-group-id="0405122554-5">end</span><span class="w">
</span><span class="k" data-group-id="0405122554-3">end</span></code></pre><p><strong>Copilot-specific headers</strong> (set via <a href="https://hexdocs.pm/req/0.5.17/Req.html#new/1"><code class="inline">Req.new/1</code></a> <code class="inline">:headers</code>):</p><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">copilot_headers</span><span class="p" data-group-id="6792737877-1">(</span><span class="n">context</span><span class="p" data-group-id="6792737877-1">)</span><span class="w"> </span><span class="k" data-group-id="6792737877-2">do</span><span class="w">
  </span><span class="n">last_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">messages</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">last</span><span class="p" data-group-id="6792737877-3">(</span><span class="p" data-group-id="6792737877-3">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="6792737877-4">(</span><span class="ss">:role</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p" data-group-id="6792737877-4">)</span><span class="w">
  </span><span class="p" data-group-id="6792737877-5">%{</span><span class="w">
    </span><span class="s">&quot;user-agent&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;GitHubCopilotChat/0.35.0&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;editor-version&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;vscode/1.107.0&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;editor-plugin-version&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;copilot-chat/0.35.0&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;copilot-integration-id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;vscode-chat&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;openai-intent&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;conversation-edits&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;x-initiator&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="p" data-group-id="6792737877-6">(</span><span class="n">last_role</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;agent&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p" data-group-id="6792737877-6">)</span><span class="w">
  </span><span class="p" data-group-id="6792737877-5">}</span><span class="w">
</span><span class="k" data-group-id="6792737877-2">end</span></code></pre><p><strong>Streaming SSE events</strong> to handle (from <code class="inline">processResponsesStream</code>):</p><table><thead><tr><th style="text-align: left;">Event</th><th style="text-align: left;">What to do</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">response.output_item.added</code> (type: <code class="inline">reasoning</code>)</td><td style="text-align: left;">Push <code class="inline">{:thinking_start, ...}</code></td></tr><tr><td style="text-align: left;"><code class="inline">response.reasoning_summary_text.delta</code></td><td style="text-align: left;">Accumulate thinking text, push <code class="inline">{:thinking_delta, ...}</code></td></tr><tr><td style="text-align: left;"><code class="inline">response.output_item.added</code> (type: <code class="inline">message</code>)</td><td style="text-align: left;">Push <code class="inline">{:text_start, ...}</code></td></tr><tr><td style="text-align: left;"><code class="inline">response.output_text.delta</code></td><td style="text-align: left;">Accumulate text, push <code class="inline">{:message_delta, ...}</code></td></tr><tr><td style="text-align: left;"><code class="inline">response.output_item.added</code> (type: <code class="inline">function_call</code>)</td><td style="text-align: left;">Push <code class="inline">{:tool_call_start, ...}</code></td></tr><tr><td style="text-align: left;"><code class="inline">response.function_call_arguments.delta</code></td><td style="text-align: left;">Accumulate JSON args, push <code class="inline">{:tool_call_delta, ...}</code></td></tr><tr><td style="text-align: left;"><code class="inline">response.function_call_arguments.done</code></td><td style="text-align: left;">Parse final JSON args</td></tr><tr><td style="text-align: left;"><code class="inline">response.output_item.done</code> (type: <code class="inline">function_call</code>)</td><td style="text-align: left;">Emit complete <code class="inline">ToolCall</code> struct</td></tr><tr><td style="text-align: left;"><code class="inline">response.completed</code></td><td style="text-align: left;">Extract usage stats, determine stop reason</td></tr><tr><td style="text-align: left;"><code class="inline">error</code> / <code class="inline">response.failed</code></td><td style="text-align: left;">Emit error event</td></tr></tbody></table><p><strong>Message conversion</strong> (internal → Responses API input):</p><ul><li>User messages → <code class="inline">%{role: &quot;user&quot;, content: [%{type: &quot;input_text&quot;, text: ...}]}</code></li><li>Assistant text → <code class="inline">%{type: &quot;message&quot;, role: &quot;assistant&quot;, content: [%{type: &quot;output_text&quot;, text: ...}], ...}</code></li><li>Tool calls → <code class="inline">%{type: &quot;function_call&quot;, call_id: ..., name: ..., arguments: ...}</code></li><li>Tool results → <code class="inline">%{type: &quot;function_call_output&quot;, call_id: ..., output: ...}</code></li><li>System prompt → <code class="inline">%{role: &quot;developer&quot;, content: ...}</code> (for reasoning models)
or <code class="inline">%{role: &quot;system&quot;, content: ...}</code> (otherwise)</li></ul><p><strong>Tool conversion:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">def</span><span class="w"> </span><span class="nf">convert_tools</span><span class="p" data-group-id="6829165241-1">(</span><span class="n">tools</span><span class="p" data-group-id="6829165241-1">)</span><span class="w"> </span><span class="k" data-group-id="6829165241-2">do</span><span class="w">
  </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="6829165241-3">(</span><span class="n">tools</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="6829165241-4">fn</span><span class="w"> </span><span class="n">tool</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="6829165241-5">%{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;function&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="p" data-group-id="6829165241-6">(</span><span class="p" data-group-id="6829165241-6">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="n">tool</span><span class="o">.</span><span class="n">description</span><span class="p" data-group-id="6829165241-7">(</span><span class="p" data-group-id="6829165241-7">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">parameters</span><span class="p">:</span><span class="w"> </span><span class="n">tool</span><span class="o">.</span><span class="n">parameters</span><span class="p" data-group-id="6829165241-8">(</span><span class="p" data-group-id="6829165241-8">)</span><span class="p">,</span><span class="w"> </span><span class="ss">strict</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="6829165241-5">}</span><span class="w">
  </span><span class="k" data-group-id="6829165241-4">end</span><span class="p" data-group-id="6829165241-3">)</span><span class="w">
</span><span class="k" data-group-id="6829165241-2">end</span></code></pre><p><strong><a href="Opal.Tool.html"><code class="inline">Opal.Tool</code></a></strong> — Behaviour</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.Tool</span><span class="w"> </span><span class="k" data-group-id="9739401548-1">do</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">name</span><span class="p" data-group-id="9739401548-2">(</span><span class="p" data-group-id="9739401548-2">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="9739401548-3">(</span><span class="p" data-group-id="9739401548-3">)</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">description</span><span class="p" data-group-id="9739401548-4">(</span><span class="p" data-group-id="9739401548-4">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="9739401548-5">(</span><span class="p" data-group-id="9739401548-5">)</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">parameters</span><span class="p" data-group-id="9739401548-6">(</span><span class="p" data-group-id="9739401548-6">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">Opal.Schema</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="9739401548-7">(</span><span class="p" data-group-id="9739401548-7">)</span><span class="w">   </span><span class="c1"># JSON Schema-ish</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">execute</span><span class="p" data-group-id="9739401548-8">(</span><span class="n">args</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">map</span><span class="p" data-group-id="9739401548-9">(</span><span class="p" data-group-id="9739401548-9">)</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">map</span><span class="p" data-group-id="9739401548-10">(</span><span class="p" data-group-id="9739401548-10">)</span><span class="p" data-group-id="9739401548-8">)</span><span class="w"> </span><span class="o">::</span><span class="w">
    </span><span class="p" data-group-id="9739401548-11">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="9739401548-12">(</span><span class="p" data-group-id="9739401548-12">)</span><span class="p" data-group-id="9739401548-11">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="9739401548-13">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="9739401548-14">(</span><span class="p" data-group-id="9739401548-14">)</span><span class="p" data-group-id="9739401548-13">}</span><span class="w">
</span><span class="k" data-group-id="9739401548-1">end</span></code></pre><p>Stage 1 tools:</p><ul><li><a href="Opal.Tool.Read.html"><code class="inline">Opal.Tool.Read</code></a> — read files</li><li><a href="Opal.Tool.Write.html"><code class="inline">Opal.Tool.Write</code></a> — write files</li><li><a href="Opal.Tool.Edit.html"><code class="inline">Opal.Tool.Edit</code></a> — search-and-replace edits</li><li><a href="Opal.Tool.Shell.html"><code class="inline">Opal.Tool.Shell</code></a> — run shell commands (cross-platform)</li></ul><p><strong><a href="Opal.Tool.Shell.html"><code class="inline">Opal.Tool.Shell</code></a></strong> — Cross-platform shell execution</p><p>Pi's <code class="inline">bash</code> tool assumes POSIX. Opal's <code class="inline">Shell</code> tool detects the platform and
acts accordingly:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Internal dispatch:</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="nc">:os</span><span class="o">.</span><span class="n">type</span><span class="p" data-group-id="7375266165-1">(</span><span class="p" data-group-id="7375266165-1">)</span><span class="w"> </span><span class="k" data-group-id="7375266165-2">do</span><span class="w">
  </span><span class="p" data-group-id="7375266165-3">{</span><span class="ss">:unix</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="7375266165-3">}</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">cmd</span><span class="p" data-group-id="7375266165-4">(</span><span class="s">&quot;sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7375266165-5">[</span><span class="s">&quot;-c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p" data-group-id="7375266165-5">]</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="7375266165-4">)</span><span class="w">
  </span><span class="p" data-group-id="7375266165-6">{</span><span class="ss">:win32</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="7375266165-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">cmd</span><span class="p" data-group-id="7375266165-7">(</span><span class="s">&quot;cmd&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7375266165-8">[</span><span class="s">&quot;/C&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p" data-group-id="7375266165-8">]</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="7375266165-7">)</span><span class="w">
</span><span class="k" data-group-id="7375266165-2">end</span></code></pre><p>The tool name exposed to the LLM matches the configured shell (<code class="inline">&quot;shell&quot;</code>,
<code class="inline">&quot;bash&quot;</code>, <code class="inline">&quot;cmd&quot;</code>, <code class="inline">&quot;powershell&quot;</code>, etc.) so the model generates appropriate
syntax. On Windows, commands run via <code class="inline">cmd.exe</code> by default, with an option to
use PowerShell:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># In session config:</span><span class="w">
</span><span class="nc">Opal</span><span class="o">.</span><span class="n">start_session</span><span class="p" data-group-id="9874673980-1">(</span><span class="p" data-group-id="9874673980-2">%{</span><span class="w">
  </span><span class="ss">shell</span><span class="p">:</span><span class="w"> </span><span class="ss">:powershell</span><span class="p">,</span><span class="w">  </span><span class="c1"># :cmd (default on Windows) | :powershell | :sh (default on Unix)</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="p" data-group-id="9874673980-2">}</span><span class="p" data-group-id="9874673980-1">)</span></code></pre><p><strong><a href="Opal.Path.html"><code class="inline">Opal.Path</code></a></strong> — Path normalization</p><p>All internal path handling uses <a href="https://hexdocs.pm/elixir/Path.html"><code class="inline">Path</code></a> module functions (<a href="https://hexdocs.pm/elixir/Path.html#join/2"><code class="inline">Path.join/2</code></a>,
<a href="https://hexdocs.pm/elixir/Path.html#expand/1"><code class="inline">Path.expand/1</code></a>, <a href="https://hexdocs.pm/elixir/Path.html#relative_to/2"><code class="inline">Path.relative_to/2</code></a>) which are already cross-platform in
Elixir. The working directory and any tool arguments go through normalization:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.Path</span><span class="w"> </span><span class="k" data-group-id="1729747935-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p" data-group-id="1729747935-2">(</span><span class="n">path</span><span class="p" data-group-id="1729747935-2">)</span><span class="w"> </span><span class="k" data-group-id="1729747935-3">do</span><span class="w">
    </span><span class="n">path</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">replace</span><span class="p" data-group-id="1729747935-4">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p" data-group-id="1729747935-4">)</span><span class="w">   </span><span class="c1"># normalize separators for internal use</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">expand</span><span class="p" data-group-id="1729747935-5">(</span><span class="p" data-group-id="1729747935-5">)</span><span class="w">
  </span><span class="k" data-group-id="1729747935-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">to_native</span><span class="p" data-group-id="1729747935-6">(</span><span class="n">path</span><span class="p" data-group-id="1729747935-6">)</span><span class="w"> </span><span class="k" data-group-id="1729747935-7">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">:os</span><span class="o">.</span><span class="n">type</span><span class="p" data-group-id="1729747935-8">(</span><span class="p" data-group-id="1729747935-8">)</span><span class="w"> </span><span class="k" data-group-id="1729747935-9">do</span><span class="w">
      </span><span class="p" data-group-id="1729747935-10">{</span><span class="ss">:win32</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="1729747935-10">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">replace</span><span class="p" data-group-id="1729747935-11">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p" data-group-id="1729747935-11">)</span><span class="w">
      </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">path</span><span class="w">
    </span><span class="k" data-group-id="1729747935-9">end</span><span class="w">
  </span><span class="k" data-group-id="1729747935-7">end</span><span class="w">
</span><span class="k" data-group-id="1729747935-1">end</span></code></pre><p><strong><a href="Opal.Events.html"><code class="inline">Opal.Events</code></a></strong> — Registry-based pubsub</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Subscribe to all events from a session</span><span class="w">
</span><span class="nc">Opal.Events</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="0186926097-1">(</span><span class="n">session_id</span><span class="p" data-group-id="0186926097-1">)</span><span class="w">

</span><span class="c1"># In your process</span><span class="w">
</span><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="0186926097-2">do</span><span class="w">
  </span><span class="p" data-group-id="0186926097-3">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0186926097-4">{</span><span class="ss">:agent_start</span><span class="p" data-group-id="0186926097-4">}</span><span class="p" data-group-id="0186926097-3">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="0186926097-5">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0186926097-6">{</span><span class="ss">:message_update</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p" data-group-id="0186926097-6">}</span><span class="p" data-group-id="0186926097-5">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="0186926097-7">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0186926097-8">{</span><span class="ss">:tool_execution_start</span><span class="p">,</span><span class="w"> </span><span class="n">tool</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p" data-group-id="0186926097-8">}</span><span class="p" data-group-id="0186926097-7">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="0186926097-9">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0186926097-10">{</span><span class="ss">:tool_execution_end</span><span class="p">,</span><span class="w"> </span><span class="n">tool</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="0186926097-10">}</span><span class="p" data-group-id="0186926097-9">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="0186926097-11">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0186926097-12">{</span><span class="ss">:turn_end</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">tool_results</span><span class="p" data-group-id="0186926097-12">}</span><span class="p" data-group-id="0186926097-11">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="0186926097-13">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0186926097-14">{</span><span class="ss">:agent_end</span><span class="p">,</span><span class="w"> </span><span class="n">messages</span><span class="p" data-group-id="0186926097-14">}</span><span class="p" data-group-id="0186926097-13">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="0186926097-2">end</span></code></pre><p>Any process in the VM can subscribe. Your LiveView, your CLI, your monitoring
dashboard, another agent — they all get the same event stream with zero
serialization overhead.</p><p><strong><a href="Opal.Config.html"><code class="inline">Opal.Config</code></a></strong> — Configuration</p><p>Opal uses Elixir's native application configuration as the foundation. Defaults
are sensible, the host app overrides via <code class="inline">config :opal</code>, and individual sessions
can override further at startup.</p><p><strong>Priority (highest wins):</strong></p><ol><li>Session config — <code class="inline">Opal.start_session(%{data_dir: ..., shell: ..., ...})</code></li><li>Application config — <code class="inline">config :opal, data_dir: &quot;~/.opal&quot;</code></li><li>Environment variables — <code class="inline">OPAL_DATA_DIR</code>, <code class="inline">OPAL_SHELL</code></li><li>Built-in defaults</li></ol><p><strong><code class="inline">config/config.exs</code></strong> (in the host app):</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:opal</span><span class="p">,</span><span class="w">
  </span><span class="ss">data_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;~/.opal&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">shell</span><span class="p">:</span><span class="w"> </span><span class="ss">:zsh</span><span class="p">,</span><span class="w">
  </span><span class="ss">default_model</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9152193058-1">{</span><span class="s">&quot;copilot&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;claude-sonnet-4-5&quot;</span><span class="p" data-group-id="9152193058-1">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">default_tools</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9152193058-2">[</span><span class="nc">Opal.Tool.Read</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Write</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Edit</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Shell</span><span class="p" data-group-id="9152193058-2">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">copilot</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9152193058-3">[</span><span class="w">
    </span><span class="ss">client_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Iv1.b507a08c87ecfe98&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;github.com&quot;</span><span class="w">
  </span><span class="p" data-group-id="9152193058-3">]</span></code></pre><p><strong><code class="inline">config/runtime.exs</code></strong> (for env-var-driven deploys/CI):</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:opal</span><span class="p">,</span><span class="w">
  </span><span class="ss">data_dir</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="5759521788-1">(</span><span class="s">&quot;OPAL_DATA_DIR&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~/.opal&quot;</span><span class="p" data-group-id="5759521788-1">)</span><span class="p">,</span><span class="w">
  </span><span class="ss">shell</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="5759521788-2">(</span><span class="s">&quot;OPAL_SHELL&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sh&quot;</span><span class="p" data-group-id="5759521788-2">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">to_existing_atom</span><span class="p" data-group-id="5759521788-3">(</span><span class="p" data-group-id="5759521788-3">)</span></code></pre><p><strong>Module:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.Config</span><span class="w"> </span><span class="k" data-group-id="6553294686-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Reads Opal configuration from Application env with per-session overrides.
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="na">@defaults</span><span class="w"> </span><span class="p" data-group-id="6553294686-2">%{</span><span class="w">
    </span><span class="ss">data_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;~/.opal&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">shell</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">              </span><span class="c1"># nil = auto-detect per platform</span><span class="w">
    </span><span class="ss">default_model</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6553294686-3">{</span><span class="s">&quot;copilot&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;claude-sonnet-4-5&quot;</span><span class="p" data-group-id="6553294686-3">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">default_tools</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6553294686-4">[</span><span class="nc">Opal.Tool.Read</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Write</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Edit</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Shell</span><span class="p" data-group-id="6553294686-4">]</span><span class="w">
  </span><span class="p" data-group-id="6553294686-2">}</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Get a config value. Session overrides &gt; Application env &gt; defaults.&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get</span><span class="p" data-group-id="6553294686-5">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">session_opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="6553294686-6">%{</span><span class="p" data-group-id="6553294686-6">}</span><span class="p" data-group-id="6553294686-5">)</span><span class="w"> </span><span class="k" data-group-id="6553294686-7">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="6553294686-8">(</span><span class="n">session_opts</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="6553294686-8">)</span><span class="w"> </span><span class="k" data-group-id="6553294686-9">do</span><span class="w">
      </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Application</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="6553294686-10">(</span><span class="ss">:opal</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="6553294686-11">(</span><span class="na">@defaults</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="6553294686-11">)</span><span class="p" data-group-id="6553294686-10">)</span><span class="w">
      </span><span class="n">val</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">val</span><span class="w">
    </span><span class="k" data-group-id="6553294686-9">end</span><span class="w">
  </span><span class="k" data-group-id="6553294686-7">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Resolved data directory (expanded to absolute path).&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">data_dir</span><span class="p" data-group-id="6553294686-12">(</span><span class="n">session_opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="6553294686-13">%{</span><span class="p" data-group-id="6553294686-13">}</span><span class="p" data-group-id="6553294686-12">)</span><span class="p">,</span><span class="w">  </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">get</span><span class="p" data-group-id="6553294686-14">(</span><span class="ss">:data_dir</span><span class="p">,</span><span class="w"> </span><span class="n">session_opts</span><span class="p" data-group-id="6553294686-14">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">expand</span><span class="p" data-group-id="6553294686-15">(</span><span class="p" data-group-id="6553294686-15">)</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">sessions_dir</span><span class="p" data-group-id="6553294686-16">(</span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="6553294686-17">%{</span><span class="p" data-group-id="6553294686-17">}</span><span class="p" data-group-id="6553294686-16">)</span><span class="p">,</span><span class="w">      </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="6553294686-18">(</span><span class="n">data_dir</span><span class="p" data-group-id="6553294686-19">(</span><span class="n">opts</span><span class="p" data-group-id="6553294686-19">)</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sessions&quot;</span><span class="p" data-group-id="6553294686-18">)</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">auth_file</span><span class="p" data-group-id="6553294686-20">(</span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="6553294686-21">%{</span><span class="p" data-group-id="6553294686-21">}</span><span class="p" data-group-id="6553294686-20">)</span><span class="p">,</span><span class="w">         </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="6553294686-22">(</span><span class="n">data_dir</span><span class="p" data-group-id="6553294686-23">(</span><span class="n">opts</span><span class="p" data-group-id="6553294686-23">)</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;auth.json&quot;</span><span class="p" data-group-id="6553294686-22">)</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">logs_dir</span><span class="p" data-group-id="6553294686-24">(</span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="6553294686-25">%{</span><span class="p" data-group-id="6553294686-25">}</span><span class="p" data-group-id="6553294686-24">)</span><span class="p">,</span><span class="w">          </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="6553294686-26">(</span><span class="n">data_dir</span><span class="p" data-group-id="6553294686-27">(</span><span class="n">opts</span><span class="p" data-group-id="6553294686-27">)</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;logs&quot;</span><span class="p" data-group-id="6553294686-26">)</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Resolved shell — session override, app config, or platform default.&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">shell</span><span class="p" data-group-id="6553294686-28">(</span><span class="n">session_opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="6553294686-29">%{</span><span class="p" data-group-id="6553294686-29">}</span><span class="p" data-group-id="6553294686-28">)</span><span class="w"> </span><span class="k" data-group-id="6553294686-30">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">get</span><span class="p" data-group-id="6553294686-31">(</span><span class="ss">:shell</span><span class="p">,</span><span class="w"> </span><span class="n">session_opts</span><span class="p" data-group-id="6553294686-31">)</span><span class="w"> </span><span class="k" data-group-id="6553294686-32">do</span><span class="w">
      </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Opal.Tool.Shell</span><span class="o">.</span><span class="n">default_shell</span><span class="p" data-group-id="6553294686-33">(</span><span class="p" data-group-id="6553294686-33">)</span><span class="w">
      </span><span class="n">shell</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">shell</span><span class="w">
    </span><span class="k" data-group-id="6553294686-32">end</span><span class="w">
  </span><span class="k" data-group-id="6553294686-30">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Ensures the data directory tree exists.&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">ensure_dirs!</span><span class="p" data-group-id="6553294686-34">(</span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="6553294686-35">%{</span><span class="p" data-group-id="6553294686-35">}</span><span class="p" data-group-id="6553294686-34">)</span><span class="w"> </span><span class="k" data-group-id="6553294686-36">do</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p" data-group-id="6553294686-37">[</span><span class="n">data_dir</span><span class="p" data-group-id="6553294686-38">(</span><span class="n">opts</span><span class="p" data-group-id="6553294686-38">)</span><span class="p">,</span><span class="w"> </span><span class="n">sessions_dir</span><span class="p" data-group-id="6553294686-39">(</span><span class="n">opts</span><span class="p" data-group-id="6553294686-39">)</span><span class="p">,</span><span class="w"> </span><span class="n">logs_dir</span><span class="p" data-group-id="6553294686-40">(</span><span class="n">opts</span><span class="p" data-group-id="6553294686-40">)</span><span class="p" data-group-id="6553294686-37">]</span><span class="w"> </span><span class="k" data-group-id="6553294686-41">do</span><span class="w">
      </span><span class="nc">File</span><span class="o">.</span><span class="n">mkdir_p!</span><span class="p" data-group-id="6553294686-42">(</span><span class="n">dir</span><span class="p" data-group-id="6553294686-42">)</span><span class="w">
    </span><span class="k" data-group-id="6553294686-41">end</span><span class="w">
  </span><span class="k" data-group-id="6553294686-36">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;All copilot-specific config.&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">copilot</span><span class="p" data-group-id="6553294686-43">(</span><span class="n">key</span><span class="p" data-group-id="6553294686-43">)</span><span class="w"> </span><span class="k" data-group-id="6553294686-44">do</span><span class="w">
    </span><span class="ss">:opal</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Application</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="6553294686-45">(</span><span class="ss">:copilot</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6553294686-46">[</span><span class="p" data-group-id="6553294686-46">]</span><span class="p" data-group-id="6553294686-45">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="6553294686-47">(</span><span class="n">key</span><span class="p" data-group-id="6553294686-47">)</span><span class="w">
  </span><span class="k" data-group-id="6553294686-44">end</span><span class="w">
</span><span class="k" data-group-id="6553294686-1">end</span></code></pre><p>Directory layout:</p><pre><code class="makeup elixir" translate="no"><span class="err">~</span><span class="o">/</span><span class="o">.</span><span class="n">opal</span><span class="o">/</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">auth</span><span class="o">.</span><span class="n">json</span><span class="w">          </span><span class="c1"># Copilot OAuth tokens</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">sessions</span><span class="o">/</span><span class="w">          </span><span class="c1"># Saved conversation trees</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="o">&lt;</span><span class="n">session</span><span class="o">-</span><span class="n">id</span><span class="o">&gt;</span><span class="o">.</span><span class="n">etf</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">...</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">logs</span><span class="o">/</span><span class="w">              </span><span class="c1"># Agent logs (optional)</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">skills</span><span class="o">/</span><span class="w">            </span><span class="c1"># User-defined skill files (optional)</span></code></pre><p><strong><a href="Opal.html"><code class="inline">Opal</code></a></strong> — Public API / Entry point</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Start a session (returns pid of the session supervisor)</span><span class="w">
</span><span class="c1"># Uses defaults from `config :opal` — override per-session as needed.</span><span class="w">
</span><span class="p" data-group-id="3941374196-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p" data-group-id="3941374196-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">start_session</span><span class="p" data-group-id="3941374196-2">(</span><span class="p" data-group-id="3941374196-3">%{</span><span class="w">
  </span><span class="ss">model</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3941374196-4">{</span><span class="s">&quot;copilot&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;claude-sonnet-4-5&quot;</span><span class="p" data-group-id="3941374196-4">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">system_prompt</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;You are a helpful coding assistant.&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">working_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/to/project&quot;</span><span class="w">
  </span><span class="c1"># tools:    defaults from config :opal, :default_tools</span><span class="w">
  </span><span class="c1"># shell:    defaults from config :opal, :shell (or platform auto-detect)</span><span class="w">
  </span><span class="c1"># data_dir: defaults from config :opal, :data_dir (~/.opal)</span><span class="w">
</span><span class="p" data-group-id="3941374196-3">}</span><span class="p" data-group-id="3941374196-2">)</span><span class="w">

</span><span class="c1"># Send a prompt (async — subscribe to events for output)</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">prompt</span><span class="p" data-group-id="3941374196-5">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;List all Elixir files&quot;</span><span class="p" data-group-id="3941374196-5">)</span><span class="w">

</span><span class="c1"># Or synchronous convenience</span><span class="w">
</span><span class="p" data-group-id="3941374196-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p" data-group-id="3941374196-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">prompt_sync</span><span class="p" data-group-id="3941374196-7">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;What is 2 + 2?&quot;</span><span class="p" data-group-id="3941374196-7">)</span></code></pre><h4>What You Can Do After Stage 1</h4><ul><li>Embed Opal in any Elixir app and have a working coding agent</li><li>Stream LLM output to any subscriber</li><li>Execute tools (file ops + shell)</li><li>Steer the agent mid-run</li><li>Inspect agent state via <code class="inline">:observer</code> or <a href="https://www.erlang.org/doc/apps/stdlib/sys.html#get_state/1"><code class="inline">:sys.get_state/1</code></a></li></ul><h4>Testing the Provider</h4><p><a href="https://hexdocs.pm/req/0.5.17/Req.Test.html"><code class="inline">Req.Test</code></a> lets you plug in a fake adapter so tests never hit the network:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># In test setup:</span><span class="w">
</span><span class="nc">Req.Test</span><span class="o">.</span><span class="n">stub</span><span class="p" data-group-id="7599777748-1">(</span><span class="nc">Opal.Provider.Copilot</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="7599777748-2">fn</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">conn</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Plug.Conn</span><span class="o">.</span><span class="n">put_resp_content_type</span><span class="p" data-group-id="7599777748-3">(</span><span class="s">&quot;text/event-stream&quot;</span><span class="p" data-group-id="7599777748-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Plug.Conn</span><span class="o">.</span><span class="n">send_resp</span><span class="p" data-group-id="7599777748-4">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="n">sse_fixture</span><span class="p" data-group-id="7599777748-5">(</span><span class="s">&quot;simple_response&quot;</span><span class="p" data-group-id="7599777748-5">)</span><span class="p" data-group-id="7599777748-4">)</span><span class="w">
</span><span class="k" data-group-id="7599777748-2">end</span><span class="p" data-group-id="7599777748-1">)</span></code></pre><p>This gives us deterministic, fast tests for the entire SSE parsing and event
dispatch pipeline — no mocking libraries, no network.</p><ul><li>Crash-recover individual sessions without taking down the app</li></ul><hr class="thin"/><h3 id="stage-2-sessions-persistence" class="section-heading"><a href="#stage-2-sessions-persistence" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stage 2 — Sessions &amp; Persistence</span></h3><blockquote><p>Goal: Save and restore conversations. Branch and navigate history.</p></blockquote><p><strong><a href="Opal.Session.html"><code class="inline">Opal.Session</code></a></strong> — GenServer</p><p>Manages the conversation tree. Each message gets an ID and a parent ID, exactly
like Pi's JSONL tree — but backed by ETS for fast in-memory access and optionally
DETS or a file for persistence.</p><pre><code class="makeup elixir" translate="no"><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">save</span><span class="p" data-group-id="1941902541-1">(</span><span class="n">session</span><span class="p" data-group-id="1941902541-1">)</span><span class="w">           </span><span class="c1"># persist current state</span><span class="w">
</span><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">branch</span><span class="p" data-group-id="1941902541-2">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">entry_id</span><span class="p" data-group-id="1941902541-2">)</span><span class="w"> </span><span class="c1"># rewind to a point</span><span class="w">
</span><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">get_tree</span><span class="p" data-group-id="1941902541-3">(</span><span class="n">session</span><span class="p" data-group-id="1941902541-3">)</span><span class="w">       </span><span class="c1"># full tree structure</span><span class="w">
</span><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">get_path</span><span class="p" data-group-id="1941902541-4">(</span><span class="n">session</span><span class="p" data-group-id="1941902541-4">)</span><span class="w">       </span><span class="c1"># root → current leaf</span><span class="w">
</span><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">list_sessions</span><span class="p" data-group-id="1941902541-5">(</span><span class="n">dir</span><span class="p" data-group-id="1941902541-5">)</span><span class="w">      </span><span class="c1"># enumerate saved sessions</span></code></pre><p>Session format: Erlang term storage (<code class="inline">.etf</code>) or JSONL for interop. We don't need
to match Pi's format — we need something that's fast to read/write from the BEAM.</p><p><strong><a href="Opal.Session.Compaction.html"><code class="inline">Opal.Session.Compaction</code></a></strong></p><p>When context gets long, summarize older messages. Same idea as Pi but
implemented as a separate pass that the Agent can trigger:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">compact</span><span class="p" data-group-id="4100302204-1">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="ss">keep_recent</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="4100302204-1">)</span></code></pre><hr class="thin"/><h3 id="stage-3-sub-agents-parallelism" class="section-heading"><a href="#stage-3-sub-agents-parallelism" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stage 3 — Sub-Agents &amp; Parallelism</span></h3><blockquote><p>Goal: Spawn child agents that work in parallel.</p></blockquote><p>This is where OTP shines and Pi explicitly punts. Pi says &quot;spawn tmux sessions&quot;
or &quot;build it with extensions.&quot; We say: <a href="https://hexdocs.pm/elixir/DynamicSupervisor.html#start_child/2"><code class="inline">DynamicSupervisor.start_child/2</code></a>.</p><p><strong><a href="Opal.SubAgent.html"><code class="inline">Opal.SubAgent</code></a></strong></p><p>A sub-agent is just another <a href="Opal.Agent.html"><code class="inline">Opal.Agent</code></a> started under the parent session's
supervisor. It gets its own process, its own message history, its own tool set.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># From within a tool or the parent agent:</span><span class="w">
</span><span class="p" data-group-id="2555217387-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">sub</span><span class="p" data-group-id="2555217387-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.SubAgent</span><span class="o">.</span><span class="n">spawn</span><span class="p" data-group-id="2555217387-2">(</span><span class="n">parent_session</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2555217387-3">%{</span><span class="w">
  </span><span class="ss">system_prompt</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;You are a test-writing specialist.&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">tools</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2555217387-4">[</span><span class="nc">Opal.Tool.Read</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Write</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Shell</span><span class="p" data-group-id="2555217387-4">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">model</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2555217387-5">{</span><span class="s">&quot;copilot&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;claude-haiku-3-5&quot;</span><span class="p" data-group-id="2555217387-5">}</span><span class="w">
</span><span class="p" data-group-id="2555217387-3">}</span><span class="p" data-group-id="2555217387-2">)</span><span class="w">

</span><span class="p" data-group-id="2555217387-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="2555217387-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.SubAgent</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="2555217387-7">(</span><span class="n">sub</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Write tests for lib/opal/agent.ex&quot;</span><span class="p" data-group-id="2555217387-7">)</span></code></pre><p>The parent can spawn N sub-agents in parallel, each working on different files or
tasks. The supervision tree ensures cleanup:</p><pre><code class="makeup elixir" translate="no"><span class="nc">SessionSupervisor</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.Agent</span><span class="w"> </span><span class="p" data-group-id="7770518319-1">(</span><span class="n">parent</span><span class="p" data-group-id="7770518319-1">)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.Session</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.ToolSup</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.SubAgentSup</span><span class="w"> </span><span class="p" data-group-id="7770518319-2">(</span><span class="nc">DynamicSupervisor</span><span class="p" data-group-id="7770518319-2">)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">SubAgent</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.Agent</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.ToolSup</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">SubAgent</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="mi">2</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.Agent</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.ToolSup</span><span class="w">
    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">...</span><span class="w"> </span><span class="nc">N</span><span class="w"> </span><span class="n">agents</span></code></pre><p>If a sub-agent crashes, only that sub-agent restarts. The parent and siblings
are unaffected. If the parent session is torn down, all sub-agents are cleaned
up automatically. This is free from the supervision tree.</p><p><strong>Parallel tool execution</strong></p><p>Even within a single agent turn, Pi executes tool calls sequentially. We can
optionally run independent tool calls concurrently via <code class="inline">Task.async_stream</code>:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># When the LLM returns multiple tool calls in one response:</span><span class="w">
</span><span class="n">tool_calls</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Task</span><span class="o">.</span><span class="n">async_stream</span><span class="p" data-group-id="1694423627-1">(</span><span class="k" data-group-id="1694423627-2">fn</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">execute_tool</span><span class="p" data-group-id="1694423627-3">(</span><span class="n">call</span><span class="p" data-group-id="1694423627-3">)</span><span class="w"> </span><span class="k" data-group-id="1694423627-2">end</span><span class="p">,</span><span class="w"> </span><span class="ss">max_concurrency</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="1694423627-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="1694423627-4">(</span><span class="k" data-group-id="1694423627-5">fn</span><span class="w"> </span><span class="p" data-group-id="1694423627-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="1694423627-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k" data-group-id="1694423627-5">end</span><span class="p" data-group-id="1694423627-4">)</span></code></pre><hr class="thin"/><h3 id="stage-4-context-files-skills" class="section-heading"><a href="#stage-4-context-files-skills" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stage 4 — Context Files &amp; Skills</span></h3><blockquote><p>Goal: Load project context and reusable instruction sets.</p></blockquote><p><strong><a href="Opal.Context.html"><code class="inline">Opal.Context</code></a></strong></p><p>Walk up from <code class="inline">cwd</code>, collect <code class="inline">AGENTS.md</code> / <code class="inline">OPAL.md</code> files, concatenate into the
system prompt. Simple file-system walk, no magic.</p><pre><code class="makeup elixir" translate="no"><span class="n">context_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Context</span><span class="o">.</span><span class="n">discover</span><span class="p" data-group-id="9661415561-1">(</span><span class="n">working_dir</span><span class="p" data-group-id="9661415561-1">)</span><span class="w">
</span><span class="c1"># Returns list of %{path: ..., content: ...}</span></code></pre><p><strong><a href="Opal.Skill.html"><code class="inline">Opal.Skill</code></a></strong> — Behaviour (optional)</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.Skill</span><span class="w"> </span><span class="k" data-group-id="7463191148-1">do</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">name</span><span class="p" data-group-id="7463191148-2">(</span><span class="p" data-group-id="7463191148-2">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="7463191148-3">(</span><span class="p" data-group-id="7463191148-3">)</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">description</span><span class="p" data-group-id="7463191148-4">(</span><span class="p" data-group-id="7463191148-4">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="7463191148-5">(</span><span class="p" data-group-id="7463191148-5">)</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">instructions</span><span class="p" data-group-id="7463191148-6">(</span><span class="p" data-group-id="7463191148-6">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="7463191148-7">(</span><span class="p" data-group-id="7463191148-7">)</span><span class="w">  </span><span class="c1"># Markdown content</span><span class="w">
</span><span class="k" data-group-id="7463191148-1">end</span></code></pre><p>Skills are just modules that provide markdown instructions to append to the
system prompt on demand. No file-system discovery needed — they're Hex packages
or modules in your app.</p><hr class="thin"/><h3 id="stage-5-mcp-client-integration" class="section-heading"><a href="#stage-5-mcp-client-integration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stage 5 — MCP Client Integration</span></h3><blockquote><p>Goal: Connect to external MCP servers and expose their tools to the agent.
Dependency: <a href="https://hexdocs.pm/anubis_mcp"><code class="inline">anubis_mcp</code></a> (~&gt; 0.17)</p></blockquote><p>Opal acts as an MCP <em>host</em> (in MCP terminology). Rather than hand-rolling
JSON-RPC 2.0 framing, transport management, and protocol lifecycle, we lean on
<strong>Anubis MCP</strong> — a mature Elixir SDK that already provides all of this as
supervised processes with a <code class="inline">use Anubis.Client</code> DSL.</p><p>Our job is thin: define one Anubis client module per MCP server, start them
under the session supervisor, discover their tools, and bridge those tools into
the <a href="Opal.Tool.html"><code class="inline">Opal.Tool</code></a> interface so the agent can't tell the difference.</p><h4>What Anubis Gives Us (for free)</h4><table><thead><tr><th style="text-align: left;">Concern</th><th style="text-align: left;">Anubis handles it</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Transports</strong></td><td style="text-align: left;"><code class="inline">:stdio</code>, <code class="inline">:streamable_http</code>, <code class="inline">:websocket</code>, <code class="inline">:sse</code> — all built-in</td></tr><tr><td style="text-align: left;"><strong>Lifecycle</strong></td><td style="text-align: left;"><code class="inline">initialize</code> → capability negotiation → <code class="inline">notifications/initialized</code></td></tr><tr><td style="text-align: left;"><strong>Tool ops</strong></td><td style="text-align: left;"><code class="inline">list_tools/0</code>, <code class="inline">call_tool/2,3</code>, progress callbacks, timeouts</td></tr><tr><td style="text-align: left;"><strong>Resource ops</strong></td><td style="text-align: left;"><code class="inline">list_resources/0</code>, <code class="inline">read_resource/1</code></td></tr><tr><td style="text-align: left;"><strong>Supervision</strong></td><td style="text-align: left;">Each client is a child spec, drops into any supervisor tree</td></tr><tr><td style="text-align: left;"><strong>Named instances</strong></td><td style="text-align: left;"><a href="https://hexdocs.pm/elixir/Supervisor.html#child_spec/2"><code class="inline">Supervisor.child_spec/2</code></a> with <code class="inline">id:</code> for multiple servers</td></tr><tr><td style="text-align: left;"><strong>Protocol</strong></td><td style="text-align: left;">JSON-RPC 2.0 framing, message validation via Peri schemas</td></tr></tbody></table><p>This means we write <em>zero</em> transport code and <em>zero</em> protocol code.</p><h4>Architecture</h4><pre><code class="makeup elixir" translate="no"><span class="nc">SessionSupervisor</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.Agent</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.Session</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.ToolSup</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.MCP.Supervisor</span><span class="w">          </span><span class="p" data-group-id="6499316233-1">(</span><span class="n">plain</span><span class="w"> </span><span class="nc">Supervisor</span><span class="p">,</span><span class="w"> </span><span class="n">one_for_one</span><span class="p" data-group-id="6499316233-1">)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.MCP.Client</span><span class="w"> </span><span class="ss">:fs</span><span class="w">       </span><span class="p" data-group-id="6499316233-2">(</span><span class="nc">Anubis.Client</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="n">stdio</span><span class="p" data-group-id="6499316233-2">)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Opal.MCP.Client</span><span class="w"> </span><span class="ss">:sentry</span><span class="w">   </span><span class="p" data-group-id="6499316233-3">(</span><span class="nc">Anubis.Client</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="n">streamable_http</span><span class="p" data-group-id="6499316233-3">)</span><span class="w">
    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">...</span></code></pre><p><strong><a href="Opal.MCP.Client.html"><code class="inline">Opal.MCP.Client</code></a></strong> — dynamic Anubis client module</p><p>We generate one <code class="inline">use Anubis.Client</code> module per configured MCP server at
runtime. Each module is a supervised GenServer that Anubis manages internally.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.MCP.Client</span><span class="w"> </span><span class="k" data-group-id="4320355571-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Dynamically defines and starts an Anubis MCP client for each
  configured MCP server.
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Anubis.Client</span><span class="p">,</span><span class="w">
    </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Opal&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0.1.0&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">protocol_version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2025-03-26&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">capabilities</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4320355571-2">[</span><span class="ss">:roots</span><span class="p" data-group-id="4320355571-2">]</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Build a child spec for a named MCP server connection.
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">child_spec</span><span class="p" data-group-id="4320355571-3">(</span><span class="p" data-group-id="4320355571-4">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="n">server_name</span><span class="p">,</span><span class="w"> </span><span class="ss">transport</span><span class="p">:</span><span class="w"> </span><span class="n">transport_config</span><span class="p" data-group-id="4320355571-4">}</span><span class="p" data-group-id="4320355571-3">)</span><span class="w"> </span><span class="k" data-group-id="4320355571-5">do</span><span class="w">
    </span><span class="nc">Supervisor</span><span class="o">.</span><span class="n">child_spec</span><span class="p" data-group-id="4320355571-6">(</span><span class="w">
      </span><span class="p" data-group-id="4320355571-7">{</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="ss">transport</span><span class="p">:</span><span class="w"> </span><span class="n">transport_config</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="n">server_name</span><span class="p" data-group-id="4320355571-7">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4320355571-8">{</span><span class="ss">:mcp</span><span class="p">,</span><span class="w"> </span><span class="n">server_name</span><span class="p" data-group-id="4320355571-8">}</span><span class="w">
    </span><span class="p" data-group-id="4320355571-6">)</span><span class="w">
  </span><span class="k" data-group-id="4320355571-5">end</span><span class="w">
</span><span class="k" data-group-id="4320355571-1">end</span></code></pre><p><strong><a href="Opal.MCP.Supervisor.html"><code class="inline">Opal.MCP.Supervisor</code></a></strong> — plain Supervisor</p><p>Starts one <a href="Opal.MCP.Client.html"><code class="inline">Opal.MCP.Client</code></a> child per configured server.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.MCP.Supervisor</span><span class="w"> </span><span class="k" data-group-id="0541671557-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Supervisor</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start_link</span><span class="p" data-group-id="0541671557-2">(</span><span class="n">mcp_servers</span><span class="p" data-group-id="0541671557-2">)</span><span class="w"> </span><span class="k" data-group-id="0541671557-3">do</span><span class="w">
    </span><span class="nc">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="0541671557-4">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">mcp_servers</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="bp">__MODULE__</span><span class="p" data-group-id="0541671557-4">)</span><span class="w">
  </span><span class="k" data-group-id="0541671557-3">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="0541671557-5">(</span><span class="n">mcp_servers</span><span class="p" data-group-id="0541671557-5">)</span><span class="w"> </span><span class="k" data-group-id="0541671557-6">do</span><span class="w">
    </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="0541671557-7">(</span><span class="n">mcp_servers</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nc">Opal.MCP.Client</span><span class="o">.</span><span class="n">child_spec</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="0541671557-7">)</span><span class="w">
    </span><span class="nc">Supervisor</span><span class="o">.</span><span class="n">init</span><span class="p" data-group-id="0541671557-8">(</span><span class="n">children</span><span class="p">,</span><span class="w"> </span><span class="ss">strategy</span><span class="p">:</span><span class="w"> </span><span class="ss">:one_for_one</span><span class="p" data-group-id="0541671557-8">)</span><span class="w">
  </span><span class="k" data-group-id="0541671557-6">end</span><span class="w">
</span><span class="k" data-group-id="0541671557-1">end</span></code></pre><p><strong><a href="Opal.MCP.Bridge.html"><code class="inline">Opal.MCP.Bridge</code></a></strong> — tool bridge</p><p>After each Anubis client connects, <code class="inline">Bridge</code> calls <code class="inline">list_tools/0</code> on the
client and wraps each discovered MCP tool into the <a href="Opal.Tool.html"><code class="inline">Opal.Tool</code></a> format that
the agent already understands. No new behaviour needed — just a data
transformation.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.MCP.Bridge</span><span class="w"> </span><span class="k" data-group-id="5561993461-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Discovers tools from connected Anubis clients and presents them
  as Opal-compatible tool definitions for the agent&#39;s tool list.
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Given a named MCP client, return a list of Opal tool maps.
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">discover_tools</span><span class="p" data-group-id="5561993461-2">(</span><span class="n">client_name</span><span class="p" data-group-id="5561993461-2">)</span><span class="w"> </span><span class="k" data-group-id="5561993461-3">do</span><span class="w">
    </span><span class="p" data-group-id="5561993461-4">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5561993461-5">%{</span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5561993461-6">%{</span><span class="s">&quot;tools&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">tools</span><span class="p" data-group-id="5561993461-6">}</span><span class="p" data-group-id="5561993461-5">}</span><span class="p" data-group-id="5561993461-4">}</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">Opal.MCP.Client</span><span class="o">.</span><span class="n">list_tools</span><span class="p" data-group-id="5561993461-7">(</span><span class="n">client_name</span><span class="p" data-group-id="5561993461-7">)</span><span class="w">

    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="5561993461-8">(</span><span class="n">tools</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="5561993461-9">fn</span><span class="w"> </span><span class="n">tool</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="5561993461-10">%{</span><span class="w">
        </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mcp__</span><span class="si" data-group-id="5561993461-11">#{</span><span class="n">client_name</span><span class="si" data-group-id="5561993461-11">}</span><span class="s">__</span><span class="si" data-group-id="5561993461-12">#{</span><span class="n">tool</span><span class="p" data-group-id="5561993461-13">[</span><span class="s">&quot;name&quot;</span><span class="p" data-group-id="5561993461-13">]</span><span class="si" data-group-id="5561993461-12">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w">
        </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="n">tool</span><span class="p" data-group-id="5561993461-14">[</span><span class="s">&quot;description&quot;</span><span class="p" data-group-id="5561993461-14">]</span><span class="p">,</span><span class="w">
        </span><span class="ss">parameters</span><span class="p">:</span><span class="w"> </span><span class="n">tool</span><span class="p" data-group-id="5561993461-15">[</span><span class="s">&quot;inputSchema&quot;</span><span class="p" data-group-id="5561993461-15">]</span><span class="p">,</span><span class="w">
        </span><span class="ss">execute</span><span class="p">:</span><span class="w"> </span><span class="k" data-group-id="5561993461-16">fn</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="k">case</span><span class="w"> </span><span class="nc">Opal.MCP.Client</span><span class="o">.</span><span class="n">call_tool</span><span class="p" data-group-id="5561993461-17">(</span><span class="n">client_name</span><span class="p">,</span><span class="w"> </span><span class="n">tool</span><span class="p" data-group-id="5561993461-18">[</span><span class="s">&quot;name&quot;</span><span class="p" data-group-id="5561993461-18">]</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p" data-group-id="5561993461-17">)</span><span class="w"> </span><span class="k" data-group-id="5561993461-19">do</span><span class="w">
            </span><span class="p" data-group-id="5561993461-20">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5561993461-21">%{</span><span class="ss">is_error</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="5561993461-21">}</span><span class="p" data-group-id="5561993461-20">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="5561993461-22">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="5561993461-22">}</span><span class="w">
            </span><span class="p" data-group-id="5561993461-23">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5561993461-24">%{</span><span class="ss">is_error</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="n">err</span><span class="p" data-group-id="5561993461-24">}</span><span class="p" data-group-id="5561993461-23">}</span><span class="w">     </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="5561993461-25">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p" data-group-id="5561993461-25">}</span><span class="w">
            </span><span class="p" data-group-id="5561993461-26">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="5561993461-26">}</span><span class="w">                          </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="5561993461-27">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="5561993461-27">}</span><span class="w">
          </span><span class="k" data-group-id="5561993461-19">end</span><span class="w">
        </span><span class="k" data-group-id="5561993461-16">end</span><span class="w">
      </span><span class="p" data-group-id="5561993461-10">}</span><span class="w">
    </span><span class="k" data-group-id="5561993461-9">end</span><span class="p" data-group-id="5561993461-8">)</span><span class="w">
  </span><span class="k" data-group-id="5561993461-3">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Discover tools from all running MCP clients.
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">discover_all_tools</span><span class="p" data-group-id="5561993461-28">(</span><span class="n">mcp_servers</span><span class="p" data-group-id="5561993461-28">)</span><span class="w"> </span><span class="k" data-group-id="5561993461-29">do</span><span class="w">
    </span><span class="n">mcp_servers</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">flat_map</span><span class="p" data-group-id="5561993461-30">(</span><span class="k" data-group-id="5561993461-31">fn</span><span class="w"> </span><span class="p" data-group-id="5561993461-32">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="n">name</span><span class="p" data-group-id="5561993461-32">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">discover_tools</span><span class="p" data-group-id="5561993461-33">(</span><span class="n">name</span><span class="p" data-group-id="5561993461-33">)</span><span class="w"> </span><span class="k" data-group-id="5561993461-31">end</span><span class="p" data-group-id="5561993461-30">)</span><span class="w">
  </span><span class="k" data-group-id="5561993461-29">end</span><span class="w">
</span><span class="k" data-group-id="5561993461-1">end</span></code></pre><p>Tool names are namespaced as <code class="inline">mcp__&lt;server&gt;__&lt;tool&gt;</code> to avoid collisions with
native <a href="Opal.Tool.html"><code class="inline">Opal.Tool</code></a> modules (e.g. <code class="inline">mcp__sentry__search_issues</code>).</p><p><strong><a href="Opal.MCP.Resources.html"><code class="inline">Opal.MCP.Resources</code></a></strong> — resource injection</p><p>Same pattern for resources — discover them via <code class="inline">list_resources/0</code> and
<code class="inline">read_resource/1</code>, then inject their contents into the agent's context.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.MCP.Resources</span><span class="w"> </span><span class="k" data-group-id="2410243413-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">list</span><span class="p" data-group-id="2410243413-2">(</span><span class="n">client_name</span><span class="p" data-group-id="2410243413-2">)</span><span class="w"> </span><span class="k" data-group-id="2410243413-3">do</span><span class="w">
    </span><span class="p" data-group-id="2410243413-4">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2410243413-5">%{</span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2410243413-6">%{</span><span class="s">&quot;resources&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">resources</span><span class="p" data-group-id="2410243413-6">}</span><span class="p" data-group-id="2410243413-5">}</span><span class="p" data-group-id="2410243413-4">}</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">Opal.MCP.Client</span><span class="o">.</span><span class="n">list_resources</span><span class="p" data-group-id="2410243413-7">(</span><span class="n">client_name</span><span class="p" data-group-id="2410243413-7">)</span><span class="w">
    </span><span class="n">resources</span><span class="w">
  </span><span class="k" data-group-id="2410243413-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">read</span><span class="p" data-group-id="2410243413-8">(</span><span class="n">client_name</span><span class="p">,</span><span class="w"> </span><span class="n">uri</span><span class="p" data-group-id="2410243413-8">)</span><span class="w"> </span><span class="k" data-group-id="2410243413-9">do</span><span class="w">
    </span><span class="p" data-group-id="2410243413-10">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2410243413-11">%{</span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2410243413-12">%{</span><span class="s">&quot;contents&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">contents</span><span class="p" data-group-id="2410243413-12">}</span><span class="p" data-group-id="2410243413-11">}</span><span class="p" data-group-id="2410243413-10">}</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">Opal.MCP.Client</span><span class="o">.</span><span class="n">read_resource</span><span class="p" data-group-id="2410243413-13">(</span><span class="n">client_name</span><span class="p">,</span><span class="w"> </span><span class="n">uri</span><span class="p" data-group-id="2410243413-13">)</span><span class="w">
    </span><span class="n">contents</span><span class="w">
  </span><span class="k" data-group-id="2410243413-9">end</span><span class="w">
</span><span class="k" data-group-id="2410243413-1">end</span></code></pre><h4>Session configuration</h4><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="5932022114-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p" data-group-id="5932022114-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">start_session</span><span class="p" data-group-id="5932022114-2">(</span><span class="p" data-group-id="5932022114-3">%{</span><span class="w">
  </span><span class="ss">model</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5932022114-4">{</span><span class="s">&quot;copilot&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;claude-sonnet-4-5&quot;</span><span class="p" data-group-id="5932022114-4">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">tools</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5932022114-5">[</span><span class="nc">Opal.Tool.Read</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Write</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Edit</span><span class="p">,</span><span class="w"> </span><span class="nc">Opal.Tool.Shell</span><span class="p" data-group-id="5932022114-5">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">mcp_servers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5932022114-6">[</span><span class="w">
    </span><span class="p" data-group-id="5932022114-7">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="ss">:filesystem</span><span class="p">,</span><span class="w">
      </span><span class="ss">transport</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5932022114-8">{</span><span class="ss">:stdio</span><span class="p">,</span><span class="w"> </span><span class="ss">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;npx&quot;</span><span class="p">,</span><span class="w">
                  </span><span class="ss">args</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5932022114-9">[</span><span class="s">&quot;-y&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;@modelcontextprotocol/server-filesystem&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/path&quot;</span><span class="p" data-group-id="5932022114-9">]</span><span class="p" data-group-id="5932022114-8">}</span><span class="p" data-group-id="5932022114-7">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5932022114-10">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="ss">:sentry</span><span class="p">,</span><span class="w">
      </span><span class="ss">transport</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5932022114-11">{</span><span class="ss">:streamable_http</span><span class="p">,</span><span class="w">
                  </span><span class="ss">base_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://mcp.sentry.dev&quot;</span><span class="p">,</span><span class="w">
                  </span><span class="ss">headers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5932022114-12">[</span><span class="p" data-group-id="5932022114-13">{</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bearer ...&quot;</span><span class="p" data-group-id="5932022114-13">}</span><span class="p" data-group-id="5932022114-12">]</span><span class="p" data-group-id="5932022114-11">}</span><span class="p" data-group-id="5932022114-10">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5932022114-14">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="ss">:db</span><span class="p">,</span><span class="w">
      </span><span class="ss">transport</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5932022114-15">{</span><span class="ss">:stdio</span><span class="p">,</span><span class="w"> </span><span class="ss">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">args</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5932022114-16">[</span><span class="s">&quot;db_server.py&quot;</span><span class="p" data-group-id="5932022114-16">]</span><span class="p" data-group-id="5932022114-15">}</span><span class="p" data-group-id="5932022114-14">}</span><span class="w">
  </span><span class="p" data-group-id="5932022114-6">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">system_prompt</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;You are a helpful coding assistant.&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">working_dir</span><span class="p">:</span><span class="w"> </span><span class="nc">File</span><span class="o">.</span><span class="n">cwd!</span><span class="p" data-group-id="5932022114-17">(</span><span class="p" data-group-id="5932022114-17">)</span><span class="w">
</span><span class="p" data-group-id="5932022114-3">}</span><span class="p" data-group-id="5932022114-2">)</span></code></pre><p>On session start, <a href="Opal.MCP.Supervisor.html"><code class="inline">Opal.MCP.Supervisor</code></a> launches one Anubis client per entry.
Each client connects, negotiates, and is ready. Then <a href="Opal.MCP.Bridge.html"><code class="inline">Opal.MCP.Bridge</code></a> walks
all clients, discovers their tools, and merges them into the agent's flat tool
list. The agent loop calls MCP tools the same way it calls native tools — the
bridge closure routes the call through Anubis.</p><h4>Why Anubis + OTP supervision?</h4><table><thead><tr><th style="text-align: left;">Concern</th><th style="text-align: left;">How it works</th></tr></thead><tbody><tr><td style="text-align: left;">MCP server crashes</td><td style="text-align: left;">Anubis client process dies, supervisor restarts it, Anubis re-negotiates automatically</td></tr><tr><td style="text-align: left;">Slow MCP server</td><td style="text-align: left;"><code class="inline">call_tool/3</code> supports <code class="inline">:timeout</code> option; doesn't block other tools</td></tr><tr><td style="text-align: left;">Multiple servers</td><td style="text-align: left;">Each is an independent child — parallel startup, independent failure domains</td></tr><tr><td style="text-align: left;">Cleanup</td><td style="text-align: left;">Session supervisor shutdown cascades through <a href="Opal.MCP.Supervisor.html"><code class="inline">Opal.MCP.Supervisor</code></a> to all Anubis clients, each calls <code class="inline">close/0</code></td></tr><tr><td style="text-align: left;">Transport choice</td><td style="text-align: left;">Config-driven — swap <code class="inline">:stdio</code> for <code class="inline">:streamable_http</code> without code changes</td></tr><tr><td style="text-align: left;">Progress tracking</td><td style="text-align: left;">Anubis built-in <code class="inline">progress:</code> option with token + callback</td></tr></tbody></table><h4>What MCP Gets You</h4><ul><li>Access to the entire MCP server ecosystem (filesystem, databases, Sentry,
GitHub, Slack, etc.) without writing Elixir wrappers for each</li><li>Remote tool execution via HTTP transport — tools on another machine</li><li>Resource injection — MCP servers can provide context (file contents, DB
schemas) that gets appended to the system prompt</li><li>Dynamic tool updates — servers can add/remove tools at runtime via
notifications, and the agent picks them up immediately</li></ul><h4>What We Don't Build</h4><p>Because Anubis handles it:</p><ul><li>❌ JSON-RPC 2.0 framing / message parsing</li><li>❌ Transport implementations (stdio, HTTP, WebSocket, SSE)</li><li>❌ Protocol lifecycle (<code class="inline">initialize</code> / capability negotiation)</li><li>❌ Progress token management</li><li>❌ Message validation schemas</li></ul><hr class="thin"/><h3 id="stage-5-5-rpc-server-headless-mode" class="section-heading"><a href="#stage-5-5-rpc-server-headless-mode" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stage 5.5 — RPC Server (Headless Mode)</span></h3><blockquote><p>Goal: Ship Opal as both a library and a standalone binary that any language
can drive over JSON-RPC 2.0. The <code class="inline">opal --daemon</code> flag activates headless mode
for external clients.</p></blockquote><p><strong>The TUI is now built-in.</strong> The <code class="inline">opal</code> binary defaults to interactive mode
using TermUI (Elm Architecture). Headless JSON-RPC mode is available via
<code class="inline">opal --daemon</code> for external consumers that want to build their own frontends.
The Elixir <code class="inline">mix opal.chat</code> task remains as a debugging utility.</p><h4>Design Decision: JSON-RPC 2.0 over stdio</h4><p>We evaluated gRPC, WebSocket, HTTP+SSE, and custom binary protocols. <strong>JSON-RPC
2.0 over stdio</strong> wins on every axis that matters for the daemon mode:</p><table><thead><tr><th style="text-align: left;">Concern</th><th style="text-align: left;">JSON-RPC stdio</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Proven pattern</strong></td><td style="text-align: left;">Same protocol as LSP and MCP — well-understood, battle-tested</td></tr><tr><td style="text-align: left;"><strong>Distribution</strong></td><td style="text-align: left;"><code class="inline">opal --daemon</code> — no ports, firewall, TLS</td></tr><tr><td style="text-align: left;"><strong>Bidirectional</strong></td><td style="text-align: left;">Both sides send requests + responses (like LSP)</td></tr><tr><td style="text-align: left;"><strong>Streaming</strong></td><td style="text-align: left;">Notifications — no SSE, no WebSocket, no special mechanism</td></tr><tr><td style="text-align: left;"><strong>Cross-platform</strong></td><td style="text-align: left;">stdin/stdout identical on macOS, Linux, Windows</td></tr><tr><td style="text-align: left;"><strong>Self-contained</strong></td><td style="text-align: left;">~200 lines of Elixir — <a href="Opal.RPC.html"><code class="inline">Opal.RPC</code></a> owns the codec, no deps</td></tr><tr><td style="text-align: left;"><strong>Future SDKs</strong></td><td style="text-align: left;">Protocol spec is a markdown doc — any language implements</td></tr><tr><td style="text-align: left;"><strong>TS ecosystem</strong></td><td style="text-align: left;"><code class="inline">vscode-jsonrpc</code> (6M+ downloads/week)</td></tr></tbody></table><p>The one constraint — single client per process — is the <em>correct</em> constraint
for a CLI. One terminal = one agent. If we ever need multi-client (web UI,
IDE extension), we add a WebSocket or HTTP transport behind the same protocol
layer; only the transport changes, the methods stay identical.</p><h4>Protocol Specification</h4><p>The wire format is <strong>newline-delimited JSON</strong> on stdin/stdout. Each message is a
single JSON object followed by <code class="inline">\n</code>. Stderr is reserved for unstructured logs.
This matches the MCP stdio transport convention.</p><h5>Requests (Client → Server)</h5><p>Standard JSON-RPC 2.0 requests with <code class="inline">id</code>, <code class="inline">method</code>, <code class="inline">params</code>:</p><pre><code class="jsonc">// Start or resume a session
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 1, &quot;method&quot;: &quot;session/start&quot;, &quot;params&quot;: {
  &quot;model&quot;: {&quot;provider&quot;: &quot;copilot&quot;, &quot;id&quot;: &quot;claude-sonnet-4-5&quot;},
  &quot;system_prompt&quot;: &quot;You are a helpful coding assistant.&quot;,
  &quot;working_dir&quot;: &quot;/Users/me/project&quot;,
  &quot;tools&quot;: [&quot;read&quot;, &quot;write&quot;, &quot;edit&quot;, &quot;shell&quot;],
  &quot;mcp_servers&quot;: [
    {&quot;name&quot;: &quot;filesystem&quot;, &quot;transport&quot;: {&quot;type&quot;: &quot;stdio&quot;,
      &quot;command&quot;: &quot;npx&quot;, &quot;args&quot;: [&quot;-y&quot;, &quot;@modelcontextprotocol/server-filesystem&quot;, &quot;/path&quot;]}}
  ]
}}
// =&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 1, &quot;result&quot;: {&quot;session_id&quot;: &quot;abc123&quot;}}

// Send a prompt (async — results stream as notifications)
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 2, &quot;method&quot;: &quot;agent/prompt&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;,
  &quot;text&quot;: &quot;List all Elixir files in lib/&quot;
}}
// =&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 2, &quot;result&quot;: {&quot;ok&quot;: true}}

// Steer the agent mid-run
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 3, &quot;method&quot;: &quot;agent/steer&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;,
  &quot;text&quot;: &quot;Actually, focus on test/ instead&quot;
}}

// Abort the current run
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 4, &quot;method&quot;: &quot;agent/abort&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;
}}

// Get agent state
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 5, &quot;method&quot;: &quot;agent/state&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;
}}
// =&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 5, &quot;result&quot;: {&quot;status&quot;: &quot;idle&quot;, &quot;model&quot;: ...}}

// Session management
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 6, &quot;method&quot;: &quot;session/branch&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;, &quot;entry_id&quot;: &quot;msg-42&quot;
}}
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 7, &quot;method&quot;: &quot;session/compact&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;, &quot;keep_recent&quot;: 10
}}
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 8, &quot;method&quot;: &quot;session/list&quot;, &quot;params&quot;: {}}

// Auth
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 9, &quot;method&quot;: &quot;auth/status&quot;, &quot;params&quot;: {}}
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 10, &quot;method&quot;: &quot;auth/login&quot;, &quot;params&quot;: {}}

// Model listing
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 11, &quot;method&quot;: &quot;models/list&quot;, &quot;params&quot;: {}}</code></pre><h5>Notifications (Server → Client)</h5><p>Streaming events are JSON-RPC 2.0 <strong>notifications</strong> (no <code class="inline">id</code> — fire and forget).
These map 1:1 to <a href="Opal.Events.html"><code class="inline">Opal.Events</code></a>:</p><pre><code class="jsonc">// Agent lifecycle
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;agent/event&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;, &quot;type&quot;: &quot;agent_start&quot;
}}

// LLM text streaming (one per token delta)
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;agent/event&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;, &quot;type&quot;: &quot;message_delta&quot;,
  &quot;delta&quot;: &quot;Here are the &quot;
}}

// Thinking/reasoning
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;agent/event&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;, &quot;type&quot;: &quot;thinking_delta&quot;,
  &quot;delta&quot;: &quot;I should list the files...&quot;
}}

// Tool execution
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;agent/event&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;, &quot;type&quot;: &quot;tool_execution_start&quot;,
  &quot;tool&quot;: &quot;shell&quot;, &quot;call_id&quot;: &quot;call_1&quot;,
  &quot;args&quot;: {&quot;command&quot;: &quot;find lib/ -name '*.ex'&quot;}
}}
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;agent/event&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;, &quot;type&quot;: &quot;tool_execution_end&quot;,
  &quot;tool&quot;: &quot;shell&quot;, &quot;call_id&quot;: &quot;call_1&quot;,
  &quot;result&quot;: {&quot;ok&quot;: true, &quot;output&quot;: &quot;lib/opal.ex\nlib/opal/agent.ex\n...&quot;}
}}

// Turn and agent end
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;agent/event&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;, &quot;type&quot;: &quot;turn_end&quot;,
  &quot;message&quot;: &quot;Found 12 Elixir files...&quot;
}}
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;agent/event&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;, &quot;type&quot;: &quot;agent_end&quot;
}}

// Auth flow (device code)
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;auth/device_code&quot;, &quot;params&quot;: {
  &quot;user_code&quot;: &quot;ABCD-1234&quot;,
  &quot;verification_uri&quot;: &quot;https://github.com/login/device&quot;
}}</code></pre><h5>Server → Client Requests (Bidirectional)</h5><p>The server can send requests <em>to</em> the client that require a response. This
is the LSP <code class="inline">window/showMessageRequest</code> pattern — essential for user
confirmation prompts, permission gates, etc.</p><pre><code class="jsonc">// Server asks: &quot;Should I execute this command?&quot;
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: &quot;s2c-1&quot;, &quot;method&quot;: &quot;client/confirm&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;,
  &quot;title&quot;: &quot;Execute shell command?&quot;,
  &quot;message&quot;: &quot;rm -rf node_modules/&quot;,
  &quot;actions&quot;: [&quot;allow&quot;, &quot;deny&quot;, &quot;allow_session&quot;]
}}
// Client responds:
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: &quot;s2c-1&quot;, &quot;result&quot;: {&quot;action&quot;: &quot;allow&quot;}}

// Server asks for user input
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: &quot;s2c-2&quot;, &quot;method&quot;: &quot;client/input&quot;, &quot;params&quot;: {
  &quot;session_id&quot;: &quot;abc123&quot;,
  &quot;prompt&quot;: &quot;Enter your API key:&quot;,
  &quot;sensitive&quot;: true
}}
// Client responds:
{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: &quot;s2c-2&quot;, &quot;result&quot;: {&quot;text&quot;: &quot;sk-...&quot;}}</code></pre><h4>Architecture</h4><pre><code class="makeup elixir" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w">            </span><span class="nc">Daemon</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="p" data-group-id="5567962758-1">(</span><span class="n">opal</span><span class="w"> </span><span class="o">--</span><span class="n">daemon</span><span class="p" data-group-id="5567962758-1">)</span><span class="w">                      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">•</span><span class="w"> </span><span class="nc">Reads</span><span class="w"> </span><span class="nc">JSON</span><span class="o">-</span><span class="nc">RPC</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">stdin</span><span class="w">                      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">•</span><span class="w"> </span><span class="nc">Writes</span><span class="w"> </span><span class="nc">JSON</span><span class="o">-</span><span class="nc">RPC</span><span class="w"> </span><span class="n">responses</span><span class="o">/</span><span class="n">notifications</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">stdout</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">•</span><span class="w"> </span><span class="nc">No</span><span class="w"> </span><span class="nc">TUI</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="n">designed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="n">clients</span><span class="o">/</span><span class="nc">SDKs</span><span class="w">             </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                            </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nc">Opal.RPC.Stdio</span><span class="w"> </span><span class="p" data-group-id="5567962758-2">(</span><span class="nc">GenServer</span><span class="p" data-group-id="5567962758-2">)</span><span class="w">                           </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nc">Reads</span><span class="w"> </span><span class="n">newline</span><span class="o">-</span><span class="n">delimited</span><span class="w"> </span><span class="nc">JSON</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="ss">:stdio</span><span class="w">           </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nc">Dispatches</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nc">Opal.RPC.Handler</span><span class="w">                     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nc">Writes</span><span class="w"> </span><span class="n">responses</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">notifications</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="ss">:stdio</span><span class="w">         </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nc">Subscribes</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nc">Opal.Events</span><span class="p">,</span><span class="w"> </span><span class="n">forwards</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">notifs</span><span class="w">      </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                     </span><span class="err">│</span><span class="w">                                      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nc">Opal.RPC.Handler</span><span class="w">                                     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="s">&quot;session/start&quot;</span><span class="w">  </span><span class="err">→</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">start_session</span><span class="o">/</span><span class="mi">1</span><span class="w">            </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="s">&quot;agent/prompt&quot;</span><span class="w">   </span><span class="err">→</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">prompt</span><span class="o">/</span><span class="mi">2</span><span class="w">                   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="s">&quot;agent/abort&quot;</span><span class="w">    </span><span class="err">→</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">abort</span><span class="o">/</span><span class="mi">1</span><span class="w">                    </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="s">&quot;agent/state&quot;</span><span class="w">    </span><span class="err">→</span><span class="w"> </span><span class="nc">Opal.Agent</span><span class="o">.</span><span class="n">get_state</span><span class="o">/</span><span class="mi">1</span><span class="w">          </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="s">&quot;session/list&quot;</span><span class="w">   </span><span class="err">→</span><span class="w"> </span><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">list_sessions</span><span class="o">/</span><span class="mi">0</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="s">&quot;models/list&quot;</span><span class="w">    </span><span class="err">→</span><span class="w"> </span><span class="nc">Opal.Provider</span><span class="o">.</span><span class="n">models</span><span class="o">/</span><span class="mi">1</span><span class="w">          </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="s">&quot;auth/*&quot;</span><span class="w">         </span><span class="err">→</span><span class="w"> </span><span class="nc">Opal.Auth</span><span class="o">.</span><span class="o">*</span><span class="w">                     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                     </span><span class="err">│</span><span class="w">                                      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">          </span><span class="p" data-group-id="5567962758-3">(</span><span class="n">calls</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="nc">Opal</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="nc">API</span><span class="p" data-group-id="5567962758-3">)</span><span class="w">          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                            </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">              </span><span class="nc">Opal</span><span class="w"> </span><span class="p" data-group-id="5567962758-4">(</span><span class="n">library</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="nc">Stages</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="p" data-group-id="5567962758-4">)</span><span class="w">              </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nc">Agent</span><span class="p">,</span><span class="w"> </span><span class="nc">Session</span><span class="p">,</span><span class="w"> </span><span class="nc">Tools</span><span class="p">,</span><span class="w"> </span><span class="nc">MCP</span><span class="p">,</span><span class="w"> </span><span class="nc">Events</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="o">.</span><span class="w">             </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h4>Modules</h4><p><strong><a href="Opal.RPC.html"><code class="inline">Opal.RPC</code></a></strong> — Protocol layer (transport-agnostic)</p><p>Encode/decode JSON-RPC 2.0 messages. Stateless functions.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.RPC</span><span class="w"> </span><span class="k" data-group-id="6115001681-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  JSON-RPC 2.0 encoding/decoding. Transport-agnostic — used by
  Opal.RPC.Stdio today, could be used by a WebSocket transport later.
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="na">@type</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">request</span><span class="p" data-group-id="6115001681-2">(</span><span class="p" data-group-id="6115001681-2">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">response</span><span class="p" data-group-id="6115001681-3">(</span><span class="p" data-group-id="6115001681-3">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">notification</span><span class="p" data-group-id="6115001681-4">(</span><span class="p" data-group-id="6115001681-4">)</span><span class="w">
  </span><span class="na">@type</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="6115001681-5">%{</span><span class="ss">jsonrpc</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6115001681-6">(</span><span class="p" data-group-id="6115001681-6">)</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="6115001681-7">(</span><span class="p" data-group-id="6115001681-7">)</span><span class="p">,</span><span class="w"> </span><span class="ss">method</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6115001681-8">(</span><span class="p" data-group-id="6115001681-8">)</span><span class="p">,</span><span class="w"> </span><span class="ss">params</span><span class="p">:</span><span class="w"> </span><span class="n">map</span><span class="p" data-group-id="6115001681-9">(</span><span class="p" data-group-id="6115001681-9">)</span><span class="p" data-group-id="6115001681-5">}</span><span class="w">
  </span><span class="na">@type</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="6115001681-10">%{</span><span class="ss">jsonrpc</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6115001681-11">(</span><span class="p" data-group-id="6115001681-11">)</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="6115001681-12">(</span><span class="p" data-group-id="6115001681-12">)</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="n">term</span><span class="p" data-group-id="6115001681-13">(</span><span class="p" data-group-id="6115001681-13">)</span><span class="p" data-group-id="6115001681-10">}</span><span class="w"> </span><span class="o">|</span><span class="w">
                    </span><span class="p" data-group-id="6115001681-14">%{</span><span class="ss">jsonrpc</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6115001681-15">(</span><span class="p" data-group-id="6115001681-15">)</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="6115001681-16">(</span><span class="p" data-group-id="6115001681-16">)</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="n">error</span><span class="p" data-group-id="6115001681-17">(</span><span class="p" data-group-id="6115001681-17">)</span><span class="p" data-group-id="6115001681-14">}</span><span class="w">
  </span><span class="na">@type</span><span class="w"> </span><span class="n">notification</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="6115001681-18">%{</span><span class="ss">jsonrpc</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6115001681-19">(</span><span class="p" data-group-id="6115001681-19">)</span><span class="p">,</span><span class="w"> </span><span class="ss">method</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6115001681-20">(</span><span class="p" data-group-id="6115001681-20">)</span><span class="p">,</span><span class="w"> </span><span class="ss">params</span><span class="p">:</span><span class="w"> </span><span class="n">map</span><span class="p" data-group-id="6115001681-21">(</span><span class="p" data-group-id="6115001681-21">)</span><span class="p" data-group-id="6115001681-18">}</span><span class="w">
  </span><span class="na">@type</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">integer</span><span class="p" data-group-id="6115001681-22">(</span><span class="p" data-group-id="6115001681-22">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6115001681-23">(</span><span class="p" data-group-id="6115001681-23">)</span><span class="w">
  </span><span class="na">@type</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="6115001681-24">%{</span><span class="ss">code</span><span class="p">:</span><span class="w"> </span><span class="n">integer</span><span class="p" data-group-id="6115001681-25">(</span><span class="p" data-group-id="6115001681-25">)</span><span class="p">,</span><span class="w"> </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6115001681-26">(</span><span class="p" data-group-id="6115001681-26">)</span><span class="p">,</span><span class="w"> </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">term</span><span class="p" data-group-id="6115001681-27">(</span><span class="p" data-group-id="6115001681-27">)</span><span class="p" data-group-id="6115001681-24">}</span><span class="w">

  </span><span class="c1"># Standard JSON-RPC error codes</span><span class="w">
  </span><span class="na">@parse_error</span><span class="w">      </span><span class="o">-</span><span class="mi">32700</span><span class="w">
  </span><span class="na">@invalid_request</span><span class="w">  </span><span class="o">-</span><span class="mi">32600</span><span class="w">
  </span><span class="na">@method_not_found</span><span class="w"> </span><span class="o">-</span><span class="mi">32601</span><span class="w">
  </span><span class="na">@invalid_params</span><span class="w">   </span><span class="o">-</span><span class="mi">32602</span><span class="w">
  </span><span class="na">@internal_error</span><span class="w">   </span><span class="o">-</span><span class="mi">32603</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">encode_request</span><span class="p" data-group-id="6115001681-28">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="6115001681-28">)</span><span class="w"> </span><span class="k" data-group-id="6115001681-29">do</span><span class="w">
    </span><span class="nc">Jason</span><span class="o">.</span><span class="n">encode!</span><span class="p" data-group-id="6115001681-30">(</span><span class="p" data-group-id="6115001681-31">%{</span><span class="ss">jsonrpc</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="ss">method</span><span class="p">:</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="ss">params</span><span class="p">:</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="6115001681-31">}</span><span class="p" data-group-id="6115001681-30">)</span><span class="w">
  </span><span class="k" data-group-id="6115001681-29">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">encode_response</span><span class="p" data-group-id="6115001681-32">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="6115001681-32">)</span><span class="w"> </span><span class="k" data-group-id="6115001681-33">do</span><span class="w">
    </span><span class="nc">Jason</span><span class="o">.</span><span class="n">encode!</span><span class="p" data-group-id="6115001681-34">(</span><span class="p" data-group-id="6115001681-35">%{</span><span class="ss">jsonrpc</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="6115001681-35">}</span><span class="p" data-group-id="6115001681-34">)</span><span class="w">
  </span><span class="k" data-group-id="6115001681-33">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">encode_error</span><span class="p" data-group-id="6115001681-36">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="6115001681-36">)</span><span class="w"> </span><span class="k" data-group-id="6115001681-37">do</span><span class="w">
    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6115001681-38">%{</span><span class="ss">code</span><span class="p">:</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="6115001681-38">}</span><span class="w">
    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="6115001681-39">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="ss">:data</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="6115001681-39">)</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="n">error</span><span class="w">
    </span><span class="nc">Jason</span><span class="o">.</span><span class="n">encode!</span><span class="p" data-group-id="6115001681-40">(</span><span class="p" data-group-id="6115001681-41">%{</span><span class="ss">jsonrpc</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="n">error</span><span class="p" data-group-id="6115001681-41">}</span><span class="p" data-group-id="6115001681-40">)</span><span class="w">
  </span><span class="k" data-group-id="6115001681-37">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">encode_notification</span><span class="p" data-group-id="6115001681-42">(</span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="6115001681-42">)</span><span class="w"> </span><span class="k" data-group-id="6115001681-43">do</span><span class="w">
    </span><span class="nc">Jason</span><span class="o">.</span><span class="n">encode!</span><span class="p" data-group-id="6115001681-44">(</span><span class="p" data-group-id="6115001681-45">%{</span><span class="ss">jsonrpc</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">method</span><span class="p">:</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="ss">params</span><span class="p">:</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="6115001681-45">}</span><span class="p" data-group-id="6115001681-44">)</span><span class="w">
  </span><span class="k" data-group-id="6115001681-43">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">decode</span><span class="p" data-group-id="6115001681-46">(</span><span class="n">json</span><span class="p" data-group-id="6115001681-46">)</span><span class="w"> </span><span class="k" data-group-id="6115001681-47">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Jason</span><span class="o">.</span><span class="n">decode</span><span class="p" data-group-id="6115001681-48">(</span><span class="n">json</span><span class="p" data-group-id="6115001681-48">)</span><span class="w"> </span><span class="k" data-group-id="6115001681-49">do</span><span class="w">
      </span><span class="p" data-group-id="6115001681-50">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6115001681-51">%{</span><span class="s">&quot;jsonrpc&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;method&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">method</span><span class="p" data-group-id="6115001681-51">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p" data-group-id="6115001681-50">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="6115001681-52">{</span><span class="ss">:request</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="6115001681-53">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;params&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6115001681-54">%{</span><span class="p" data-group-id="6115001681-54">}</span><span class="p" data-group-id="6115001681-53">)</span><span class="p" data-group-id="6115001681-52">}</span><span class="w">

      </span><span class="p" data-group-id="6115001681-55">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6115001681-56">%{</span><span class="s">&quot;jsonrpc&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;result&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="6115001681-56">}</span><span class="p" data-group-id="6115001681-55">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="6115001681-57">{</span><span class="ss">:response</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="6115001681-57">}</span><span class="w">

      </span><span class="p" data-group-id="6115001681-58">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6115001681-59">%{</span><span class="s">&quot;jsonrpc&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;error&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">error</span><span class="p" data-group-id="6115001681-59">}</span><span class="p" data-group-id="6115001681-58">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="6115001681-60">{</span><span class="ss">:error_response</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p" data-group-id="6115001681-60">}</span><span class="w">

      </span><span class="p" data-group-id="6115001681-61">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6115001681-62">%{</span><span class="s">&quot;jsonrpc&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;method&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">method</span><span class="p" data-group-id="6115001681-62">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p" data-group-id="6115001681-61">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="6115001681-63">{</span><span class="ss">:notification</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="6115001681-64">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;params&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6115001681-65">%{</span><span class="p" data-group-id="6115001681-65">}</span><span class="p" data-group-id="6115001681-64">)</span><span class="p" data-group-id="6115001681-63">}</span><span class="w">

      </span><span class="p" data-group-id="6115001681-66">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="6115001681-66">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="6115001681-67">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:invalid_request</span><span class="p" data-group-id="6115001681-67">}</span><span class="w">
      </span><span class="p" data-group-id="6115001681-68">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="6115001681-68">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="6115001681-69">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:parse_error</span><span class="p" data-group-id="6115001681-69">}</span><span class="w">
    </span><span class="k" data-group-id="6115001681-49">end</span><span class="w">
  </span><span class="k" data-group-id="6115001681-47">end</span><span class="w">
</span><span class="k" data-group-id="6115001681-1">end</span></code></pre><p><strong><a href="Opal.RPC.Handler.html"><code class="inline">Opal.RPC.Handler</code></a></strong> — Method dispatch</p><p>Maps JSON-RPC methods to Opal library calls. Pure functions — receives method +
params, returns result or error. No transport awareness.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.RPC.Handler</span><span class="w"> </span><span class="k" data-group-id="9444447945-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Dispatches JSON-RPC methods to Opal library functions.
  Returns {:ok, result} | {:error, code, message, data}.
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-2">(</span><span class="s">&quot;session/start&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="9444447945-2">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-3">do</span><span class="w">
    </span><span class="n">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decode_session_opts</span><span class="p" data-group-id="9444447945-4">(</span><span class="n">params</span><span class="p" data-group-id="9444447945-4">)</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">start_session</span><span class="p" data-group-id="9444447945-5">(</span><span class="n">opts</span><span class="p" data-group-id="9444447945-5">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-6">do</span><span class="w">
      </span><span class="p" data-group-id="9444447945-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p" data-group-id="9444447945-7">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9444447945-8">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-9">%{</span><span class="ss">session_id</span><span class="p">:</span><span class="w"> </span><span class="n">session_id</span><span class="p" data-group-id="9444447945-9">}</span><span class="p" data-group-id="9444447945-8">}</span><span class="w">
      </span><span class="p" data-group-id="9444447945-10">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="9444447945-10">}</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9444447945-11">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">32603</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to start session&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="9444447945-11">}</span><span class="w">
    </span><span class="k" data-group-id="9444447945-6">end</span><span class="w">
  </span><span class="k" data-group-id="9444447945-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-12">(</span><span class="s">&quot;agent/prompt&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-13">%{</span><span class="s">&quot;session_id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">sid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">text</span><span class="p" data-group-id="9444447945-13">}</span><span class="p" data-group-id="9444447945-12">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-14">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">prompt</span><span class="p" data-group-id="9444447945-15">(</span><span class="n">sid</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p" data-group-id="9444447945-15">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-16">do</span><span class="w">
      </span><span class="ss">:ok</span><span class="w">          </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9444447945-17">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-18">%{</span><span class="ss">ok</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="9444447945-18">}</span><span class="p" data-group-id="9444447945-17">}</span><span class="w">
      </span><span class="p" data-group-id="9444447945-19">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p" data-group-id="9444447945-19">}</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9444447945-20">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">32603</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Prompt failed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p" data-group-id="9444447945-20">}</span><span class="w">
    </span><span class="k" data-group-id="9444447945-16">end</span><span class="w">
  </span><span class="k" data-group-id="9444447945-14">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-21">(</span><span class="s">&quot;agent/steer&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-22">%{</span><span class="s">&quot;session_id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">sid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">text</span><span class="p" data-group-id="9444447945-22">}</span><span class="p" data-group-id="9444447945-21">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-23">do</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">steer</span><span class="p" data-group-id="9444447945-24">(</span><span class="n">sid</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p" data-group-id="9444447945-24">)</span><span class="w">
    </span><span class="p" data-group-id="9444447945-25">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-26">%{</span><span class="ss">ok</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="9444447945-26">}</span><span class="p" data-group-id="9444447945-25">}</span><span class="w">
  </span><span class="k" data-group-id="9444447945-23">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-27">(</span><span class="s">&quot;agent/abort&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-28">%{</span><span class="s">&quot;session_id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">sid</span><span class="p" data-group-id="9444447945-28">}</span><span class="p" data-group-id="9444447945-27">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-29">do</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">abort</span><span class="p" data-group-id="9444447945-30">(</span><span class="n">sid</span><span class="p" data-group-id="9444447945-30">)</span><span class="w">
    </span><span class="p" data-group-id="9444447945-31">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-32">%{</span><span class="ss">ok</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="9444447945-32">}</span><span class="p" data-group-id="9444447945-31">}</span><span class="w">
  </span><span class="k" data-group-id="9444447945-29">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-33">(</span><span class="s">&quot;agent/state&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-34">%{</span><span class="s">&quot;session_id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">sid</span><span class="p" data-group-id="9444447945-34">}</span><span class="p" data-group-id="9444447945-33">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-35">do</span><span class="w">
    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Agent</span><span class="o">.</span><span class="n">get_state</span><span class="p" data-group-id="9444447945-36">(</span><span class="n">sid</span><span class="p" data-group-id="9444447945-36">)</span><span class="w">
    </span><span class="p" data-group-id="9444447945-37">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">serialize_state</span><span class="p" data-group-id="9444447945-38">(</span><span class="n">state</span><span class="p" data-group-id="9444447945-38">)</span><span class="p" data-group-id="9444447945-37">}</span><span class="w">
  </span><span class="k" data-group-id="9444447945-35">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-39">(</span><span class="s">&quot;session/list&quot;</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="9444447945-39">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-40">do</span><span class="w">
    </span><span class="n">sessions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">list_sessions</span><span class="p" data-group-id="9444447945-41">(</span><span class="p" data-group-id="9444447945-41">)</span><span class="w">
    </span><span class="p" data-group-id="9444447945-42">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-43">%{</span><span class="ss">sessions</span><span class="p">:</span><span class="w"> </span><span class="n">sessions</span><span class="p" data-group-id="9444447945-43">}</span><span class="p" data-group-id="9444447945-42">}</span><span class="w">
  </span><span class="k" data-group-id="9444447945-40">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-44">(</span><span class="s">&quot;session/branch&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-45">%{</span><span class="s">&quot;session_id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">sid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;entry_id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">eid</span><span class="p" data-group-id="9444447945-45">}</span><span class="p" data-group-id="9444447945-44">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-46">do</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">branch</span><span class="p" data-group-id="9444447945-47">(</span><span class="n">sid</span><span class="p">,</span><span class="w"> </span><span class="n">eid</span><span class="p" data-group-id="9444447945-47">)</span><span class="w">
    </span><span class="p" data-group-id="9444447945-48">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-49">%{</span><span class="ss">ok</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="9444447945-49">}</span><span class="p" data-group-id="9444447945-48">}</span><span class="w">
  </span><span class="k" data-group-id="9444447945-46">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-50">(</span><span class="s">&quot;session/compact&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-51">%{</span><span class="s">&quot;session_id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">sid</span><span class="p" data-group-id="9444447945-51">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="9444447945-50">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-52">do</span><span class="w">
    </span><span class="n">keep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="9444447945-53">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;keep_recent&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="9444447945-53">)</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Session</span><span class="o">.</span><span class="n">compact</span><span class="p" data-group-id="9444447945-54">(</span><span class="n">sid</span><span class="p">,</span><span class="w"> </span><span class="ss">keep_recent</span><span class="p">:</span><span class="w"> </span><span class="n">keep</span><span class="p" data-group-id="9444447945-54">)</span><span class="w">
    </span><span class="p" data-group-id="9444447945-55">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-56">%{</span><span class="ss">ok</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="9444447945-56">}</span><span class="p" data-group-id="9444447945-55">}</span><span class="w">
  </span><span class="k" data-group-id="9444447945-52">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-57">(</span><span class="s">&quot;models/list&quot;</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="9444447945-57">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-58">do</span><span class="w">
    </span><span class="n">models</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.Provider.Copilot</span><span class="o">.</span><span class="n">models</span><span class="p" data-group-id="9444447945-59">(</span><span class="p" data-group-id="9444447945-59">)</span><span class="w">
    </span><span class="p" data-group-id="9444447945-60">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-61">%{</span><span class="ss">models</span><span class="p">:</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="9444447945-62">(</span><span class="n">models</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">serialize_model</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9444447945-62">)</span><span class="p" data-group-id="9444447945-61">}</span><span class="p" data-group-id="9444447945-60">}</span><span class="w">
  </span><span class="k" data-group-id="9444447945-58">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-63">(</span><span class="s">&quot;auth/status&quot;</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="9444447945-63">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-64">do</span><span class="w">
    </span><span class="p" data-group-id="9444447945-65">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-66">%{</span><span class="ss">authenticated</span><span class="p">:</span><span class="w"> </span><span class="nc">Opal.Auth</span><span class="o">.</span><span class="n">authenticated?</span><span class="p" data-group-id="9444447945-67">(</span><span class="p" data-group-id="9444447945-67">)</span><span class="p" data-group-id="9444447945-66">}</span><span class="p" data-group-id="9444447945-65">}</span><span class="w">
  </span><span class="k" data-group-id="9444447945-64">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-68">(</span><span class="s">&quot;auth/login&quot;</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="9444447945-68">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-69">do</span><span class="w">
    </span><span class="c1"># Triggers device flow — progress sent as notifications</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Opal.Auth</span><span class="o">.</span><span class="n">login</span><span class="p" data-group-id="9444447945-70">(</span><span class="p" data-group-id="9444447945-70">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-71">do</span><span class="w">
      </span><span class="p" data-group-id="9444447945-72">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="9444447945-72">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9444447945-73">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9444447945-74">%{</span><span class="ss">ok</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="9444447945-74">}</span><span class="p" data-group-id="9444447945-73">}</span><span class="w">
      </span><span class="p" data-group-id="9444447945-75">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p" data-group-id="9444447945-75">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9444447945-76">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">32603</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Login failed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p" data-group-id="9444447945-76">}</span><span class="w">
    </span><span class="k" data-group-id="9444447945-71">end</span><span class="w">
  </span><span class="k" data-group-id="9444447945-69">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="9444447945-77">(</span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="9444447945-77">)</span><span class="w"> </span><span class="k" data-group-id="9444447945-78">do</span><span class="w">
    </span><span class="p" data-group-id="9444447945-79">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">32601</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Method not found: </span><span class="si" data-group-id="9444447945-80">#{</span><span class="n">method</span><span class="si" data-group-id="9444447945-80">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="9444447945-79">}</span><span class="w">
  </span><span class="k" data-group-id="9444447945-78">end</span><span class="w">

  </span><span class="c1"># ... serialization helpers</span><span class="w">
</span><span class="k" data-group-id="9444447945-1">end</span></code></pre><p><strong><a href="Opal.RPC.Stdio.html"><code class="inline">Opal.RPC.Stdio</code></a></strong> — Stdio transport GenServer</p><p>The glue. Reads lines from stdin, dispatches, writes to stdout. Subscribes to
<a href="Opal.Events.html"><code class="inline">Opal.Events</code></a> and forwards as notifications. Handles server→client requests
for user confirmations.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.RPC.Stdio</span><span class="w"> </span><span class="k" data-group-id="0931217430-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  JSON-RPC 2.0 transport over stdin/stdout.

  Reads newline-delimited JSON from stdin, dispatches via
  Opal.RPC.Handler, writes responses to stdout. Subscribes
  to Opal.Events and emits notifications for streaming events.
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="kn">use</span><span class="w"> </span><span class="nc">GenServer</span><span class="w">

  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p" data-group-id="0931217430-2">[</span><span class="ss">:port</span><span class="p">,</span><span class="w"> </span><span class="ss">:buffer</span><span class="p">,</span><span class="w"> </span><span class="ss">pending_requests</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0931217430-3">%{</span><span class="p" data-group-id="0931217430-3">}</span><span class="p">,</span><span class="w"> </span><span class="ss">next_server_id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="0931217430-2">]</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start_link</span><span class="p" data-group-id="0931217430-4">(</span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="0931217430-5">[</span><span class="p" data-group-id="0931217430-5">]</span><span class="p" data-group-id="0931217430-4">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-6">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="0931217430-7">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="bp">__MODULE__</span><span class="p" data-group-id="0931217430-7">)</span><span class="w">
  </span><span class="k" data-group-id="0931217430-6">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="0931217430-8">(</span><span class="c">_opts</span><span class="p" data-group-id="0931217430-8">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-9">do</span><span class="w">
    </span><span class="c1"># Open stdin as a port for line-based reading</span><span class="w">
    </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Port</span><span class="o">.</span><span class="n">open</span><span class="p" data-group-id="0931217430-10">(</span><span class="p" data-group-id="0931217430-11">{</span><span class="ss">:fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="0931217430-11">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-12">[</span><span class="ss">:binary</span><span class="p">,</span><span class="w"> </span><span class="ss">:stream</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-13">{</span><span class="ss">:line</span><span class="p">,</span><span class="w"> </span><span class="mi">1_048_576</span><span class="p" data-group-id="0931217430-13">}</span><span class="p" data-group-id="0931217430-12">]</span><span class="p" data-group-id="0931217430-10">)</span><span class="w">
    </span><span class="p" data-group-id="0931217430-14">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p">%</span><span class="bp">__MODULE__</span><span class="p" data-group-id="0931217430-15">{</span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="ss">buffer</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p" data-group-id="0931217430-15">}</span><span class="p" data-group-id="0931217430-14">}</span><span class="w">
  </span><span class="k" data-group-id="0931217430-9">end</span><span class="w">

  </span><span class="c1"># --- Incoming data from stdin ---</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0931217430-16">(</span><span class="p" data-group-id="0931217430-17">{</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-18">{</span><span class="ss">:data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-19">{</span><span class="ss">:eol</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p" data-group-id="0931217430-19">}</span><span class="p" data-group-id="0931217430-18">}</span><span class="p" data-group-id="0931217430-17">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-20">%{</span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="n">port</span><span class="p" data-group-id="0931217430-20">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-16">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-21">do</span><span class="w">
    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process_line</span><span class="p" data-group-id="0931217430-22">(</span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-22">)</span><span class="w">
    </span><span class="p" data-group-id="0931217430-23">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-23">}</span><span class="w">
  </span><span class="k" data-group-id="0931217430-21">end</span><span class="w">

  </span><span class="c1"># --- Opal events → JSON-RPC notifications ---</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0931217430-24">(</span><span class="p" data-group-id="0931217430-25">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="0931217430-25">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-24">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-26">do</span><span class="w">
    </span><span class="n">notification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event_to_notification</span><span class="p" data-group-id="0931217430-27">(</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="0931217430-27">)</span><span class="w">
    </span><span class="n">write_stdout</span><span class="p" data-group-id="0931217430-28">(</span><span class="n">notification</span><span class="p" data-group-id="0931217430-28">)</span><span class="w">
    </span><span class="p" data-group-id="0931217430-29">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-29">}</span><span class="w">
  </span><span class="k" data-group-id="0931217430-26">end</span><span class="w">

  </span><span class="c1"># --- Server→Client request responses ---</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0931217430-30">(</span><span class="p" data-group-id="0931217430-31">{</span><span class="ss">:client_response</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="0931217430-31">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-30">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-32">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">pop</span><span class="p" data-group-id="0931217430-33">(</span><span class="n">state</span><span class="o">.</span><span class="n">pending_requests</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="0931217430-33">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-34">do</span><span class="w">
      </span><span class="p" data-group-id="0931217430-35">{</span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">pending</span><span class="p" data-group-id="0931217430-35">}</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">reply</span><span class="p" data-group-id="0931217430-36">(</span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="0931217430-36">)</span><span class="w">
        </span><span class="p" data-group-id="0931217430-37">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-38">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">pending_requests</span><span class="p">:</span><span class="w"> </span><span class="n">pending</span><span class="p" data-group-id="0931217430-38">}</span><span class="p" data-group-id="0931217430-37">}</span><span class="w">
      </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="0931217430-39">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-39">}</span><span class="w">
    </span><span class="k" data-group-id="0931217430-34">end</span><span class="w">
  </span><span class="k" data-group-id="0931217430-32">end</span><span class="w">

  </span><span class="c1"># --- Internal ---</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">process_line</span><span class="p" data-group-id="0931217430-40">(</span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-40">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-41">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Opal.RPC</span><span class="o">.</span><span class="n">decode</span><span class="p" data-group-id="0931217430-42">(</span><span class="n">line</span><span class="p" data-group-id="0931217430-42">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-43">do</span><span class="w">
      </span><span class="p" data-group-id="0931217430-44">{</span><span class="ss">:request</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="0931217430-44">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">handle_request</span><span class="p" data-group-id="0931217430-45">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-45">)</span><span class="w">

      </span><span class="p" data-group-id="0931217430-46">{</span><span class="ss">:response</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="0931217430-46">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="c1"># Client responding to a server→client request</span><span class="w">
        </span><span class="n">send</span><span class="p" data-group-id="0931217430-47">(</span><span class="n">self</span><span class="p" data-group-id="0931217430-48">(</span><span class="p" data-group-id="0931217430-48">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-49">{</span><span class="ss">:client_response</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="0931217430-49">}</span><span class="p" data-group-id="0931217430-47">)</span><span class="w">
        </span><span class="n">state</span><span class="w">

      </span><span class="p" data-group-id="0931217430-50">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="c">_reason</span><span class="p" data-group-id="0931217430-50">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">write_stdout</span><span class="p" data-group-id="0931217430-51">(</span><span class="nc">Opal.RPC</span><span class="o">.</span><span class="n">encode_error</span><span class="p" data-group-id="0931217430-52">(</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">32700</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Parse error&quot;</span><span class="p" data-group-id="0931217430-52">)</span><span class="p" data-group-id="0931217430-51">)</span><span class="w">
        </span><span class="n">state</span><span class="w">
    </span><span class="k" data-group-id="0931217430-43">end</span><span class="w">
  </span><span class="k" data-group-id="0931217430-41">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_request</span><span class="p" data-group-id="0931217430-53">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-53">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-54">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Opal.RPC.Handler</span><span class="o">.</span><span class="n">handle</span><span class="p" data-group-id="0931217430-55">(</span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="0931217430-55">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-56">do</span><span class="w">
      </span><span class="p" data-group-id="0931217430-57">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="0931217430-57">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">write_stdout</span><span class="p" data-group-id="0931217430-58">(</span><span class="nc">Opal.RPC</span><span class="o">.</span><span class="n">encode_response</span><span class="p" data-group-id="0931217430-59">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="0931217430-59">)</span><span class="p" data-group-id="0931217430-58">)</span><span class="w">

        </span><span class="c1"># Auto-subscribe to events for new sessions</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;session/start&quot;</span><span class="w"> </span><span class="k" data-group-id="0931217430-60">do</span><span class="w">
          </span><span class="nc">Opal.Events</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="0931217430-61">(</span><span class="n">result</span><span class="o">.</span><span class="n">session_id</span><span class="p" data-group-id="0931217430-61">)</span><span class="w">
        </span><span class="k" data-group-id="0931217430-60">end</span><span class="w">

      </span><span class="p" data-group-id="0931217430-62">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="0931217430-62">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">write_stdout</span><span class="p" data-group-id="0931217430-63">(</span><span class="nc">Opal.RPC</span><span class="o">.</span><span class="n">encode_error</span><span class="p" data-group-id="0931217430-64">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="0931217430-64">)</span><span class="p" data-group-id="0931217430-63">)</span><span class="w">
    </span><span class="k" data-group-id="0931217430-56">end</span><span class="w">
    </span><span class="n">state</span><span class="w">
  </span><span class="k" data-group-id="0931217430-54">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Send a request to the client and wait for a response.
  Used for user confirmations, input prompts, etc.
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">request_client</span><span class="p" data-group-id="0931217430-65">(</span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="mi">30_000</span><span class="p" data-group-id="0931217430-65">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-66">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="0931217430-67">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-68">{</span><span class="ss">:request_client</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="0931217430-68">}</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="p" data-group-id="0931217430-67">)</span><span class="w">
  </span><span class="k" data-group-id="0931217430-66">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_call</span><span class="p" data-group-id="0931217430-69">(</span><span class="p" data-group-id="0931217430-70">{</span><span class="ss">:request_client</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="0931217430-70">}</span><span class="p">,</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0931217430-69">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-71">do</span><span class="w">
    </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;s2c-</span><span class="si" data-group-id="0931217430-72">#{</span><span class="n">state</span><span class="o">.</span><span class="n">next_server_id</span><span class="si" data-group-id="0931217430-72">}</span><span class="s">&quot;</span><span class="w">
    </span><span class="n">write_stdout</span><span class="p" data-group-id="0931217430-73">(</span><span class="nc">Opal.RPC</span><span class="o">.</span><span class="n">encode_request</span><span class="p" data-group-id="0931217430-74">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="0931217430-74">)</span><span class="p" data-group-id="0931217430-73">)</span><span class="w">
    </span><span class="n">pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="0931217430-75">(</span><span class="n">state</span><span class="o">.</span><span class="n">pending_requests</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">from</span><span class="p" data-group-id="0931217430-75">)</span><span class="w">
    </span><span class="p" data-group-id="0931217430-76">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-77">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">pending_requests</span><span class="p">:</span><span class="w"> </span><span class="n">pending</span><span class="p">,</span><span class="w">
                         </span><span class="ss">next_server_id</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">next_server_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="0931217430-77">}</span><span class="p" data-group-id="0931217430-76">}</span><span class="w">
  </span><span class="k" data-group-id="0931217430-71">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">event_to_notification</span><span class="p" data-group-id="0931217430-78">(</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="0931217430-78">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-79">do</span><span class="w">
    </span><span class="p" data-group-id="0931217430-80">{</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="0931217430-80">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serialize_event</span><span class="p" data-group-id="0931217430-81">(</span><span class="n">event</span><span class="p" data-group-id="0931217430-81">)</span><span class="w">
    </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">merge</span><span class="p" data-group-id="0931217430-82">(</span><span class="p" data-group-id="0931217430-83">%{</span><span class="ss">session_id</span><span class="p">:</span><span class="w"> </span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="n">type</span><span class="p" data-group-id="0931217430-83">}</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="0931217430-82">)</span><span class="w">
    </span><span class="nc">Opal.RPC</span><span class="o">.</span><span class="n">encode_notification</span><span class="p" data-group-id="0931217430-84">(</span><span class="s">&quot;agent/event&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="0931217430-84">)</span><span class="w">
  </span><span class="k" data-group-id="0931217430-79">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">serialize_event</span><span class="p" data-group-id="0931217430-85">(</span><span class="p" data-group-id="0931217430-86">{</span><span class="ss">:agent_start</span><span class="p" data-group-id="0931217430-86">}</span><span class="p" data-group-id="0931217430-85">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0931217430-87">{</span><span class="s">&quot;agent_start&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-88">%{</span><span class="p" data-group-id="0931217430-88">}</span><span class="p" data-group-id="0931217430-87">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">serialize_event</span><span class="p" data-group-id="0931217430-89">(</span><span class="p" data-group-id="0931217430-90">{</span><span class="ss">:message_delta</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-91">%{</span><span class="ss">delta</span><span class="p">:</span><span class="w"> </span><span class="n">delta</span><span class="p" data-group-id="0931217430-91">}</span><span class="p" data-group-id="0931217430-90">}</span><span class="p" data-group-id="0931217430-89">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0931217430-92">{</span><span class="s">&quot;message_delta&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-93">%{</span><span class="ss">delta</span><span class="p">:</span><span class="w"> </span><span class="n">delta</span><span class="p" data-group-id="0931217430-93">}</span><span class="p" data-group-id="0931217430-92">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">serialize_event</span><span class="p" data-group-id="0931217430-94">(</span><span class="p" data-group-id="0931217430-95">{</span><span class="ss">:thinking_delta</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-96">%{</span><span class="ss">delta</span><span class="p">:</span><span class="w"> </span><span class="n">delta</span><span class="p" data-group-id="0931217430-96">}</span><span class="p" data-group-id="0931217430-95">}</span><span class="p" data-group-id="0931217430-94">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0931217430-97">{</span><span class="s">&quot;thinking_delta&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-98">%{</span><span class="ss">delta</span><span class="p">:</span><span class="w"> </span><span class="n">delta</span><span class="p" data-group-id="0931217430-98">}</span><span class="p" data-group-id="0931217430-97">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">serialize_event</span><span class="p" data-group-id="0931217430-99">(</span><span class="p" data-group-id="0931217430-100">{</span><span class="ss">:tool_execution_start</span><span class="p">,</span><span class="w"> </span><span class="n">tool</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p" data-group-id="0931217430-100">}</span><span class="p" data-group-id="0931217430-99">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0931217430-101">{</span><span class="s">&quot;tool_execution_start&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-102">%{</span><span class="ss">tool</span><span class="p">:</span><span class="w"> </span><span class="n">tool</span><span class="p">,</span><span class="w"> </span><span class="ss">args</span><span class="p">:</span><span class="w"> </span><span class="n">args</span><span class="p" data-group-id="0931217430-102">}</span><span class="p" data-group-id="0931217430-101">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">serialize_event</span><span class="p" data-group-id="0931217430-103">(</span><span class="p" data-group-id="0931217430-104">{</span><span class="ss">:tool_execution_end</span><span class="p">,</span><span class="w"> </span><span class="n">tool</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="0931217430-104">}</span><span class="p" data-group-id="0931217430-103">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0931217430-105">{</span><span class="s">&quot;tool_execution_end&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-106">%{</span><span class="ss">tool</span><span class="p">:</span><span class="w"> </span><span class="n">tool</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="0931217430-106">}</span><span class="p" data-group-id="0931217430-105">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">serialize_event</span><span class="p" data-group-id="0931217430-107">(</span><span class="p" data-group-id="0931217430-108">{</span><span class="ss">:turn_end</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="c">_results</span><span class="p" data-group-id="0931217430-108">}</span><span class="p" data-group-id="0931217430-107">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0931217430-109">{</span><span class="s">&quot;turn_end&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-110">%{</span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="0931217430-110">}</span><span class="p" data-group-id="0931217430-109">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">serialize_event</span><span class="p" data-group-id="0931217430-111">(</span><span class="p" data-group-id="0931217430-112">{</span><span class="ss">:agent_end</span><span class="p">,</span><span class="w"> </span><span class="c">_messages</span><span class="p" data-group-id="0931217430-112">}</span><span class="p" data-group-id="0931217430-111">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0931217430-113">{</span><span class="s">&quot;agent_end&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0931217430-114">%{</span><span class="p" data-group-id="0931217430-114">}</span><span class="p" data-group-id="0931217430-113">}</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">write_stdout</span><span class="p" data-group-id="0931217430-115">(</span><span class="n">json</span><span class="p" data-group-id="0931217430-115">)</span><span class="w"> </span><span class="k" data-group-id="0931217430-116">do</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">write</span><span class="p" data-group-id="0931217430-117">(</span><span class="ss">:stdio</span><span class="p">,</span><span class="w"> </span><span class="n">json</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p" data-group-id="0931217430-117">)</span><span class="w">
  </span><span class="k" data-group-id="0931217430-116">end</span><span class="w">
</span><span class="k" data-group-id="0931217430-1">end</span></code></pre><p><strong><code class="inline">Opal.CLI.Server</code></strong> — Headless daemon entry point</p><p>The headless daemon mode (<code class="inline">opal --daemon</code>). Starts the OTP application,
launches the stdio transport, and blocks until stdin closes.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.CLI.Server</span><span class="w"> </span><span class="k" data-group-id="0059147245-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Entry point for headless daemon mode (opal --daemon).

  Usage: opal --daemon [--log-level debug]

  The server communicates exclusively via JSON-RPC 2.0 on stdin/stdout.
  Logs go to stderr (configurable level).
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">main</span><span class="p" data-group-id="0059147245-2">(</span><span class="n">args</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="0059147245-3">[</span><span class="p" data-group-id="0059147245-3">]</span><span class="p" data-group-id="0059147245-2">)</span><span class="w"> </span><span class="k" data-group-id="0059147245-4">do</span><span class="w">
    </span><span class="n">configure_logging</span><span class="p" data-group-id="0059147245-5">(</span><span class="n">args</span><span class="p" data-group-id="0059147245-5">)</span><span class="w">
    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">configure_backend</span><span class="p" data-group-id="0059147245-6">(</span><span class="ss">:console</span><span class="p">,</span><span class="w"> </span><span class="ss">device</span><span class="p">:</span><span class="w"> </span><span class="ss">:standard_error</span><span class="p" data-group-id="0059147245-6">)</span><span class="w">
    </span><span class="p" data-group-id="0059147245-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="0059147245-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Application</span><span class="o">.</span><span class="n">ensure_all_started</span><span class="p" data-group-id="0059147245-8">(</span><span class="ss">:opal</span><span class="p" data-group-id="0059147245-8">)</span><span class="w">
    </span><span class="p" data-group-id="0059147245-9">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="0059147245-9">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal.RPC.Stdio</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="0059147245-10">(</span><span class="p" data-group-id="0059147245-10">)</span><span class="w">

    </span><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="0059147245-11">do</span><span class="w">
      </span><span class="p" data-group-id="0059147245-12">{</span><span class="ss">:EXIT</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="0059147245-12">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">:ok</span><span class="w">
    </span><span class="k" data-group-id="0059147245-11">end</span><span class="w">
  </span><span class="k" data-group-id="0059147245-4">end</span><span class="w">
</span><span class="k" data-group-id="0059147245-1">end</span></code></pre><p><strong><code class="inline">Opal.CLI.Main</code></strong> — Binary entry point</p><p>The <code class="inline">opal</code> binary entry point. Dispatches between interactive TUI (default)
and headless daemon mode (<code class="inline">--daemon</code>).</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Opal.CLI.Main</span><span class="w"> </span><span class="k" data-group-id="0266863217-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">main</span><span class="p" data-group-id="0266863217-2">(</span><span class="n">args</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="0266863217-3">[</span><span class="p" data-group-id="0266863217-3">]</span><span class="p" data-group-id="0266863217-2">)</span><span class="w"> </span><span class="k" data-group-id="0266863217-4">do</span><span class="w">
    </span><span class="p" data-group-id="0266863217-5">{</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="0266863217-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">OptionParser</span><span class="o">.</span><span class="n">parse</span><span class="p" data-group-id="0266863217-6">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="0266863217-6">)</span><span class="w">

    </span><span class="k">cond</span><span class="w"> </span><span class="k" data-group-id="0266863217-7">do</span><span class="w">
      </span><span class="n">opts</span><span class="p" data-group-id="0266863217-8">[</span><span class="ss">:daemon</span><span class="p" data-group-id="0266863217-8">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="0266863217-9">[</span><span class="ss">:headless</span><span class="p" data-group-id="0266863217-9">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Opal.CLI.Server</span><span class="o">.</span><span class="n">main</span><span class="p" data-group-id="0266863217-10">(</span><span class="n">args</span><span class="p" data-group-id="0266863217-10">)</span><span class="w">
      </span><span class="no">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">TermUI.Runtime</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="0266863217-11">(</span><span class="ss">root</span><span class="p">:</span><span class="w"> </span><span class="nc">Opal.CLI.App</span><span class="p">,</span><span class="w"> </span><span class="ss">render_interval</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p" data-group-id="0266863217-11">)</span><span class="w">
    </span><span class="k" data-group-id="0266863217-7">end</span><span class="w">
  </span><span class="k" data-group-id="0266863217-4">end</span><span class="w">
</span><span class="k" data-group-id="0266863217-1">end</span></code></pre><h4>Distribution</h4><p>The <code class="inline">opal</code> binary is built as either:</p><ul><li><strong>Escript</strong> — <a href="https://hexdocs.pm/mix/Mix.Tasks.Escript.Build.html"><code class="inline">mix escript.build</code></a> (requires Erlang/OTP on the target machine)</li><li><strong>Mix release</strong> — <a href="https://hexdocs.pm/mix/Mix.Tasks.Release.html"><code class="inline">mix release</code></a> (self-contained, bundles ERTS)</li><li><strong>Burrito</strong> — single-file binary, no runtime dependencies (future)</li></ul><pre><code class="makeup elixir" translate="no"><span class="n">cd</span><span class="w"> </span><span class="n">core</span><span class="w">
</span><span class="n">mix</span><span class="w"> </span><span class="n">escript</span><span class="o">.</span><span class="n">build</span><span class="w">
</span><span class="o">.</span><span class="o">/</span><span class="n">opal</span><span class="w">               </span><span class="c1"># Interactive TUI</span><span class="w">
</span><span class="o">.</span><span class="o">/</span><span class="n">opal</span><span class="w"> </span><span class="o">--</span><span class="n">daemon</span><span class="w">      </span><span class="c1"># Headless JSON-RPC</span></code></pre><h4>Deployment Modes</h4><table><thead><tr><th style="text-align: left;">Concern</th><th style="text-align: left;">Opal library (Hex)</th><th style="text-align: left;">opal binary</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Audience</strong></td><td style="text-align: left;">Elixir developers embedding agents</td><td style="text-align: left;">End users &amp; external clients</td></tr><tr><td style="text-align: left;"><strong>Distribution</strong></td><td style="text-align: left;"><code class="inline">{:opal, &quot;~&gt; 0.1&quot;}</code> in <code class="inline">mix.exs</code></td><td style="text-align: left;">escript, mix release, or Burrito</td></tr><tr><td style="text-align: left;"><strong>Interface</strong></td><td style="text-align: left;">Elixir function calls, OTP messages</td><td style="text-align: left;">TUI (default) or JSON-RPC (--daemon)</td></tr><tr><td style="text-align: left;"><strong>State management</strong></td><td style="text-align: left;">Your supervision tree</td><td style="text-align: left;">Self-contained OTP app</td></tr><tr><td style="text-align: left;"><strong>Streaming</strong></td><td style="text-align: left;"><a href="Opal.Events.html#subscribe/1"><code class="inline">Opal.Events.subscribe/1</code></a> + mailbox</td><td style="text-align: left;">Direct in TUI / notifications in daemon</td></tr></tbody></table><h4>Future Transports (Not in This Stage)</h4><p>The protocol layer (<a href="Opal.RPC.html"><code class="inline">Opal.RPC</code></a> + <a href="Opal.RPC.Handler.html"><code class="inline">Opal.RPC.Handler</code></a>) is transport-agnostic.
Adding new transports later is a small module each:</p><ul><li><strong><code class="inline">Opal.RPC.WebSocket</code></strong> — for web UIs, IDE extensions, multi-client</li><li><strong><code class="inline">Opal.RPC.HTTP</code></strong> — REST + SSE for browser-based clients</li><li><strong><code class="inline">Opal.RPC.TCP</code></strong> — for daemon mode (long-running server, multiple CLIs)</li></ul><p>Each transport module only handles framing and connection management. The
handler dispatch is shared.</p><hr class="thin"/><h3 id="stage-6-cli-frontend-native-elixir-termui" class="section-heading"><a href="#stage-6-cli-frontend-native-elixir-termui" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stage 6 — CLI Frontend (Native Elixir / TermUI)</span></h3><blockquote><p>Goal: A production-quality <code class="inline">opal</code> terminal application built into the binary.</p></blockquote><p>The CLI is built in Elixir using <a href="https://github.com/pcharbon70/term_ui">TermUI</a>,
a BubbleTea-inspired Elm Architecture framework for terminal UIs. The TUI runs
in the same BEAM process tree as the agent engine — no child process spawning,
no JSON-RPC serialization for interactive mode.</p><p><strong>Why native Elixir instead of TypeScript/Ink?</strong></p><ul><li><strong>Zero serialization overhead.</strong> The TUI calls <a href="Opal.html#prompt/2"><code class="inline">Opal.prompt/2</code></a> directly —
no JSON encoding, no stdio parsing, no process spawning.</li><li><strong>Single binary.</strong> One <code class="inline">opal</code> executable, no Node.js runtime dependency.</li><li><strong>Event bridge is trivial.</strong> <a href="Opal.Events.html#subscribe/1"><code class="inline">Opal.Events.subscribe/1</code></a> delivers events as
Erlang messages directly to the TermUI runtime process.</li><li><strong>TermUI maturity.</strong> 24+ widgets, 60fps differential rendering, markdown
support via <code class="inline">mdex</code>, full RGB color, Elm Architecture state management.</li></ul><p><strong><code class="inline">mix opal.chat</code></strong> remains as a debugging utility for library developers.</p><h4>Module Structure</h4><pre><code class="makeup elixir" translate="no"><span class="n">core</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">opal</span><span class="o">/</span><span class="n">cli</span><span class="o">/</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">app</span><span class="o">.</span><span class="n">ex</span><span class="w">              </span><span class="c1"># Main TUI application (use TermUI.Elm)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">commands</span><span class="o">.</span><span class="n">ex</span><span class="w">         </span><span class="c1"># Slash command handling (/clear, /help, etc.)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">config</span><span class="o">.</span><span class="n">ex</span><span class="w">           </span><span class="c1"># Persistent CLI config (~/.config/opal/config.json)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">ex</span><span class="w">             </span><span class="c1"># Binary entry point (arg parsing, mode dispatch)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">server</span><span class="o">.</span><span class="n">ex</span><span class="w">           </span><span class="c1"># Headless JSON-RPC server entry point (--daemon)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">theme</span><span class="o">.</span><span class="n">ex</span><span class="w">            </span><span class="c1"># Color theme (pink accents, dark/light)</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">views</span><span class="o">/</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">confirm_dialog</span><span class="o">.</span><span class="n">ex</span><span class="w">  </span><span class="c1"># Tool confirmation overlay</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">header</span><span class="o">.</span><span class="n">ex</span><span class="w">          </span><span class="c1"># Header bar (title, cwd, model name)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">input</span><span class="o">.</span><span class="n">ex</span><span class="w">           </span><span class="c1"># User input prompt (cursor, submit)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">message_list</span><span class="o">.</span><span class="n">ex</span><span class="w">    </span><span class="c1"># Scrollable chat with role badges</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">status_bar</span><span class="o">.</span><span class="n">ex</span><span class="w">      </span><span class="c1"># Bottom bar (tokens, shortcuts)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">task_list</span><span class="o">.</span><span class="n">ex</span><span class="w">       </span><span class="c1"># Tool execution status icons</span><span class="w">
    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">thinking</span><span class="o">.</span><span class="n">ex</span><span class="w">        </span><span class="c1"># Animated kaomoji indicator</span></code></pre><h4>Usage</h4><pre><code class="makeup shell" translate="no"><span class="gp unselectable">$ </span><span class="">opal                           # Interactive TUI (default)
</span><span class="gp unselectable">$ </span><span class="">opal --daemon                  # Headless JSON-RPC on stdio
</span><span class="gp unselectable">$ </span><span class="">opal --version                 # Print version
</span><span class="gp unselectable">$ </span><span class="">opal --help                    # Show help
</span></code></pre><h4>Platform Distribution</h4><p>The <code class="inline">opal</code> binary is built as either:</p><ol><li><strong><a href="https://hexdocs.pm/mix/Mix.Tasks.Escript.Build.html"><code class="inline">mix escript.build</code></a></strong> — portable escript (requires Erlang/OTP on host)</li><li><strong><a href="https://hexdocs.pm/mix/Mix.Tasks.Release.html"><code class="inline">mix release</code></a></strong> — self-contained release (bundles BEAM + deps)</li></ol><table><thead><tr><th style="text-align: left;">Platform</th><th style="text-align: left;">Install method</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>macOS arm64</strong></td><td style="text-align: left;"><code class="inline">brew install opal</code> / GitHub release</td></tr><tr><td style="text-align: left;"><strong>macOS x64</strong></td><td style="text-align: left;"><code class="inline">brew install opal</code> / GitHub release</td></tr><tr><td style="text-align: left;"><strong>Linux x64</strong></td><td style="text-align: left;">GitHub release / curl one-liner</td></tr><tr><td style="text-align: left;"><strong>Linux arm64</strong></td><td style="text-align: left;">GitHub release / curl one-liner</td></tr><tr><td style="text-align: left;"><strong>Windows x64</strong></td><td style="text-align: left;">GitHub release / scoop / winget</td></tr></tbody></table><hr class="thin"/><h2 id="otp-advantages-over-pi-s-architecture" class="section-heading"><a href="#otp-advantages-over-pi-s-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">OTP Advantages Over Pi's Architecture</span></h2><table><thead><tr><th style="text-align: left;">Concern</th><th style="text-align: left;">Pi (TypeScript)</th><th style="text-align: left;">Opal (Elixir/OTP)</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Agent isolation</strong></td><td style="text-align: left;">Single process, careful state management</td><td style="text-align: left;">Each agent is a process — crash one, others survive</td></tr><tr><td style="text-align: left;"><strong>Sub-agents</strong></td><td style="text-align: left;">&quot;Build it yourself&quot; or tmux</td><td style="text-align: left;"><a href="https://hexdocs.pm/elixir/DynamicSupervisor.html#start_child/2"><code class="inline">DynamicSupervisor.start_child/2</code></a></td></tr><tr><td style="text-align: left;"><strong>Concurrency</strong></td><td style="text-align: left;">Sequential tool execution</td><td style="text-align: left;"><code class="inline">Task.async_stream</code> for parallel tools</td></tr><tr><td style="text-align: left;"><strong>Event system</strong></td><td style="text-align: left;">Callback arrays, manual cleanup</td><td style="text-align: left;"><a href="https://hexdocs.pm/elixir/Registry.html"><code class="inline">Registry</code></a> pubsub — subscribe/unsubscribe is process lifecycle</td></tr><tr><td style="text-align: left;"><strong>Steering</strong></td><td style="text-align: left;">Explicit queue arrays + polling</td><td style="text-align: left;">Process mailbox — selective receive</td></tr><tr><td style="text-align: left;"><strong>Inspection</strong></td><td style="text-align: left;">Console logging</td><td style="text-align: left;"><code class="inline">:observer</code>, <code class="inline">:sys.get_state</code>, tracing</td></tr><tr><td style="text-align: left;"><strong>Fault tolerance</strong></td><td style="text-align: left;">try/catch, process exit</td><td style="text-align: left;">Supervision trees, automatic restart strategies</td></tr><tr><td style="text-align: left;"><strong>Embedding</strong></td><td style="text-align: left;">SDK import + async/await</td><td style="text-align: left;">Add to your supervision tree — it's just processes</td></tr><tr><td style="text-align: left;"><strong>Multi-session</strong></td><td style="text-align: left;">Multiple AgentSession instances in one thread</td><td style="text-align: left;">Each session is an isolated process tree</td></tr><tr><td style="text-align: left;"><strong>Hot code reload</strong></td><td style="text-align: left;">Restart the process</td><td style="text-align: left;">Hot code upgrade via releases</td></tr><tr><td style="text-align: left;"><strong>Backpressure</strong></td><td style="text-align: left;">Manual (message queue modes)</td><td style="text-align: left;">Process mailbox + GenServer handle_continue</td></tr><tr><td style="text-align: left;"><strong>Distributed</strong></td><td style="text-align: left;">Not built-in</td><td style="text-align: left;"><code class="inline">Node.connect</code> — agents across machines for free</td></tr><tr><td style="text-align: left;"><strong>Cross-platform</strong></td><td style="text-align: left;">Works but bash tool assumes POSIX</td><td style="text-align: left;">BEAM runs natively on Windows, macOS, Linux — <a href="Opal.Tool.Shell.html"><code class="inline">Opal.Tool.Shell</code></a> dispatches per OS</td></tr><tr><td style="text-align: left;"><strong>MCP integration</strong></td><td style="text-align: left;">Explicitly rejected; &quot;build it with extensions&quot;</td><td style="text-align: left;">Anubis MCP clients under OTP supervision — zero transport/protocol code, fault-tolerant, parallel negotiation</td></tr></tbody></table><hr class="thin"/><h2 id="module-summary" class="section-heading"><a href="#module-summary" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Module Summary</span></h2><table><thead><tr><th style="text-align: left;">Module</th><th style="text-align: left;">Type</th><th style="text-align: left;">Stage</th><th style="text-align: left;">Purpose</th></tr></thead><tbody><tr><td style="text-align: left;"><a href="Opal.html"><code class="inline">Opal</code></a></td><td style="text-align: left;">API</td><td style="text-align: left;">1</td><td style="text-align: left;">Public interface, session lifecycle</td></tr><tr><td style="text-align: left;"><a href="Opal.Agent.html"><code class="inline">Opal.Agent</code></a></td><td style="text-align: left;">GenServer</td><td style="text-align: left;">1</td><td style="text-align: left;">Core agent loop</td></tr><tr><td style="text-align: left;"><a href="Opal.Provider.html"><code class="inline">Opal.Provider</code></a></td><td style="text-align: left;">Behaviour</td><td style="text-align: left;">1</td><td style="text-align: left;">LLM provider abstraction</td></tr><tr><td style="text-align: left;"><a href="Opal.Provider.Copilot.html"><code class="inline">Opal.Provider.Copilot</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">1</td><td style="text-align: left;">GitHub Copilot (OpenAI Responses API)</td></tr><tr><td style="text-align: left;"><a href="Opal.Auth.html"><code class="inline">Opal.Auth</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">1</td><td style="text-align: left;">Copilot OAuth device-code flow + token storage</td></tr><tr><td style="text-align: left;"><a href="Opal.Tool.html"><code class="inline">Opal.Tool</code></a></td><td style="text-align: left;">Behaviour</td><td style="text-align: left;">1</td><td style="text-align: left;">Tool interface</td></tr><tr><td style="text-align: left;"><code class="inline">Opal.Tool.{Read,Write,Edit,Shell}</code></td><td style="text-align: left;">Modules</td><td style="text-align: left;">1</td><td style="text-align: left;">Built-in tools</td></tr><tr><td style="text-align: left;"><a href="Opal.Config.html"><code class="inline">Opal.Config</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">1</td><td style="text-align: left;">Application config + per-session overrides</td></tr><tr><td style="text-align: left;"><a href="Opal.Path.html"><code class="inline">Opal.Path</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">1</td><td style="text-align: left;">Cross-platform path normalization</td></tr><tr><td style="text-align: left;"><a href="Opal.Events.html"><code class="inline">Opal.Events</code></a></td><td style="text-align: left;">Registry</td><td style="text-align: left;">1</td><td style="text-align: left;">Event pubsub</td></tr><tr><td style="text-align: left;"><a href="Opal.Message.html"><code class="inline">Opal.Message</code></a></td><td style="text-align: left;">Struct</td><td style="text-align: left;">1</td><td style="text-align: left;">Message types</td></tr><tr><td style="text-align: left;"><code class="inline">Opal.SessionSupervisor</code></td><td style="text-align: left;">DynamicSupervisor</td><td style="text-align: left;">1</td><td style="text-align: left;">Per-session process tree</td></tr><tr><td style="text-align: left;"><a href="Opal.Session.html"><code class="inline">Opal.Session</code></a></td><td style="text-align: left;">GenServer</td><td style="text-align: left;">2</td><td style="text-align: left;">Message history + persistence</td></tr><tr><td style="text-align: left;"><a href="Opal.Session.Compaction.html"><code class="inline">Opal.Session.Compaction</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">2</td><td style="text-align: left;">Context window management</td></tr><tr><td style="text-align: left;"><a href="Opal.SubAgent.html"><code class="inline">Opal.SubAgent</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">3</td><td style="text-align: left;">Sub-agent spawning</td></tr><tr><td style="text-align: left;"><code class="inline">Opal.SubAgentSup</code></td><td style="text-align: left;">DynamicSupervisor</td><td style="text-align: left;">3</td><td style="text-align: left;">Sub-agent supervision</td></tr><tr><td style="text-align: left;"><a href="Opal.Context.html"><code class="inline">Opal.Context</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">4</td><td style="text-align: left;">Context file discovery</td></tr><tr><td style="text-align: left;"><a href="Opal.Skill.html"><code class="inline">Opal.Skill</code></a></td><td style="text-align: left;">Behaviour</td><td style="text-align: left;">4</td><td style="text-align: left;">Reusable instructions</td></tr><tr><td style="text-align: left;"><a href="Opal.MCP.Supervisor.html"><code class="inline">Opal.MCP.Supervisor</code></a></td><td style="text-align: left;">Supervisor</td><td style="text-align: left;">5</td><td style="text-align: left;">Manages Anubis client processes</td></tr><tr><td style="text-align: left;"><a href="Opal.MCP.Client.html"><code class="inline">Opal.MCP.Client</code></a></td><td style="text-align: left;">Anubis.Client</td><td style="text-align: left;">5</td><td style="text-align: left;">MCP server connection (via Anubis)</td></tr><tr><td style="text-align: left;"><a href="Opal.MCP.Bridge.html"><code class="inline">Opal.MCP.Bridge</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">5</td><td style="text-align: left;">Discovers MCP tools → Opal tool format</td></tr><tr><td style="text-align: left;"><a href="Opal.MCP.Resources.html"><code class="inline">Opal.MCP.Resources</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">5</td><td style="text-align: left;">MCP resource discovery + reading</td></tr><tr><td style="text-align: left;"><a href="Opal.RPC.html"><code class="inline">Opal.RPC</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">5.5</td><td style="text-align: left;">JSON-RPC 2.0 encode/decode (transport-agnostic)</td></tr><tr><td style="text-align: left;"><a href="Opal.RPC.Handler.html"><code class="inline">Opal.RPC.Handler</code></a></td><td style="text-align: left;">Module</td><td style="text-align: left;">5.5</td><td style="text-align: left;">Method dispatch → Opal API</td></tr><tr><td style="text-align: left;"><a href="Opal.RPC.Stdio.html"><code class="inline">Opal.RPC.Stdio</code></a></td><td style="text-align: left;">GenServer</td><td style="text-align: left;">5.5</td><td style="text-align: left;">Stdio transport for headless daemon mode</td></tr><tr><td style="text-align: left;"><code class="inline">Opal.CLI.Server</code></td><td style="text-align: left;">Module</td><td style="text-align: left;">5.5</td><td style="text-align: left;">Headless daemon entry point (<code class="inline">--daemon</code>)</td></tr><tr><td style="text-align: left;"><code class="inline">Opal.CLI.Main</code></td><td style="text-align: left;">Module</td><td style="text-align: left;">6</td><td style="text-align: left;">Binary entry point (mode dispatch)</td></tr><tr><td style="text-align: left;"><code class="inline">Opal.CLI.App</code></td><td style="text-align: left;">TermUI.Elm</td><td style="text-align: left;">6</td><td style="text-align: left;">Main TUI application (Elm Architecture)</td></tr><tr><td style="text-align: left;"><code class="inline">Opal.CLI.Theme</code></td><td style="text-align: left;">Module</td><td style="text-align: left;">6</td><td style="text-align: left;">Color themes (dark/light, pink accents)</td></tr><tr><td style="text-align: left;"><code class="inline">Opal.CLI.Config</code></td><td style="text-align: left;">Module</td><td style="text-align: left;">6</td><td style="text-align: left;">Persistent CLI config (~/.config/opal)</td></tr><tr><td style="text-align: left;"><code class="inline">Opal.CLI.Commands</code></td><td style="text-align: left;">Module</td><td style="text-align: left;">6</td><td style="text-align: left;">Slash command handling</td></tr><tr><td style="text-align: left;"><code class="inline">Opal.CLI.Views.*</code></td><td style="text-align: left;">Modules</td><td style="text-align: left;">6</td><td style="text-align: left;">View components (Header, Input, MessageList, etc.)</td></tr><tr><td style="text-align: left;"><code class="inline">opal.chat</code></td><td style="text-align: left;">Mix task</td><td style="text-align: left;">6</td><td style="text-align: left;">Elixir debugging TUI (direct library usage)</td></tr></tbody></table><hr class="thin"/><h2 id="usage-sdk-in-your-app" class="section-heading"><a href="#usage-sdk-in-your-app" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Usage: SDK in Your App</span></h2><pre><code class="makeup elixir" translate="no"><span class="c1"># In your application.ex</span><span class="w">
</span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="4303988233-1">[</span><span class="w">
  </span><span class="nc">Opal.Supervisor</span><span class="w">  </span><span class="c1"># starts the registry, session supervisor, etc.</span><span class="w">
</span><span class="p" data-group-id="4303988233-1">]</span><span class="w">

</span><span class="c1"># Anywhere in your app — tools, shell, data_dir come from config :opal</span><span class="w">
</span><span class="p" data-group-id="4303988233-2">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p" data-group-id="4303988233-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">start_session</span><span class="p" data-group-id="4303988233-3">(</span><span class="p" data-group-id="4303988233-4">%{</span><span class="w">
  </span><span class="ss">system_prompt</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;You are a helpful assistant.&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">working_dir</span><span class="p">:</span><span class="w"> </span><span class="nc">File</span><span class="o">.</span><span class="n">cwd!</span><span class="p" data-group-id="4303988233-5">(</span><span class="p" data-group-id="4303988233-5">)</span><span class="w">
</span><span class="p" data-group-id="4303988233-4">}</span><span class="p" data-group-id="4303988233-3">)</span><span class="w">

</span><span class="c1"># Subscribe from a LiveView, GenServer, or any process</span><span class="w">
</span><span class="nc">Opal.Events</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="4303988233-6">(</span><span class="n">session</span><span class="p" data-group-id="4303988233-6">)</span><span class="w">

</span><span class="c1"># Non-blocking</span><span class="w">
</span><span class="nc">Opal</span><span class="o">.</span><span class="n">prompt</span><span class="p" data-group-id="4303988233-7">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Refactor the user module&quot;</span><span class="p" data-group-id="4303988233-7">)</span><span class="w">

</span><span class="c1"># Events arrive in your process mailbox</span><span class="w">
</span><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="4303988233-8">do</span><span class="w">
  </span><span class="p" data-group-id="4303988233-9">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4303988233-10">{</span><span class="ss">:message_update</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4303988233-11">%{</span><span class="ss">delta</span><span class="p">:</span><span class="w"> </span><span class="n">text</span><span class="p" data-group-id="4303988233-11">}</span><span class="p" data-group-id="4303988233-10">}</span><span class="p" data-group-id="4303988233-9">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">write</span><span class="p" data-group-id="4303988233-12">(</span><span class="n">text</span><span class="p" data-group-id="4303988233-12">)</span><span class="w">
  </span><span class="p" data-group-id="4303988233-13">{</span><span class="ss">:opal_event</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4303988233-14">{</span><span class="ss">:agent_end</span><span class="p">,</span><span class="w"> </span><span class="c">_messages</span><span class="p" data-group-id="4303988233-14">}</span><span class="p" data-group-id="4303988233-13">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="4303988233-15">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">--- Done ---&quot;</span><span class="p" data-group-id="4303988233-15">)</span><span class="w">
</span><span class="k" data-group-id="4303988233-8">end</span></code></pre><h2 id="usage-headless-script" class="section-heading"><a href="#usage-headless-script" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Usage: Headless / Script</span></h2><pre><code class="makeup elixir" translate="no"><span class="c1"># In a Mix task or escript</span><span class="w">
</span><span class="nc">Opal.Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="5690665849-1">(</span><span class="p" data-group-id="5690665849-2">[</span><span class="p" data-group-id="5690665849-2">]</span><span class="p" data-group-id="5690665849-1">)</span><span class="w">

</span><span class="p" data-group-id="5690665849-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p" data-group-id="5690665849-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Opal</span><span class="o">.</span><span class="n">prompt_sync</span><span class="p" data-group-id="5690665849-4">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;What&#39;s in this repo?&quot;</span><span class="p" data-group-id="5690665849-4">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="5690665849-5">(</span><span class="n">response</span><span class="p" data-group-id="5690665849-5">)</span></code></pre><hr class="thin"/><h2 id="cross-platform-design-principles" class="section-heading"><a href="#cross-platform-design-principles" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Cross-Platform Design Principles</span></h2><ol><li><strong>No POSIX assumptions.</strong> Never shell out with hardcoded <code class="inline">sh -c</code>. Use
<a href="Opal.Tool.Shell.html"><code class="inline">Opal.Tool.Shell</code></a> which dispatches to the right shell per OS.</li><li><strong>Use <a href="https://hexdocs.pm/elixir/Path.html"><code class="inline">Path</code></a> everywhere.</strong> Never concatenate paths with <code class="inline">&quot;/&quot;</code>. Use
<a href="https://hexdocs.pm/elixir/Path.html#join/2"><code class="inline">Path.join/2</code></a>, <a href="https://hexdocs.pm/elixir/Path.html#expand/1"><code class="inline">Path.expand/1</code></a>, <a href="https://hexdocs.pm/elixir/Path.html#relative_to/2"><code class="inline">Path.relative_to/2</code></a>.</li><li><strong>Normalize paths at boundaries.</strong> Input from users, LLMs, and tool results
goes through <a href="Opal.Path.html#normalize/1"><code class="inline">Opal.Path.normalize/1</code></a> before storage or comparison.</li><li><strong>Data directory.</strong> All persistent state lives under <code class="inline">~/.opal/</code> by default
— one predictable location on every platform (like <code class="inline">~/.ssh</code>, <code class="inline">~/.docker</code>).
Override via <code class="inline">config :opal, data_dir: ...</code> in your app, per-session
with <code class="inline">data_dir:</code>, or <code class="inline">OPAL_DATA_DIR</code> env var. See <a href="Opal.Config.html"><code class="inline">Opal.Config</code></a> for the
full precedence chain.</li><li><strong>Session storage.</strong> Saved under <code class="inline">Opal.Config.sessions_dir/0</code> which defaults
to <code class="inline">~/.opal/sessions/</code>. Embedded apps can redirect to their own data dir.</li><li><strong>Environment variables.</strong> <a href="https://hexdocs.pm/elixir/System.html#get_env/1"><code class="inline">System.get_env/1</code></a> is cross-platform. API keys
and config via env vars work everywhere.</li><li><strong>Line endings.</strong> File reads/writes preserve platform line endings. Diffs
and edits normalize to <code class="inline">\n</code> internally.</li><li><strong>Test on CI.</strong> GitHub Actions matrix: <code class="inline">ubuntu-latest</code>, <code class="inline">macos-latest</code>,
<code class="inline">windows-latest</code>. No platform is a second-class citizen.</li></ol><hr class="thin"/><h2 id="what-s-not-here-yet" class="section-heading"><a href="#what-s-not-here-yet" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What's Not Here (Yet)</span></h2><ul><li><strong>Multiple providers</strong> — Ship GitHub Copilot first. Direct OpenAI, Anthropic,
Google, etc. follow the same <a href="Opal.Provider.html"><code class="inline">Opal.Provider</code></a> behaviour. The Copilot provider
already speaks the OpenAI Responses API, so direct OpenAI support is a
near-trivial second provider.</li><li><strong>Web UI</strong> — Could be a Phoenix LiveView app that subscribes to events.
That's a separate project.</li><li><strong>Distributed agents</strong> — The architecture supports it (processes + message
passing), but we don't build for it in early stages.</li><li><strong>Image/multimodal support</strong> — Messages can carry image content, but tooling
for it comes later.</li></ul><hr class="thin"/><h2 id="naming" class="section-heading"><a href="#naming" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Naming</span></h2><p><strong>Opal</strong> — it's a gemstone, short, easy to type, and the <code class="inline">O</code> is for OTP.
Open to alternatives.</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="readme.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Overview
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="agent-loop.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Agent Loop
        </span>
      </a>

  </div>
</div>
    <footer class="footer">

        <p>

            <span class="line">
              <a href="https://hex.pm/packages/opal/0.1.0">Hex Package</a>

              <a href="https://preview.hex.pm/preview/opal/0.1.0">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/opal/0.1.0/show/../ARCHITECTURE.md">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Go to package docs">
              Go to package docs
            </button>

              <a href="llms.txt" target="_blank">
                View llms.txt
              </a>


              <a href="Opal.epub">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.40.1) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>


    </footer>
  </div>
</main>
</div>

  </body>
</html>
